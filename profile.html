<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† | BRAIN BRIDGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .accordion-arrow { transition: transform 0.3s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }
        .tag-checkbox:checked + div { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 font-sans pb-24">

    <!-- Header -->
    <header class="bg-white shadow sticky top-0 z-20">
        <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900 flex items-center">
                ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† 
                <span id="admin-label" class="hidden text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded ml-2 border border-purple-200">
                    <i class="fa-solid fa-crown mr-1"></i>ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                </span>
            </h1>
            <div class="flex space-x-3">
                <button onclick="history.back()" class="text-gray-600 hover:text-gray-900 text-sm font-medium py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button onclick="saveProfile()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-bold shadow-sm transition-colors">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto mt-6 px-4">
        <form id="profile-form" class="space-y-8" onsubmit="event.preventDefault();">
            
            <!-- 0. å…¬é–‹è¨­å®šãƒ»è·æ¥­ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">åŸºæœ¬è¨­å®š</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å…¬é–‹çŠ¶æ…‹</label>
                        <select name="profilePublic" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                            <option value="true">å…¬é–‹ã™ã‚‹</option>
                            <option value="false">éå…¬é–‹ï¼ˆä¸‹æ›¸ãï¼‰</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">â€»WALKERä¼šå“¡ã¯è¨­å®šã«é–¢ã‚ã‚‰ãšæ¤œç´¢çµæœã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">è·æ¥­ãƒ»è‚©æ›¸</label>
                        <input type="text" name="jobTitle" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                </div>
            </div>

            <!-- 1. åŸºæœ¬æƒ…å ± -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘  åŸºæœ¬æƒ…å ±</h2>
                
                <div class="mb-6 flex flex-col items-center sm:flex-row sm:items-start space-y-4 sm:space-y-0 sm:space-x-6">
                    <div class="relative h-24 w-24 rounded-full border-2 border-gray-200 bg-gray-100 flex items-center justify-center overflow-hidden">
                        <img id="edit-icon-preview" src="" class="hidden w-full h-full object-cover">
                        <i id="edit-icon-placeholder" class="fa-solid fa-user text-3xl text-gray-300"></i>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¢ã‚¤ã‚³ãƒ³</label>
                        <input type="file" id="icon-upload" accept="image/*" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <p class="mt-1 text-xs text-gray-500">æ¨å¥¨: æ­£æ–¹å½¢ã®ç”»åƒ (JPG, PNG)</p>
                        <p id="upload-status" class="text-xs text-red-500 hidden mt-1"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-6">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ°åï¼ˆè¡¨ç¤ºç”¨ï¼‰ <span class="text-red-500">*</span></label>
                            <input type="text" name="name" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ãµã‚ŠãŒãª</label>
                            <input type="text" name="nameKana" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ€§åˆ¥</label>
                            <select name="gender" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                                <option value="">æœªé¸æŠ</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                                <option value="å›ç­”ã—ãªã„">å›ç­”ã—ãªã„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ç”Ÿå¹´æœˆæ—¥</label>
                            <input type="date" name="birthDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">å…¬é–‹ç¯„å›²</label>
                            <select name="birthVisibility" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                                <option value="private">éå…¬é–‹</option>
                                <option value="monthDay">æœˆæ—¥ã®ã¿å…¬é–‹</option>
                                <option value="full">å…¨ã¦å…¬é–‹</option>
                            </select>
                        </div>
                    </div>
                    <!-- Bio -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è‡ªå·±ç´¹ä»‹ï¼ˆå…¬é–‹ãƒ»369æ–‡å­—ä»¥å†…ï¼‰</label>
                        <textarea name="bio" rows="3" maxlength="369" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border" placeholder="ã¯ã˜ã‚ã¾ã—ã¦ï¼ã€‡ã€‡ã‚’ã—ã¦ã„ã¾ã™ã€‚"></textarea>
                    </div>
                </div>
            </div>

            <!-- 2. é€£çµ¡ãƒ»å¤–éƒ¨ãƒªãƒ³ã‚¯ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¡ é€£çµ¡å…ˆãƒ»SNS</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆé€£çµ¡ç”¨ï¼‰</label>
                        <input type="email" name="contactEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">WEBã‚µã‚¤ãƒˆ (URL)</label>
                            <input type="url" name="websiteUrl" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Instagram (ID/URL)</label>
                            <input type="text" name="snsInstagram" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">X (æ—§Twitter) (ID/URL)</label>
                            <input type="text" name="snsX" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. ã‚¨ãƒªã‚¢ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¢ ã‚¨ãƒªã‚¢</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">éƒ½é“åºœçœŒ</label>
                        <select name="prefecture" id="prefecture-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å¸‚åŒºç”ºæ‘</label>
                        <input type="text" name="city" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                    </div>
                </div>
            </div>

            <!-- 4. è¶£å‘³ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘£ è¶£å‘³</h2>
                <div id="hobbies-container" class="space-y-2"></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">ãã®ä»–</label>
                    <input type="text" name="hobbyOtherText" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border">
                </div>
            </div>

            <!-- 5. ç‰¹æŠ€ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¤ ç‰¹æŠ€ãƒ»ã‚¹ã‚­ãƒ«</h2>
                <div id="skills-container" class="space-y-2"></div>
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700">è£œè¶³èª¬æ˜</label>
                    <textarea name="skillDescription" rows="3" maxlength="300" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                </div>
            </div>

            <!-- 6. çµŒæ­´ -->
            <div class="bg-white shadow rounded-lg p-6">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold text-gray-900">â‘¥ çµŒæ­´</h2>
                    <button type="button" onclick="addCareerField()" class="text-sm text-blue-600 hover:underline">+ è¿½åŠ ã™ã‚‹</button>
                </div>
                <div id="career-list" class="space-y-6"></div>
            </div>

            <!-- 7 & 8. æƒ³ã„ãƒ»ç›®æ¨™ -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¦ æƒ³ã„ãƒ»â‘§ ã‚„ã‚ŠãŸã„ã“ã¨</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æƒ³ã„ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ <span class="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded ml-2">ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼é™å®š</span></label>
                        <textarea name="message" rows="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ä»Šå¾Œã‚„ã‚ŠãŸã„ã“ã¨ãƒ»ç›®æ¨™</label>
                        <textarea name="goals" rows="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                </div>
            </div>

            <!-- 9. ãƒãƒƒãƒãƒ³ã‚° -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-lg font-bold text-gray-900 mb-4 pb-2 border-b">â‘¨ ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æä¾›ã§ãã‚‹ã“ã¨</label>
                        <p class="text-xs text-gray-500 mb-2">ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Š</p>
                        <textarea name="canOffer" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">æ±‚ã‚ã¦ã„ã‚‹ã“ã¨</label>
                        <p class="text-xs text-gray-500 mb-2">ã‚«ãƒ³ãƒ(,)åŒºåˆ‡ã‚Š</p>
                        <textarea name="lookingFor" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm p-2 border"></textarea>
                    </div>
                </div>
            </div>

        </form>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden max-w-sm w-full bg-white shadow-lg rounded-lg p-4 border-l-4">
        <p id="notif-message" class="text-sm font-medium"></p>
    </div>

    <script type="module">
        // â˜…ä¿®æ­£ç‚¹: æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ 10.13.1 ã‚’ä½¿ç”¨
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let currentUserData = {};
        let targetUid = null;
        let isAdmin = false;

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';

        // Master Data
        const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–","ãã®ä»–"];
        const hobbyCategories = {
            "ğŸƒ ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•ç³»": ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "ç­‹ãƒˆãƒ¬", "ãƒ¨ã‚¬", "ãƒ”ãƒ©ãƒ†ã‚£ã‚¹", "ãƒ€ãƒ³ã‚¹", "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ•ãƒƒãƒˆã‚µãƒ«", "é‡çƒ", "ãƒ†ãƒ‹ã‚¹", "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", "å“çƒ", "ã‚´ãƒ«ãƒ•", "ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°", "ç™»å±±", "ã‚µãƒ¼ãƒ•ã‚£ãƒ³", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰", "ã‚¹ã‚­ãƒ¼", "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°", "æ°´æ³³", "æ ¼é—˜æŠ€", "æ­¦é“"],
            "ğŸµ éŸ³æ¥½ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡": ["ã‚«ãƒ©ã‚ªã‚±", "æ¥½å™¨æ¼”å¥ï¼ˆã‚®ã‚¿ãƒ¼ï¼‰", "æ¥½å™¨æ¼”å¥ï¼ˆãƒ”ã‚¢ãƒï¼‰", "ä½œæ›²", "æ­Œ", "ãƒ©ã‚¤ãƒ–é‘‘è³", "ãƒ•ã‚§ã‚¹", "DJ", "æ˜ ç”»é‘‘è³", "ã‚¢ãƒ‹ãƒ¡é‘‘è³", "æ¼«ç”»", "ã‚²ãƒ¼ãƒ ", "ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ "],
            "ğŸ¨ æ–‡åŒ–ãƒ»ã‚¢ãƒ¼ãƒˆ": ["çµµç”»", "ã‚¤ãƒ©ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³", "å†™çœŸæ’®å½±", "å‹•ç”»ç·¨é›†", "æ‰‹èŠ¸", "DIY", "å°èª¬åŸ·ç­†", "ãƒ–ãƒ­ã‚°"],
            "ğŸ“š å­¦ã³": ["èª­æ›¸", "è‡ªå·±å•“ç™º", "æ­´å²", "å¿ƒç†å­¦", "æŠ•è³‡", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è‹±èªå­¦ç¿’", "è³‡æ ¼å–å¾—"],
            "ğŸ³ é£Ÿãƒ»æš®ã‚‰ã—": ["æ–™ç†", "ãŠè“å­ä½œã‚Š", "ã‚«ãƒ•ã‚§å·¡ã‚Š", "é£Ÿã¹æ­©ã", "ãŠé…’", "ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚¤ãƒ³ãƒ†ãƒªã‚¢", "ãƒŸãƒ‹ãƒãƒªã‚ºãƒ "],
            "âœˆï¸ æ—…è¡Œ": ["å›½å†…æ—…è¡Œ", "æµ·å¤–æ—…è¡Œ", "ä¸€äººæ—…", "ã‚­ãƒ£ãƒ³ãƒ—", "æ¸©æ³‰å·¡ã‚Š", "ç¥ç¤¾ä»é–£å·¡ã‚Š"],
            "ğŸ¤ äºº": ["äº¤æµä¼š", "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢", "åœ°åŸŸæ´»å‹•", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å­è‚²ã¦"],
            "ğŸŒ¿ ãã®ä»–": ["ç‘æƒ³", "å ã„", "ãã®ä»–"]
        };
        const skillCategories = {
            "ğŸ’» IT": ["Webåˆ¶ä½œ", "WordPress", "Firebase", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰", "ã‚¢ãƒ—ãƒªé–‹ç™º", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ãƒ‡ãƒ¼ã‚¿åˆ†æ", "AIæ´»ç”¨"],
            "ğŸ¤ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³": ["ãƒ—ãƒ¬ã‚¼ãƒ³", "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "è¬›å¸«", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å–¶æ¥­", "äº¤æ¸‰", "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼"],
            "âœï¸ ç™ºä¿¡": ["ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°", "SNSé‹ç”¨", "ãƒ–ãƒ­ã‚°é‹å–¶", "å‹•ç”»ç·¨é›†", "ãƒ‡ã‚¶ã‚¤ãƒ³"],
            "ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹": ["èµ·æ¥­", "çµŒå–¶", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ä¼šè¨ˆ", "äººäº‹", "è‹±èª"],
            "ğŸ§˜ ãã®ä»–": ["æ–™ç†æŒ‡å°", "æ•´ç†åç´", "å¥åº·ç®¡ç†"]
        };

        document.addEventListener('DOMContentLoaded', () => {
            initUI();
        });

        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid' };
                isAdmin = true;
                targetUid = 'test_admin_uid';
                populateForm({userId:'admin', name:'ç®¡ç†è€…'});
                return;
            }

            if (user) {
                currentUser = user;
                
                // 1. ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
                try {
                    const myProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                    const myProfileSnap = await getDoc(myProfileRef);
                    if (myProfileSnap.exists() && myProfileSnap.data().userId === 'admin') {
                        isAdmin = true;
                        document.getElementById('admin-label').classList.remove('hidden');
                    }
                    if (user.uid === "Zm7FWRopJKVfyzbp8KXXokMFjNC3") { 
                        isAdmin = true;
                        document.getElementById('admin-label').classList.remove('hidden');
                    }
                } catch(e) { console.error("Admin Check Error", e); }

                // 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ±ºå®š
                const urlParams = new URLSearchParams(window.location.search);
                const paramUid = urlParams.get('uid');
                
                if (paramUid && paramUid !== user.uid) {
                    if (isAdmin) {
                        targetUid = paramUid;
                        showNotification('ç®¡ç†è€…æ¨©é™ã§ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç·¨é›†ã—ã¾ã™', 'info');
                    } else {
                        alert("æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“");
                        window.location.href = "user.html";
                        return;
                    }
                } else {
                    targetUid = user.uid;
                }

                await loadUserProfile(targetUid);
            } else {
                window.location.href = 'login.html';
            }
        });

        function initUI() {
            const select = document.getElementById('prefecture-select');
            prefectures.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p; opt.textContent = p;
                select.appendChild(opt);
            });
            renderCategorySection('hobbies-container', hobbyCategories, 'hobbies');
            renderCategorySection('skills-container', skillCategories, 'skills');
        }

        function renderCategorySection(containerId, categoriesData, inputName) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            for (const [category, items] of Object.entries(categoriesData)) {
                const details = document.createElement('details');
                details.className = 'group border border-gray-200 rounded-lg bg-white overflow-hidden';
                details.innerHTML = `<summary class="p-3 cursor-pointer hover:bg-gray-50 font-bold text-sm text-gray-700 flex justify-between">${category} <span class="accordion-arrow">â–¼</span></summary><div class="p-3 flex flex-wrap gap-2"></div>`;
                const div = details.querySelector('div');
                items.forEach(item => {
                    div.innerHTML += `<label class="cursor-pointer"><input type="checkbox" name="${inputName}" value="${item}" class="tag-checkbox hidden"><div class="px-3 py-1 rounded-full border border-gray-300 text-xs hover:bg-gray-100">${item}</div></label>`;
                });
                container.appendChild(details);
            }
        }

        async function loadUserProfile(uid) {
            try {
                // æ­£ã—ã„ãƒ‘ã‚¹: /profile/data
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                } else {
                    // æ–°è¦ã®å ´åˆã‚„ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
                    currentUserData = { userId: uid };
                }
                populateForm(currentUserData);
            } catch (e) {
                console.error(e);
                showNotification("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, 'error');
            }
        }

        function populateForm(data) {
            const form = document.getElementById('profile-form');
            if(!data) return;
            
            Array.from(form.elements).forEach(el => {
                if(el.name && data[el.name] !== undefined) {
                    if(el.type === 'checkbox' || el.type === 'radio' || el.type === 'file') return;
                    el.value = data[el.name];
                }
            });
            
            const hobbies = data.hobbies || [];
            const skills = data.skills || [];
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                if(hobbies.includes(cb.value) || skills.includes(cb.value)) {
                    cb.checked = true;
                    cb.closest('details').open = true;
                }
            });

            if(data.photoURL) {
                document.getElementById('edit-icon-preview').src = data.photoURL;
                document.getElementById('edit-icon-preview').classList.remove('hidden');
                document.getElementById('edit-icon-placeholder').classList.add('hidden');
            }

            document.getElementById('career-list').innerHTML = '';
            if(data.career) data.career.forEach(c => addCareerField(c));
        }

        window.addCareerField = (data = {}) => {
            const container = document.getElementById('career-list');
            const div = document.createElement('div');
            div.className = 'bg-gray-50 p-4 rounded border border-gray-200 relative career-item';
            div.innerHTML = `
                <button type="button" onclick="this.parentElement.remove()" class="absolute top-2 right-2 text-gray-400 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                    <input type="text" class="career-company w-full border-gray-300 rounded p-2 text-sm" placeholder="ä¼šç¤¾å" value="${data.company||''}">
                    <input type="text" class="career-role w-full border-gray-300 rounded p-2 text-sm" placeholder="å½¹è·" value="${data.role||''}">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <input type="month" class="career-start w-full border-gray-300 rounded p-2 text-sm" value="${data.start||''}">
                    <input type="month" class="career-end w-full border-gray-300 rounded p-2 text-sm" value="${data.end||''}">
                </div>
                <textarea class="career-desc w-full border-gray-300 rounded p-2 text-sm" rows="2" placeholder="è©³ç´°">${data.description||''}</textarea>
            `;
            container.appendChild(div);
        };

        document.getElementById('icon-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const img = document.getElementById('edit-icon-preview');
                    img.src = ev.target.result;
                    img.classList.remove('hidden');
                    document.getElementById('edit-icon-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        window.saveProfile = async () => {
            if (!currentUser) return;
            showNotification('ä¿å­˜ä¸­...', 'info');

            const form = document.getElementById('profile-form');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            data.hobbies = Array.from(form.querySelectorAll('input[name="hobbies"]:checked')).map(cb => cb.value);
            data.skills = Array.from(form.querySelectorAll('input[name="skills"]:checked')).map(cb => cb.value);
            
            data.career = [];
            document.querySelectorAll('.career-item').forEach(item => {
                data.career.push({
                    company: item.querySelector('.career-company').value,
                    role: item.querySelector('.career-role').value,
                    start: item.querySelector('.career-start').value,
                    end: item.querySelector('.career-end').value,
                    description: item.querySelector('.career-desc').value
                });
            });
            
            if(data.canOffer) data.canOffer = data.canOffer.split(',').map(s=>s.trim());
            if(data.lookingFor) data.lookingFor = data.lookingFor.split(',').map(s=>s.trim());

            const iconFile = document.getElementById('icon-upload').files[0];
            let photoURL = currentUserData.photoURL || null;
            if (iconFile && !isAdminMock) {
                try {
                    const snap = await uploadBytes(ref(storage, `users/${targetUid}/profile_icon.jpg`), iconFile);
                    photoURL = await getDownloadURL(snap.ref);
                } catch(e) { console.error("Img upload err", e); }
            }
            data.photoURL = photoURL;
            
            data.profileScore = 80; 
            data.updatedAt = new Date().toISOString();

            // --- ãƒ‡ãƒ¼ã‚¿ã®å¼•ãç¶™ã ---
            const finalData = { ...currentUserData, ...data };
            
            // â˜…é‡è¦: userId ãŒ undefined ã«ãªã‚‹ã®ã‚’é˜²ã
            if (!finalData.userId) {
                finalData.userId = targetUid;
            }

            // ãƒ©ãƒ³ã‚¯ã¯ãƒ•ã‚©ãƒ¼ãƒ ã«ãªã„ã®ã§æ—¢å­˜ã‚’ç¶­æŒ (ãªã‘ã‚Œã°walker)
            finalData.membershipRank = currentUserData.membershipRank || 'walker';
            
            // å…¬é–‹è¨­å®š (æ–‡å­—åˆ— "true" / "false")
            finalData.profilePublic = data.profilePublic;

            if (currentUser.uid === 'test_admin_uid') {
                showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ(ãƒ†ã‚¹ãƒˆ)', 'success');
                setTimeout(() => window.location.href = 'user.html', 1000);
                return;
            }

            try {
                // 1. Private Data (ãƒã‚¹ã‚¿ãƒ¼)
                const privateDocRef = doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'data');
                await setDoc(privateDocRef, finalData);
                console.log("Master data saved.");

                // 2. Public Data (æ¤œç´¢ç”¨)
                const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetUid);
                
                const isPaidMember = (finalData.membershipRank === 'builder' || finalData.membershipRank === 'guardian');
                const isPublicSetting = (finalData.profilePublic === 'true');
                // ç®¡ç†è€…ãŒç·¨é›†ã—ãŸå ´åˆã¯å¼·åˆ¶çš„ã«å…¬é–‹å¯èƒ½
                const canPublish = isPaidMember || isAdmin;

                if (isPublicSetting && canPublish) {
                    const publicData = {
                        ...finalData,
                        updatedAt: new Date().toISOString(),
                        isHidden: false // æ˜ç¤ºçš„ã«è¡¨ç¤º
                    };
                    await setDoc(publicDocRef, publicData);
                    console.log("Public data updated.");
                } else {
                    // éå…¬é–‹æ¡ä»¶ (WALKER ã¾ãŸã¯ è¨­å®šOFF)
                    // IDãƒ­ã‚°ã‚¤ãƒ³ç¶­æŒã®ãŸã‚ã€æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã€isHidden=trueã«ã™ã‚‹
                    // â˜…ä¿®æ­£: undefinedå›é¿ã®ãŸã‚ email ãŒãªã‘ã‚Œã° null ã‚’ã‚»ãƒƒãƒˆ
                    const minimalData = {
                        userId: finalData.userId,
                        email: finalData.email || null, 
                        isHidden: true 
                    };
                    await setDoc(publicDocRef, minimalData);
                    console.log("Public data masked (Hidden).");
                }

                if (isPublicSetting && !canPublish) {
                    alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚\nâ€»ç¾åœ¨WALKERä¼šå“¡ã®ãŸã‚ã€è¨­å®šã‚’ã€Œå…¬é–‹ã€ã«ã—ã¦ã‚‚æ¤œç´¢çµæœã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚');
                } else {
                    showNotification('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                }

                setTimeout(() => window.location.href = `user.html?uid=${targetUid}`, 1000);

            } catch (e) {
                console.error("Save error details:", e);
                let errorMsg = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (e.code === 'permission-denied') errorMsg += ': æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                else if (e.message.includes('undefined')) errorMsg += ': å¿…é ˆãƒ‡ãƒ¼ã‚¿(UserIDãªã©)ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚';
                else errorMsg += `: ${e.message}`;
                showNotification(errorMsg, 'error');
            }
        };

        window.showNotification = (msg, type) => {
            const notif = document.getElementById('notification');
            const msgEl = document.getElementById('notif-message');
            notif.classList.remove('hidden', 'border-blue-500', 'border-red-500', 'border-green-500');
            if(type === 'error') notif.classList.add('border-red-500', 'text-red-700');
            else if (type === 'success') notif.classList.add('border-green-500', 'text-green-700');
            else notif.classList.add('border-blue-500', 'text-blue-700');
            msgEl.textContent = msg;
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        };
    </script>
</body>
</html>
