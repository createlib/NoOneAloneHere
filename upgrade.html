<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>契約変更・料金プラン | NOAH</title>
  <link rel="icon" href="img/icon.png">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&display=swap');
    
    body {
      font-family: 'Noto Serif JP', serif;
      background-color: #f7f5f0;
      color: #4a3b32;
    }
    
    .bg-texture {
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
    }
  </style>
</head>
<body class="min-h-screen py-12 px-4 sm:px-6 lg:px-8 bg-texture">

  <!-- ホームに戻るリンク -->
  <div class="absolute top-4 left-4 sm:top-8 sm:left-8 z-10">
    <a href="home.html" class="inline-flex items-center text-xs font-bold text-[#8b6a4f] hover:text-[#5c4a3d] transition-colors tracking-widest">
      <i data-lucide="arrow-left" class="mr-2 w-4 h-4"></i>
      ホームに戻る
    </a>
  </div>

  <div class="max-w-6xl mx-auto pt-10">
    <!-- Header -->
    <div class="text-center mb-16">
      <i data-lucide="shield-half" class="w-10 h-10 text-[#8b6a4f] mx-auto mb-4" stroke-width="1.5"></i>
      <h1 class="text-3xl font-bold text-[#3e2723] sm:text-4xl font-serif tracking-widest">Upgrade Role</h1>
      <p class="mt-4 text-sm text-[#725b3f] tracking-widest uppercase">契約の確認・変更</p>
      <div class="w-16 h-[1px] bg-[#8b6a4f] mt-6 mx-auto"></div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="text-center py-10">
        <i data-lucide="loader-2" class="w-8 h-8 text-[#8b6a4f] animate-spin mx-auto mb-4"></i>
        <p class="text-xs text-[#5c4a3d] tracking-widest font-bold">現在の契約状況を確認しています...</p>
    </div>

    <!-- Pricing Grid -->
    <div id="pricing-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-16 hidden">
      
      <!-- ARRIVAL -->
      <div class="bg-[#fffdf9] p-8 border border-[#c8b9a6] shadow-sm flex flex-col relative">
        <div class="absolute top-0 right-0 bg-[#8b6a4f] text-white text-xs px-3 py-1 font-bold tracking-widest">無料</div>
        <div class="mb-6">
          <h3 class="text-2xl font-bold text-[#3e2723] mb-1">ARRIVAL</h3>
          <p class="text-sm text-[#8b6a4f] font-bold tracking-widest">たどり着いた人</p>
        </div>
        <div class="text-3xl font-serif text-[#3e2723] mb-8">¥0 <span class="text-sm text-[#725b3f] font-sans">/ 月</span></div>
        <div class="flex-grow mb-8">
          <ul class="space-y-3 text-sm text-[#5c4a3d]">
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>イベント参加機能</li>
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>プロフィールの作成</li>
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>メンバー検索（一部制限あり）</li>
          </ul>
        </div>
        <button id="btn-arrival" class="w-full py-3.5 bg-[#f7f5f0] text-[#a09080] font-bold text-sm tracking-widest border border-[#dcd4c6] cursor-not-allowed" disabled>
          現在のプラン
        </button>
      </div>

      <!-- SETTLER -->
      <div class="bg-[#fffdf9] p-8 border-2 border-[#8b6a4f] shadow-lg flex flex-col relative transform md:-translate-y-2">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#8b6a4f] text-[#fffdf9] px-4 py-1 text-xs font-bold tracking-widest rounded-sm shadow-sm">
          STANDARD
        </div>
        <div class="mb-6 mt-2">
          <h3 class="text-2xl font-bold text-[#3e2723] mb-1">SETTLER</h3>
          <p class="text-sm text-[#8b6a4f] font-bold tracking-widest">暮らす人</p>
        </div>
        <div class="text-4xl font-serif text-[#3e2723] mb-8">¥3,300 <span class="text-sm text-[#725b3f] font-sans">/ 月</span></div>
        <div class="flex-grow mb-8">
          <ul class="space-y-3 text-sm text-[#5c4a3d]">
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>ARRIVALの全機能</li>
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>イベントの企画・開催</li>
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>メンバー検索機能の完全解放</li>
            <li class="flex items-start"><i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 text-[#8b6a4f]"></i>コミュニティ内での発言権</li>
          </ul>
        </div>
        <a id="btn-settler" href="https://buy.stripe.com/eVq4gz28G87Bb0ldXY7bW08" target="_blank" rel="noopener noreferrer" class="block text-center w-full py-4 bg-[#8b6a4f] text-[#fffdf9] font-bold text-sm tracking-widest hover:bg-[#725b3f] transition-colors shadow-md">
          居場所を作る (加入する)
        </a>
      </div>

      <!-- COVENANT -->
      <div class="bg-gradient-to-br from-[#2a1a17] to-[#3e2723] p-1 shadow-xl relative md:col-span-2 lg:col-span-1">
        <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-[#d4af37] text-[#2a1a17] px-4 py-1 font-bold text-xs tracking-widest flex items-center gap-1 border border-[#8b6a4f] shadow-sm">
          <i data-lucide="shield" class="w-3 h-3"></i> 特別枠
        </div>
        <div class="bg-[#fffdf9] p-8 border border-[#d4af37] h-full flex flex-col">
          <div class="mb-6 mt-2">
            <h3 class="text-2xl font-bold text-[#3e2723] mb-1">COVENANT</h3>
            <p class="text-sm text-[#8b6a4f] font-bold tracking-widest">託される人</p>
          </div>
          <div class="mb-8">
            <div class="text-[#8b6a4f] text-xs line-through mb-1">通常 ¥69,000 / 年</div>
            <div class="text-3xl font-serif text-[#b8860b]">¥36,900 <span class="text-xs text-[#725b3f] font-sans">/ 1年目特別価格</span></div>
          </div>
          <div class="flex-grow mb-8">
            <ul class="space-y-3 text-sm text-[#5c4a3d]">
              <li class="flex items-start"><i data-lucide="award" class="w-4 h-4 mr-2 mt-0.5 text-[#b8860b]"></i>SETTLERの全機能</li>
              <li class="flex items-start"><i data-lucide="award" class="w-4 h-4 mr-2 mt-0.5 text-[#b8860b]"></i>中核メンバーとしての参画</li>
              <li class="flex items-start"><i data-lucide="award" class="w-4 h-4 mr-2 mt-0.5 text-[#b8860b]"></i>コミュニティの意思決定に関与</li>
              <li class="flex items-start"><i data-lucide="award" class="w-4 h-4 mr-2 mt-0.5 text-[#b8860b]"></i>仕事・依頼の掲載機能</li>
            </ul>
          </div>
          <a id="btn-covenant" href="https://buy.stripe.com/dRm14n28GevZ0lH2fg7bW09" target="_blank" rel="noopener noreferrer" class="block text-center w-full py-4 bg-[#b8860b] text-[#fffdf9] font-bold text-sm tracking-widest hover:bg-[#996515] transition-colors shadow-md">
            契約を結ぶ (加入する)
          </a>
        </div>
      </div>

    </div>

    <!-- Coming Soon Section -->
    <div class="mt-16 pt-16 border-t border-[#dcd4c6]">
      <h3 class="text-center font-bold text-[#725b3f] tracking-widest text-sm mb-8 uppercase">準備中の役割</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 max-w-4xl mx-auto opacity-60">
        
        <!-- BUILDER -->
        <div class="bg-[#f7f5f0] p-6 border border-[#dcd4c6] relative grayscale">
          <div class="absolute inset-0 bg-black/5 flex items-center justify-center z-10 pointer-events-none">
            <div class="bg-[#3e2723] text-white px-4 py-1 text-xs font-serif tracking-widest rotate-[-5deg] border border-[#dcd4c6]">COMING SOON</div>
          </div>
          <div class="mb-4">
            <h4 class="text-lg font-bold text-gray-700">BUILDER</h4>
            <span class="text-xs text-gray-500 tracking-widest">創る人</span>
          </div>
          <div class="text-xl font-serif text-gray-700 mb-4">¥6,600 <span class="text-xs font-sans">/ 月</span></div>
          <p class="text-xs text-gray-500 leading-relaxed">仕組み・文化・プロジェクトを生む側。<br/>航海のあいだ、次の世界に何を持ち込むかを形にし始めた人。</p>
        </div>

        <!-- GUARDIAN -->
        <div class="bg-[#f7f5f0] p-6 border border-[#dcd4c6] relative grayscale">
          <div class="absolute inset-0 bg-black/5 flex items-center justify-center z-10 pointer-events-none">
            <div class="bg-[#3e2723] text-white px-4 py-1 text-xs font-serif tracking-widest rotate-[5deg] border border-[#dcd4c6]">COMING SOON</div>
          </div>
          <div class="mb-4">
            <h4 class="text-lg font-bold text-gray-700">GUARDIAN</h4>
            <span class="text-xs text-gray-500 tracking-widest">守る人</span>
          </div>
          <div class="text-xl font-serif text-gray-700 mb-4">¥9,900 <span class="text-xs font-sans">/ 月</span></div>
          <p class="text-xs text-gray-500 leading-relaxed">判断・秩序・倫理に関与する立場。<br/>嵐の中でも箱舟が進み続けるよう見張り、支え、守る人。</p>
        </div>
        
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
        authDomain: "brainbridge-4b8ac.firebaseapp.com",
        projectId: "brainbridge-4b8ac",
        storageBucket: "brainbridge-4b8ac.firebasestorage.app",
        messagingSenderId: "803209683213",
        appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = 'default-app-id';

    const isAdminMock = localStorage.getItem('isAdminMock') === 'true';

    onAuthStateChanged(auth, async (user) => {
        const loading = document.getElementById('loading-indicator');
        const grid = document.getElementById('pricing-grid');

        if (isAdminMock) {
            updateRankUI('covenant');
            loading.classList.add('hidden');
            grid.classList.remove('hidden');
            return;
        }

        if (user && !user.isAnonymous) {
            try {
                const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const rank = data.membershipRank || 'arrival';
                    updateRankUI(rank);
                } else {
                    updateRankUI('arrival');
                }
            } catch(e) { 
                console.error(e);
                updateRankUI('arrival');
            }
            loading.classList.add('hidden');
            grid.classList.remove('hidden');
        } else {
            window.location.href = 'login.html';
        }
    });

    function updateRankUI(rank) {
        const arrivalBtn = document.getElementById('btn-arrival');
        const settlerBtn = document.getElementById('btn-settler');
        const covenantBtn = document.getElementById('btn-covenant');
        
        const currentPlanStyle = "w-full py-3.5 bg-[#f7f5f0] text-[#a09080] font-bold text-sm tracking-widest border border-[#dcd4c6] cursor-not-allowed flex justify-center items-center gap-2";
        const downgradeMsgStyle = "w-full py-3.5 bg-transparent text-[#a09080] font-bold text-[10px] tracking-widest cursor-not-allowed text-center";

        if (rank === 'arrival') {
            // ARRIVALのまま
            if(arrivalBtn) { 
                arrivalBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i>現在のプラン'; 
                arrivalBtn.className = currentPlanStyle;
            }
        } else if (rank === 'settler') {
            // SETTLER
            if(settlerBtn) { 
                settlerBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i>現在のプラン'; 
                settlerBtn.href = '#'; 
                settlerBtn.className = currentPlanStyle;
            }
            if(arrivalBtn) { 
                arrivalBtn.textContent = '※ダウングレードは運営へお問い合わせください'; 
                arrivalBtn.className = downgradeMsgStyle;
            }
        } else if (rank === 'covenant' || rank === 'admin') {
            // COVENANT
            if(covenantBtn) { 
                covenantBtn.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i>現在のプラン'; 
                covenantBtn.href = '#'; 
                covenantBtn.className = currentPlanStyle;
            }
            if(arrivalBtn) { 
                arrivalBtn.textContent = '※ダウングレードは運営へお問い合わせください'; 
                arrivalBtn.className = downgradeMsgStyle;
            }
            if(settlerBtn) { 
                settlerBtn.textContent = '※ダウングレードは運営へお問い合わせください'; 
                settlerBtn.href = '#'; 
                settlerBtn.className = downgradeMsgStyle;
            }
        }
        
        // 再描画のためアイコン再初期化
        lucide.createIcons();
    }
  </script>
  <script>
    lucide.createIcons();
  </script>
</body>
</html>
