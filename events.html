<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航海と仕事 | NOAH</title>
    <link rel="icon" href="img/icon.png">
    
    <!-- Google Fonts: Noto Serif JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['Noto Serif JP', 'serif'] },
                    colors: { 
                        brand: { 
                            50: '#f7f5f0',   // bg
                            100: '#e8dfd1',  // border light
                            200: '#dcd4c6',  // border medium
                            300: '#c8b9a6',  // border dark
                            400: '#a09080',  // text muted
                            500: '#8b6a4f',  // accent
                            600: '#725b3f',  // accent hover
                            700: '#5c4a3d',  // text body
                            800: '#4a3b32',  // text heading
                            900: '#3e2723'   // text dark
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Serif JP', serif;
            background-color: #f7f5f0; 
            color: #4a3b32;
            overflow: hidden; /* Prevent body scroll, handle internally */
        }
        
        .bg-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        .glass-header {
            background: rgba(255, 253, 249, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* View Areas */
        #view-map { height: calc(100vh - 120px); width: 100%; z-index: 0; }
        #view-list-events, #view-list-jobs { 
            height: calc(100vh - 120px - env(safe-area-inset-bottom)); 
            overflow-y: auto; 
            padding-bottom: 6rem;
        }

        /* Bottom Nav Safe Area */
        .pb-safe-bottom { padding-bottom: calc(4.5rem + env(safe-area-inset-bottom)); }
        
        .bottom-nav-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fffdf9;
            border-top: 1px solid #e8dfd1;
            z-index: 50;
            height: 4rem;
            height: calc(4rem + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .bottom-nav-content {
            height: 4rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }

        /* Detail Sheet */
        .detail-sheet { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .sheet-open { transform: translateY(0%) !important; }
        .sheet-closed { transform: translateY(100%); }

        /* PC Panel */
        .detail-panel-pc { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: -4px 0 15px rgba(62,39,35,0.1); }
        .panel-open { transform: translateX(0%) !important; }
        .panel-closed { transform: translateX(100%); }

        /* Tag Selection */
        .tag-btn.selected { 
            background-color: #8b6a4f !important; 
            color: #fffdf9 !important; 
            border-color: #8b6a4f !important; 
        }

        /* Forms */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8b6a4f !important;
            box-shadow: 0 0 0 1px #8b6a4f !important;
        }

        /* Accordion in Modals */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .accordion-arrow { transition: transform 0.2s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }

        /* Custom Checkbox in Job Modal */
        .job-checkbox:checked + div {
            background-color: #8b6a4f;
            border-color: #8b6a4f;
            color: #fffdf9;
        }

        /* View Tab Active State */
        .tab-btn.active {
            background-color: #3e2723;
            color: #d4af37;
            border-color: #b8860b;
        }

        /* Create Menu Anim */
        #create-menu { transition: opacity 0.2s, transform 0.2s; transform-origin: bottom right; }
        .menu-open { opacity: 1; transform: scale(1); pointer-events: auto; }
        .menu-closed { opacity: 0; transform: scale(0.9); pointer-events: none; }

    </style>
</head>
<body class="antialiased h-screen w-screen relative flex flex-col bg-texture">

    <!-- Navbar -->
    <nav class="glass-header border-b border-brand-200 fixed w-full z-[1500] top-0 h-16 shadow-sm bg-texture">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center relative z-10">
            <div class="flex items-center gap-4">
                <a href="events.html" class="text-xl font-black text-brand-900 tracking-widest flex items-center gap-2 font-serif">
                    <span class="bg-brand-900 text-brand-50 w-8 h-8 flex items-center justify-center rounded-sm text-sm"><i class="fa-solid fa-anchor"></i></span>
                    <span class="hidden sm:inline">NOAH</span>
                </a>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-3">
                <!-- PC Navigation Links -->
                <div class="hidden lg:flex items-center gap-6 mr-4">
                    <a href="home.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-ship"></i> 航海(ホーム)</a>
                    <a href="events.html" class="text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-hourglass-half"></i> イベント・仕事</a>
                    <a href="search.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-compass"></i> さがす</a>
                    <a href="user.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-user"></i> マイページ</a>
                </div>

                <!-- Notification Bell -->
                <a href="notifications.html" class="p-2 text-brand-300 hover:text-brand-600 transition-colors relative" title="通知">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <span class="hidden absolute top-1.5 right-1.5 h-2.5 w-2.5 bg-[#8b6a4f] rounded-full border-2 border-[#fffdf9]"></span>
                </a>

                <!-- Logout (Desktop) -->
                <div class="h-6 w-px bg-brand-200 mx-1 hidden lg:block"></div>
                <button onclick="handleLogout()" class="hidden lg:flex text-sm font-bold text-brand-400 hover:text-red-800 transition-colors flex items-center gap-2">
                    <span class="hidden sm:inline tracking-widest">下船する</span>
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Top View Tabs -->
    <div class="fixed top-16 w-full z-[1400] bg-[#fffdf9]/95 backdrop-blur border-b border-brand-200 py-2 shadow-sm">
        <div class="max-w-3xl mx-auto px-4 flex justify-center">
            <div class="inline-flex bg-brand-50 border border-brand-200 rounded-sm p-1 shadow-inner w-full sm:w-auto">
                <button onclick="switchView('map')" id="tab-map" class="tab-btn active flex-1 sm:flex-none px-4 py-2 text-[11px] sm:text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1">
                    <i class="fa-solid fa-map-location-dot"></i> マップ(イベント)
                </button>
                <button onclick="switchView('list-events')" id="tab-list-events" class="tab-btn flex-1 sm:flex-none px-4 py-2 text-[11px] sm:text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1">
                    <i class="fa-solid fa-list"></i> リスト(イベント)
                </button>
                <button onclick="switchView('list-jobs')" id="tab-list-jobs" class="tab-btn flex-1 sm:flex-none px-4 py-2 text-[11px] sm:text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1 relative">
                    <i class="fa-solid fa-briefcase"></i> 仕事・依頼
                    <span class="absolute -top-1 -right-1 flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#d4af37] opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-[#b8860b]"></span></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="mt-[120px] w-full h-full relative z-0">
        
        <!-- View 1: Map -->
        <div id="view-map" class="block relative">
            <div id="map" class="w-full h-full"></div>
            <!-- Location Adjustment UI inside Map View -->
            <div id="adjust-location-ui" class="hidden absolute bottom-8 left-1/2 transform -translate-x-1/2 z-[1000] w-[90%] max-w-sm pointer-events-auto">
                <div class="bg-[#fffdf9] p-4 rounded-sm shadow-xl border border-brand-300 text-center text-brand-900 font-serif">
                    <p class="font-bold mb-3 tracking-widest text-sm"><i class="fa-solid fa-thumbtack text-red-500 mr-1"></i>赤色のピンをドラッグして調整</p>
                    <button onclick="finishLocationAdjust()" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-2.5 rounded-sm shadow-md tracking-widest text-sm hover:bg-[#2a1a17]">
                        位置を決定して編集に戻る
                    </button>
                </div>
            </div>
        </div>

        <!-- View 2: Event List -->
        <div id="view-list-events" class="hidden max-w-4xl mx-auto px-4 pt-6">
            <div class="flex justify-between items-end mb-6 border-b border-brand-200 pb-2">
                <h2 class="text-xl font-bold text-brand-900 font-serif tracking-widest">イベント一覧</h2>
                <span id="event-list-status" class="text-xs text-brand-500 tracking-widest">現在地から近い順</span>
            </div>
            <div id="event-list-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- List injected here -->
            </div>
            <div id="event-list-loading" class="text-center py-10 text-brand-400 hidden"><i class="fa-solid fa-compass fa-spin text-2xl mb-2"></i><p class="text-xs tracking-widest">探しています...</p></div>
            <div id="event-list-empty" class="text-center py-10 text-brand-400 hidden">イベントが見つかりません。</div>
        </div>

        <!-- View 3: Job List -->
        <div id="view-list-jobs" class="hidden max-w-4xl mx-auto px-4 pt-6">
            <div class="flex justify-between items-end mb-6 border-b border-brand-200 pb-2">
                <h2 class="text-xl font-bold text-brand-900 font-serif tracking-widest">仕事・依頼一覧</h2>
                <span class="text-xs text-brand-500 tracking-widest">新着順</span>
            </div>
            <div id="job-list-container" class="space-y-4">
                <!-- List injected here -->
            </div>
            <div id="job-list-loading" class="text-center py-10 text-brand-400 hidden"><i class="fa-solid fa-compass fa-spin text-2xl mb-2"></i><p class="text-xs tracking-widest">探しています...</p></div>
            <div id="job-list-empty" class="text-center py-10 text-brand-400 hidden">掲載されている仕事・依頼がありません。</div>
        </div>

    </div>

    <!-- Create FAB & Menu -->
    <div class="absolute bottom-24 lg:bottom-10 right-5 z-[2000] flex flex-col items-end">
        <!-- Floating Menu -->
        <div id="create-menu" class="menu-closed mb-3 bg-[#fffdf9] border border-brand-300 shadow-xl rounded-sm p-2 flex flex-col gap-1 w-48">
            <button onclick="openCreateModal('event')" class="text-left px-3 py-3 hover:bg-brand-50 rounded-sm text-sm font-bold text-brand-900 tracking-widest border-b border-brand-100 flex items-center justify-between">
                <span><i class="fa-solid fa-champagne-glasses text-brand-500 w-5"></i> イベントを企画</span>
            </button>
            <button onclick="openCreateModal('job')" class="text-left px-3 py-3 hover:bg-brand-50 rounded-sm text-sm font-bold text-brand-900 tracking-widest flex items-center justify-between group">
                <span><i class="fa-solid fa-briefcase text-brand-500 w-5"></i> 仕事・依頼を掲載</span>
                <i class="fa-solid fa-lock text-brand-300 text-xs group-hover:text-brand-500" title="BUILDER以上限定"></i>
            </button>
        </div>
        <!-- FAB -->
        <button id="create-fab-btn" onclick="toggleCreateMenu()" class="hidden w-14 h-14 bg-[#3e2723] text-[#d4af37] rounded-full shadow-2xl flex items-center justify-center hover:bg-[#2a1a17] hover:scale-105 transition-all border-2 border-[#b8860b]">
            <i class="fa-solid fa-plus text-xl transition-transform duration-300" id="fab-icon"></i>
        </button>
    </div>

    <!-- Details Sheet/Panel (Event) -->
    <div id="event-sheet" class="detail-sheet sheet-closed absolute bottom-0 left-0 w-full z-[2100] bg-[#fffdf9] border-t border-brand-300 rounded-t-sm shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-safe-bottom max-h-[90vh] overflow-y-auto lg:w-[400px] lg:left-4 lg:bottom-4 lg:rounded-sm lg:border lg:max-h-[85vh] lg:pb-0 lg:transform-none lg:hidden bg-texture">
        <div class="sticky top-0 bg-[#fffdf9]/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center border-b border-brand-100" onclick="closeDetail('event')">
            <div class="w-12 h-1 bg-brand-300 rounded-full lg:hidden"></div>
            <div class="hidden lg:flex w-full justify-between items-center px-4">
                <span class="text-xs font-bold text-brand-500 tracking-widest">イベント詳細</span>
                <i class="fa-solid fa-xmark text-brand-400 hover:text-brand-700 cursor-pointer text-lg"></i>
            </div>
        </div>
        <div id="event-sheet-content" class="px-5 pb-20 lg:pb-5 pt-4"></div>
    </div>

    <!-- Details Sheet/Panel (Job) -->
    <div id="job-sheet" class="detail-sheet sheet-closed absolute bottom-0 left-0 w-full z-[2100] bg-[#fffdf9] border-t border-brand-300 rounded-t-sm shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-safe-bottom max-h-[90vh] overflow-y-auto lg:w-[500px] lg:left-4 lg:bottom-4 lg:rounded-sm lg:border lg:max-h-[85vh] lg:pb-0 lg:transform-none lg:hidden bg-texture">
        <div class="sticky top-0 bg-[#fffdf9]/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center border-b border-brand-100" onclick="closeDetail('job')">
            <div class="w-12 h-1 bg-brand-300 rounded-full lg:hidden"></div>
            <div class="hidden lg:flex w-full justify-between items-center px-4">
                <span class="text-xs font-bold text-brand-500 tracking-widest">仕事・依頼 詳細</span>
                <i class="fa-solid fa-xmark text-brand-400 hover:text-brand-700 cursor-pointer text-lg"></i>
            </div>
        </div>
        <div id="job-sheet-content" class="px-5 pb-20 lg:pb-5 pt-4"></div>
    </div>

    <!-- ========================================== -->
    <!-- MODALS -->
    <!-- ========================================== -->

    <!-- Event Create Modal -->
    <div id="event-modal" class="hidden fixed inset-0 z-[3000] bg-[#2a1a17]/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-[#fffdf9] bg-texture w-full sm:w-[600px] h-[95vh] sm:h-[90vh] rounded-t-sm sm:rounded-sm shadow-2xl flex flex-col border border-brand-300">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center flex-shrink-0 bg-[#fffdf9]">
                <h3 class="font-bold text-lg text-brand-900 font-serif tracking-widest" id="event-modal-title">イベントを企画</h3>
                <button onclick="closeCreateModal('event')" class="p-2 text-brand-400 hover:text-brand-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 space-y-6">
                <!-- Thumbnail -->
                <div>
                    <label class="block text-xs font-bold text-brand-700 mb-2 tracking-widest">サムネイル画像</label>
                    <div class="relative w-full h-40 bg-brand-50 rounded-sm border border-dashed border-brand-300 flex flex-col items-center justify-center text-brand-400 hover:bg-[#fffdf9] cursor-pointer overflow-hidden group">
                        <input type="file" id="event-image" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                        <img id="event-image-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div class="group-hover:scale-110 transition-transform flex flex-col items-center">
                            <i class="fa-solid fa-image text-2xl mb-1"></i>
                            <span class="text-xs tracking-widest">画像をアップロード</span>
                        </div>
                    </div>
                </div>

                <!-- Title & Price -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">イベント名 <span class="text-red-500">*</span></label>
                        <input type="text" id="event-title" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9]" placeholder="例: 週末朝活コーヒー会" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">参加費(円)</label>
                        <input type="number" id="event-price" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9]" placeholder="無料なら0">
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="bg-brand-50 p-4 rounded-sm border border-brand-200">
                    <label class="block text-xs font-bold text-brand-800 mb-3 tracking-widest">日時 <span class="text-red-500">*</span></label>
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center mb-3">
                        <span class="text-xs font-bold text-brand-500 w-10">開始</span>
                        <input type="date" id="event-start-date" class="flex-1 w-full sm:w-auto border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                        <input type="time" id="event-start-time" class="w-full sm:w-28 border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <span class="text-xs font-bold text-brand-500 w-10">終了</span>
                        <input type="date" id="event-end-date" class="flex-1 w-full sm:w-auto border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                        <input type="time" id="event-end-time" class="w-full sm:w-28 border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                    </div>
                </div>

                <!-- Tags (Online trigger) -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-xs font-bold text-brand-700 tracking-widest">タグを選択 <span class="text-red-500">*</span></label>
                        <span class="text-[10px] text-brand-500">※「オンライン」選択で入力枠が変わります</span>
                    </div>
                    <div class="flex flex-wrap gap-2" id="event-tag-area"></div>
                    <input type="text" id="event-custom-tags" placeholder="その他のタグ (カンマ区切り)" class="mt-2 w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                </div>

                <!-- Location / Online URL Toggle Area -->
                <div class="bg-brand-50 p-4 rounded-sm border border-brand-200 relative overflow-hidden" id="location-wrapper">
                    
                    <!-- Offline Mode -->
                    <div id="offline-location-group">
                        <label class="block text-xs font-bold text-brand-800 mb-2 tracking-widest">開催場所の設定 (オフライン) <span class="text-red-500">*</span></label>
                        <div class="flex gap-2 mb-2">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-brand-400"></i>
                                <input type="text" id="location-search-input" placeholder="住所や建物名で検索" class="w-full border-brand-200 rounded-sm text-sm pl-10 p-2.5 bg-[#fffdf9]">
                            </div>
                            <button onclick="searchLocation()" type="button" class="bg-brand-800 text-white px-4 rounded-sm text-sm font-bold whitespace-nowrap hover:bg-brand-900 tracking-widest">検索</button>
                        </div>
                        <div id="location-results" class="hidden mb-3 border border-brand-200 rounded-sm overflow-hidden max-h-40 overflow-y-auto shadow-sm bg-white"></div>
                        <button type="button" onclick="startLocationAdjust()" class="w-full py-2 bg-[#fffdf9] border border-brand-300 text-brand-700 rounded-sm text-xs font-bold hover:bg-brand-100 transition-colors mb-4 flex items-center justify-center gap-2 tracking-widest shadow-sm">
                            <i class="fa-solid fa-map-location-dot text-brand-500"></i> 地図を見ながら位置を微調整する
                        </button>
                        <div>
                            <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">表示する場所名</label>
                            <input type="text" id="event-location-name" placeholder="例: ミッドランドスクエア 42階" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                        </div>
                    </div>

                    <!-- Online Mode -->
                    <div id="online-url-group" class="hidden">
                        <label class="block text-xs font-bold text-brand-800 mb-2 tracking-widest">オンライン開催設定 <span class="text-red-500">*</span></label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">開催ツール (例: Zoom, Google Meet)</label>
                                <input type="text" id="event-online-tool" placeholder="Zoom" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">参加URL</label>
                                <input type="url" id="event-online-url" placeholder="https://..." class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">詳細・内容</label>
                    <textarea id="event-desc" rows="5" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9] leading-relaxed" placeholder="イベントの魅力や詳細を書きましょう"></textarea>
                </div>

                <!-- Settings -->
                <div class="bg-[#fffdf9] p-3 rounded-sm border border-brand-200 shadow-sm">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="event-public-participants" class="w-5 h-5 text-brand-800 rounded-sm focus:ring-brand-500 border-brand-300" checked>
                        <div>
                            <span class="block text-sm font-bold text-brand-800 tracking-widest">参加者を公開する</span>
                            <span class="block text-[10px] text-brand-500 tracking-widest mt-0.5">チェックを外すと、参加者は主催者のみに見えます</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom sm:pb-4 flex-shrink-0">
                <button onclick="submitEvent()" id="event-submit-btn" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#b8860b]">
                    イベントを企画する
                </button>
            </div>
        </div>
    </div>

    <!-- Job Create Modal -->
    <div id="job-modal" class="hidden fixed inset-0 z-[3000] bg-[#2a1a17]/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-[#fffdf9] bg-texture w-full sm:w-[650px] h-[95vh] sm:h-[90vh] rounded-t-sm sm:rounded-sm shadow-2xl flex flex-col border border-brand-300">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center flex-shrink-0 bg-[#fffdf9]">
                <h3 class="font-bold text-lg text-brand-900 font-serif tracking-widest">仕事・依頼を掲載</h3>
                <button onclick="closeCreateModal('job')" class="p-2 text-brand-400 hover:text-brand-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 space-y-4" id="job-form-container">
                <p class="text-xs text-brand-600 font-bold tracking-widest mb-2"><i class="fa-solid fa-circle-info mr-1"></i> 情報を詳細に記載するとマッチング率が上がります</p>
                
                <!-- Accordion 1: 基本情報 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm" open>
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">1. 基本情報 (必須)</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">募集タイトル</label>
                            <input type="text" id="job-title" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="例: 新規事業のUI/UXデザイナー募集" required>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">募集タイプ</label>
                                <select id="job-type" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" required>
                                    <option value="業務委託">業務委託</option>
                                    <option value="正社員">正社員</option>
                                    <option value="契約社員">契約社員</option>
                                    <option value="アルバイト">アルバイト</option>
                                    <option value="単発依頼">単発依頼</option>
                                    <option value="共同事業パートナー">共同事業パートナー</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">業種カテゴリ</label>
                                <select id="job-category" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" required>
                                    <option value="デザイン">デザイン</option>
                                    <option value="エンジニア">エンジニア</option>
                                    <option value="マーケティング">マーケティング</option>
                                    <option value="営業">営業</option>
                                    <option value="動画制作">動画制作</option>
                                    <option value="ライティング">ライティング</option>
                                    <option value="事務・サポート">事務・サポート</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">業務内容詳細</label>
                            <textarea id="job-desc" rows="6" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-white leading-relaxed" placeholder="背景・具体的な作業内容・期待する成果などを詳しく記載してください" required></textarea>
                        </div>
                    </div>
                </details>

                <!-- Accordion 2: 報酬・期間・条件 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">2. 報酬・期間・働き方</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">報酬形態</label>
                                <select id="job-reward-type" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="固定報酬">固定報酬</option>
                                    <option value="時給">時給</option>
                                    <option value="月給">月給</option>
                                    <option value="成果報酬">成果報酬</option>
                                    <option value="無償・レベニューシェア">無償・レベニューシェア</option>
                                    <option value="応相談">応相談</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">金額・レンジ(円等)</label>
                                <input type="text" id="job-reward-amount" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="例: 100,000〜300,000">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">契約期間</label>
                                <select id="job-period" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="単発">単発</option>
                                    <option value="1ヶ月">1ヶ月</option>
                                    <option value="3ヶ月">3ヶ月</option>
                                    <option value="長期">長期</option>
                                    <option value="期間未定">期間未定</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">勤務形態</label>
                                <select id="job-work-style" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="フルリモート">フルリモート</option>
                                    <option value="一部出社">一部出社</option>
                                    <option value="出社必須">出社必須</option>
                                    <option value="指定なし">指定なし</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">勤務地(出社の場合)</label>
                            <input type="text" id="job-location" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="例: 東京都渋谷区 または オンライン可">
                        </div>
                    </div>
                </details>

                <!-- Accordion 3: 応募条件・フロー -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">3. 応募条件・選考フロー</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">必須・歓迎スキル</label>
                            <textarea id="job-skills" rows="3" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white leading-relaxed" placeholder="Figma実務経験2年以上、等"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">応募締切日</label>
                                <input type="date" id="job-deadline" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">選考フロー</label>
                                <select id="job-flow" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="面談1回">面談1回</option>
                                    <option value="書類選考 → 面接">書類選考 → 面接</option>
                                    <option value="即決">即決</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Accordion 4: 投稿者情報 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">4. 投稿者・会社情報</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">会社・団体名 (任意)</label>
                            <input type="text" id="job-company" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">公式サイト等 URL</label>
                            <input type="url" id="job-url" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="https://...">
                        </div>
                    </div>
                </details>

            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom sm:pb-4 flex-shrink-0">
                <button onclick="submitJob()" id="job-submit-btn" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#b8860b]">
                    募集を掲載する
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-[#fffdf9] border-t border-brand-200 lg:hidden z-[1900] safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16">
            <a href="home.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-ship text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">航海</span>
            </a>
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600 transition-colors border-t-2 border-brand-500 pt-[2px]">
                <i class="fa-solid fa-hourglass-half text-xl mb-1"></i>
                <span class="text-[10px] font-bold tracking-widest">イベント</span>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-compass text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">さがす</span>
            </a>
            <button onclick="alert('マッチング機能は準備中です。\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-brand-300 hover:text-brand-500 transition-colors">
                <i class="fa-solid fa-handshake text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">マッチ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">マイページ</span>
            </a>
        </div>
    </nav>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, orderBy, serverTimestamp, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        // ▼▼▼▼ Firebase Config ▼▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'default-app-id';

        let map;
        let markers = [];
        let allEvents = [];
        let allJobs = [];
        let currentUser = null;
        let myProfile = null;
        let userLocation = null; // {lat, lng}
        
        // Form States
        let tempMarker = null; 
        let selectedCoords = null;
        let selectedTags = new Set();
        let isJoining = false;
        let editingEventId = null;

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';
        const presetTags = ["交流会", "勉強会", "スポーツ", "音楽", "アート", "グルメ", "アウトドア", "ビジネス", "初心者歓迎", "オンライン"];
        
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderEventTagButtons();
            
            // Search Bindings (Map mode only for now, can extend to lists)
            const pcSearch = document.getElementById('pc-map-search');
            const mobileSearch = document.getElementById('mobile-map-search');
            const handleSearch = (e) => {
                const val = e.target.value.toLowerCase();
                const filtered = allEvents.filter(evt => evt.title.toLowerCase().includes(val));
                renderMarkers(filtered);
            };
            if(pcSearch) pcSearch.addEventListener('input', handleSearch);
            if(mobileSearch) mobileSearch.addEventListener('input', handleSearch);

            const startDateInput = document.getElementById('event-start-date');
            const endDateInput = document.getElementById('event-end-date');
            startDateInput.addEventListener('change', () => {
                if (!endDateInput.value) endDateInput.value = startDateInput.value;
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid' };
                document.getElementById('create-fab-btn').classList.remove('hidden');
                myProfile = { name: '管理者', userId: 'admin', membershipRank: 'covenant' };
                loadAllData();
                return;
            }

            if (user) {
                currentUser = user;
                try {
                    const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                    if (docSnap.exists()) {
                        myProfile = docSnap.data();
                        const rank = myProfile.membershipRank || 'arrival';
                        // ARRIVAL(無料)以外はFABを表示
                        if (rank !== 'arrival') {
                            document.getElementById('create-fab-btn').classList.remove('hidden');
                        }
                    }
                } catch (e) { console.error(e); }
                loadAllData();
            } else {
                window.location.href = 'login.html';
            }
        });

        // ==========================================
        // View Switcher & Core Load
        // ==========================================
        window.switchView = (viewName) => {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-[#3e2723]', 'text-[#d4af37]', 'border-[#b8860b]');
                btn.classList.add('bg-white', 'text-brand-700', 'border-brand-300');
            });
            const activeBtn = document.getElementById(`tab-${viewName}`);
            activeBtn.classList.remove('bg-white', 'text-brand-700', 'border-brand-300');
            activeBtn.classList.add('active', 'bg-[#3e2723]', 'text-[#d4af37]', 'border-[#b8860b]');

            document.getElementById('view-map').classList.add('hidden');
            document.getElementById('view-list-events').classList.add('hidden');
            document.getElementById('view-list-jobs').classList.add('hidden');

            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            // Map resize fix
            if (viewName === 'map' && map) setTimeout(() => map.invalidateSize(), 100);
        };

        async function loadAllData() {
            await Promise.all([loadEvents(), loadJobs()]);
        }

        // ==========================================
        // Map & Event List Logic
        // ==========================================
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        renderEventList(); // Re-render list to calculate distances
                    },
                    () => { console.log("Location access denied or error"); }
                );
            }
        }

        async function loadEvents() {
            const now = new Date().toISOString();
            const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'events');
            const q = query(eventsRef, orderBy('createdAt', 'desc')); 
            
            try {
                const snapshot = await getDocs(q);
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                allEvents = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    if (data.endTimestamp && data.endTimestamp < now) return; 
                    allEvents.push(data);
                });
                renderMarkers(allEvents);
                renderEventList();
            } catch (e) { console.error("Event Load Error:", e); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function renderEventList() {
            const container = document.getElementById('event-list-container');
            const emptyMsg = document.getElementById('event-list-empty');
            
            if (allEvents.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            let displayEvents = [...allEvents];
            
            if (userLocation) {
                displayEvents.forEach(e => {
                    if(e.lat && e.lng) e._distance = calculateDistance(userLocation.lat, userLocation.lng, e.lat, e.lng);
                    else e._distance = 99999; // Online or missing
                });
                displayEvents.sort((a, b) => a._distance - b._distance);
                document.getElementById('event-list-status').textContent = '現在地から近い順';
            } else {
                document.getElementById('event-list-status').textContent = '新着順';
            }

            container.innerHTML = displayEvents.map(evt => {
                const thumb = evt.thumbnailUrl || 'https://via.placeholder.com/150?text=NOAH';
                const distStr = evt._distance !== undefined && evt._distance < 99999 ? `<span class="bg-brand-100 text-brand-700 px-1.5 py-0.5 rounded-sm ml-2 text-[10px] font-bold"><i class="fa-solid fa-location-arrow mr-1"></i>${evt._distance.toFixed(1)}km</span>` : '';
                const dateStr = `${evt.startDate} ${evt.startTime}`;
                const tags = evt.tags ? evt.tags.slice(0,2).map(t => `<span class="text-[10px] bg-[#f7f5f0] border border-brand-200 text-brand-600 px-1 rounded-sm">#${t}</span>`).join('') : '';

                return `
                <div class="flex bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm hover:shadow-md cursor-pointer transition-shadow h-28" onclick='showEventSheet(${JSON.stringify(evt).replace(/'/g, "&apos;")})'>
                    <div class="w-28 h-full flex-shrink-0 relative">
                        <img src="${thumb}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3 flex flex-col justify-between flex-1 min-w-0">
                        <div>
                            <h3 class="font-bold text-sm text-brand-900 truncate font-serif tracking-widest">${evt.title}</h3>
                            <p class="text-[10px] text-brand-500 mt-1 flex items-center"><i class="fa-regular fa-clock mr-1"></i>${dateStr} ${distStr}</p>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-1 overflow-hidden">${tags}</div>
                            <span class="text-[10px] font-bold ${evt.price > 0 ? 'text-[#b8860b]' : 'text-brand-600'}">${evt.price > 0 ? '¥'+evt.price.toLocaleString() : '無料'}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMarkers(events) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            events.forEach(data => {
                // オフライン設定で座標がある場合のみピン立て
                if (data.lat && data.lng) {
                    const marker = L.marker([data.lat, data.lng]).addTo(map);
                    marker.on('click', () => {
                        switchView('map');
                        handleMarkerClick(data);
                    });
                    markers.push(marker);
                }
            });
        }

        function handleMarkerClick(targetEvent) {
            const zoom = map.getZoom();
            const targetLatLng = L.latLng(targetEvent.lat, targetEvent.lng);
            const targetPoint = map.project(targetLatLng, zoom);
            
            const nearbyEvents = allEvents.filter(evt => {
                if (!evt.lat || !evt.lng) return false;
                const evtLatLng = L.latLng(evt.lat, evt.lng);
                const evtPoint = map.project(evtLatLng, zoom);
                return targetPoint.distanceTo(evtPoint) < 30; 
            });
            
            if (nearbyEvents.length > 1) {
                showEventListSheet(nearbyEvents);
            } else {
                showEventSheet(targetEvent);
            }
        }

        // ==========================================
        // Job List Logic
        // ==========================================
        async function loadJobs() {
            const jobsRef = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');
            const q = query(jobsRef, orderBy('createdAt', 'desc')); 
            try {
                const snapshot = await getDocs(q);
                allJobs = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    allJobs.push(data);
                });
                renderJobList();
            } catch (e) { console.error("Job Load Error:", e); }
        }

        function renderJobList() {
            const container = document.getElementById('job-list-container');
            const emptyMsg = document.getElementById('job-list-empty');
            
            if (allJobs.length === 0) {
                container.innerHTML = '';
                emptyMsg.classList.remove('hidden');
                return;
            }
            emptyMsg.classList.add('hidden');

            container.innerHTML = allJobs.map(job => {
                const badgeColor = job.type === '正社員' ? 'bg-[#3e2723] text-[#d4af37]' : 'bg-brand-100 text-brand-800';
                return `
                <div class="bg-[#fffdf9] border border-brand-200 rounded-sm p-4 shadow-sm hover:shadow-md hover:border-brand-300 transition-all cursor-pointer relative" onclick='showJobSheet(${JSON.stringify(job).replace(/'/g, "&apos;")})'>
                    <div class="absolute top-0 right-0 w-8 h-8 border-t border-r border-brand-200 m-2"></div>
                    <div class="flex justify-between items-start mb-2 pr-4">
                        <span class="inline-block px-2 py-0.5 text-[10px] font-bold rounded-sm tracking-widest ${badgeColor}">${job.type}</span>
                        <span class="text-[10px] text-brand-400"><i class="fa-solid fa-clock-rotate-left mr-1"></i>${job.createdAt ? new Date(job.createdAt.toDate()).toLocaleDateString() : ''}</span>
                    </div>
                    <h3 class="font-bold text-brand-900 font-serif tracking-widest leading-tight mb-2">${job.title}</h3>
                    <p class="text-xs text-brand-500 line-clamp-2 leading-relaxed mb-3">${job.desc}</p>
                    <div class="flex flex-wrap gap-x-4 gap-y-2 border-t border-brand-100 pt-3">
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-yen-sign text-brand-400 mr-1"></i>${job.rewardType}: ${job.rewardAmount || '応相談'}</div>
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-location-dot text-brand-400 mr-1"></i>${job.workStyle}</div>
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-building text-brand-400 mr-1"></i>${job.company || job.organizerName}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ==========================================
        // FAB & Menus
        // ==========================================
        window.toggleCreateMenu = () => {
            const menu = document.getElementById('create-menu');
            const icon = document.getElementById('fab-icon');
            if (menu.classList.contains('menu-closed')) {
                menu.classList.remove('menu-closed');
                menu.classList.add('menu-open');
                icon.style.transform = 'rotate(45deg)';
            } else {
                menu.classList.add('menu-closed');
                menu.classList.remove('menu-open');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        window.openCreateModal = (type) => {
            toggleCreateMenu(); // Close menu
            
            if (!myProfile) return alert('プロフィール情報が読み込めません。');
            const rank = myProfile.membershipRank || 'arrival';

            if (type === 'event') {
                if (rank === 'arrival' && !isAdmin) return alert('イベント企画は SETTLER 以上の機能です。契約変更をご検討ください。');
                
                document.getElementById('event-modal').classList.remove('hidden');
                editingEventId = null;
                // Reset form
                document.getElementById('event-title').value = "";
                document.getElementById('event-price').value = "0";
                const todayStr = new Date().toISOString().split('T')[0];
                document.getElementById('event-start-date').value = todayStr;
                document.getElementById('event-end-date').value = todayStr;
                document.getElementById('event-location-name').value = "";
                document.getElementById('event-online-tool').value = "";
                document.getElementById('event-online-url').value = "";
                document.getElementById('event-desc').value = "";
                selectedTags.clear();
                renderEventTagButtons();
                checkOnlineToggle();
                if (tempMarker) map.removeLayer(tempMarker);
                selectedCoords = null;

            } else if (type === 'job') {
                // Job requires BUILDER or higher (BUILDER, GUARDIAN, COVENANT)
                const allowedRanks = ['builder', 'guardian', 'covenant'];
                if (!allowedRanks.includes(rank) && !isAdmin) return alert('仕事・依頼の掲載は BUILDER 以上の機能です。契約変更をご検討ください。');
                
                document.getElementById('job-modal').classList.remove('hidden');
                document.getElementById('job-form-container').scrollTop = 0;
                // Form is HTML native, let it be empty for new
            }
        };

        window.closeCreateModal = (type) => {
            if(type === 'event') document.getElementById('event-modal').classList.add('hidden');
            if(type === 'job') document.getElementById('job-modal').classList.add('hidden');
        };

        // ==========================================
        // Event Create Logic (Updated with Online/Price)
        // ==========================================
        function renderEventTagButtons() {
            const container = document.getElementById('event-tag-area');
            container.innerHTML = '';
            presetTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = 'tag-btn px-3 py-1 rounded-sm border border-brand-200 text-[10px] font-bold text-brand-600 bg-[#fffdf9] transition-all tracking-widest';
                btn.textContent = tag;
                if(selectedTags.has(tag)) btn.classList.add('selected');

                btn.onclick = () => {
                    if (selectedTags.has(tag)) selectedTags.delete(tag);
                    else selectedTags.add(tag);
                    renderEventTagButtons();
                    checkOnlineToggle();
                };
                container.appendChild(btn);
            });
        }

        function checkOnlineToggle() {
            const offlineGroup = document.getElementById('offline-location-group');
            const onlineGroup = document.getElementById('online-url-group');
            if (selectedTags.has('オンライン')) {
                offlineGroup.classList.add('hidden');
                onlineGroup.classList.remove('hidden');
            } else {
                offlineGroup.classList.remove('hidden');
                onlineGroup.classList.add('hidden');
            }
        }

        window.searchLocation = async () => {
            const query = document.getElementById('location-search-input').value;
            if (!query) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();
                const list = document.getElementById('location-results');
                list.innerHTML = '';
                list.classList.remove('hidden');
                if (results.length === 0) { list.innerHTML = '<div class="p-3 text-sm text-brand-500">見つかりませんでした</div>'; return; }
                results.forEach(place => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border-b border-brand-100 cursor-pointer text-sm text-brand-700 hover:bg-brand-50';
                    div.textContent = place.display_name;
                    div.onclick = () => selectLocation(place);
                    list.appendChild(div);
                });
            } catch (e) { alert('検索エラーが発生しました'); }
        };

        function selectLocation(place) {
            selectedCoords = { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };
            document.getElementById('location-results').classList.add('hidden');
            document.getElementById('event-location-name').value = place.display_name.split(',')[0];
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(selectedCoords, { draggable: true, icon: redIcon }).addTo(map);
            tempMarker.on('dragend', function(e) { selectedCoords = e.target.getLatLng(); });
            map.flyTo(selectedCoords, 15);
        }

        window.startLocationAdjust = () => {
            if (!selectedCoords) return alert('先に場所を検索してください');
            document.getElementById('event-modal').classList.add('hidden');
            document.getElementById('adjust-location-ui').classList.remove('hidden');
            switchView('map');
            map.invalidateSize();
        };

        window.finishLocationAdjust = () => {
            document.getElementById('adjust-location-ui').classList.add('hidden');
            document.getElementById('event-modal').classList.remove('hidden');
        };

        window.submitEvent = async () => {
            if (!currentUser) return;
            const title = document.getElementById('event-title').value;
            const priceStr = document.getElementById('event-price').value;
            const price = priceStr ? parseInt(priceStr) : 0;
            const startDate = document.getElementById('event-start-date').value;
            const startTime = document.getElementById('event-start-time').value;
            const endDate = document.getElementById('event-end-date').value;
            const endTime = document.getElementById('event-end-time').value;
            
            const isOnline = selectedTags.has('オンライン');

            if (!title || !startDate || !startTime || !endDate || !endTime) return alert('タイトルと日時は必須です');
            if (!isOnline && !selectedCoords) return alert('オフライン開催の場合は場所を設定してください');

            let thumbnailUrl = '';
            const file = document.getElementById('event-image').files[0];
            if (file) {
                try {
                    const snap = await uploadBytes(ref(storage, `events/${currentUser.uid}/${Date.now()}_${file.name}`), file);
                    thumbnailUrl = await getDownloadURL(snap.ref);
                } catch (e) { return alert("画像のアップロードに失敗しました"); }
            }

            const customTags = document.getElementById('event-custom-tags').value.split(',').map(s=>s.trim()).filter(s=>s);
            const finalTags = [...Array.from(selectedTags), ...customTags];

            const eventData = {
                title: title, price: price,
                startDate: startDate, startTime: startTime, endDate: endDate, endTime: endTime,
                endTimestamp: new Date(`${endDate}T${endTime}`).toISOString(),
                description: document.getElementById('event-desc').value,
                tags: finalTags, thumbnailUrl: thumbnailUrl,
                organizerId: currentUser.uid,
                organizerName: myProfile ? (myProfile.name || myProfile.userId) : '主催者',
                isParticipantsPublic: document.getElementById('event-public-participants').checked,
                createdAt: serverTimestamp(),
                participantCount: 0
            };

            if (isOnline) {
                eventData.isOnline = true;
                eventData.locationName = "オンライン (" + document.getElementById('event-online-tool').value + ")";
                eventData.onlineUrl = document.getElementById('event-online-url').value;
                eventData.lat = null; eventData.lng = null;
            } else {
                eventData.isOnline = false;
                eventData.locationName = document.getElementById('event-location-name').value;
                eventData.lat = selectedCoords.lat; eventData.lng = selectedCoords.lng;
            }

            try {
                document.getElementById('event-submit-btn').textContent = "送信中...";
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), eventData);
                alert('イベントを企画しました！');
                closeCreateModal('event');
                loadEvents();
            } catch (e) {
                console.error(e); alert('処理に失敗しました。');
            } finally {
                document.getElementById('event-submit-btn').textContent = "イベントを企画する";
            }
        };

        // ==========================================
        // Job Create Logic
        // ==========================================
        window.submitJob = async () => {
            if (!currentUser) return;
            const title = document.getElementById('job-title').value;
            const type = document.getElementById('job-type').value;
            const category = document.getElementById('job-category').value;
            const desc = document.getElementById('job-desc').value;

            if (!title || !desc) return alert('必須項目(タイトル・詳細)を入力してください');

            const jobData = {
                title: title, type: type, category: category, desc: desc,
                rewardType: document.getElementById('job-reward-type').value,
                rewardAmount: document.getElementById('job-reward-amount').value,
                period: document.getElementById('job-period').value,
                workStyle: document.getElementById('job-work-style').value,
                location: document.getElementById('job-location').value,
                skills: document.getElementById('job-skills').value,
                deadline: document.getElementById('job-deadline').value,
                flow: document.getElementById('job-flow').value,
                company: document.getElementById('job-company').value,
                url: document.getElementById('job-url').value,
                
                organizerId: currentUser.uid,
                organizerName: myProfile ? (myProfile.name || myProfile.userId) : '投稿者',
                organizerAvatar: myProfile ? myProfile.photoURL : null,
                createdAt: serverTimestamp(),
            };

            try {
                document.getElementById('job-submit-btn').textContent = "送信中...";
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jobs'), jobData);
                alert('仕事・依頼を掲載しました！');
                closeCreateModal('job');
                loadJobs();
                switchView('list-jobs'); // 掲載後リストへ遷移
            } catch (e) {
                console.error(e); alert('処理に失敗しました。');
            } finally {
                document.getElementById('job-submit-btn').textContent = "募集を掲載する";
            }
        };

        // ==========================================
        // Details Sheets Display
        // ==========================================
        window.showEventSheet = async (evt) => {
            const isPC = window.innerWidth >= 1024;
            // For unified logic, let's just use the mobile sheet styling but placed centrally for both
            const sheet = document.getElementById('event-sheet');
            const content = document.getElementById('event-sheet-content');

            let isJoined = false;
            let partsHtml = '<div class="text-[10px] text-brand-400">読み込み中...</div>';
            
            // Note: omitting participant fetching logic here to keep code size manageable and focus on UI, 
            // but structure remains for future implementation
            partsHtml = '<div class="text-[10px] text-brand-500 bg-brand-50 p-2 rounded-sm border border-brand-200">現在参加者の表示機能は調整中です</div>';

            const thumb = evt.thumbnailUrl || 'https://via.placeholder.com/400x200?text=NOAH+Event';
            const tags = evt.tags ? evt.tags.map(t => `<span class="bg-brand-50 border border-brand-200 text-brand-600 px-2 py-0.5 rounded-sm text-[10px] font-bold tracking-widest">#${t}</span>`).join('') : '';
            const priceText = evt.price > 0 ? `¥${evt.price.toLocaleString()}` : '無料';
            
            let locHtml = evt.isOnline 
                ? `<div class="flex items-center gap-3"><i class="fa-solid fa-laptop text-brand-400 w-4 text-center"></i><span class="tracking-widest">${evt.locationName}</span></div>
                   ${evt.onlineUrl ? `<div class="flex items-center gap-3 mt-2"><i class="fa-solid fa-link text-brand-400 w-4 text-center"></i><a href="${evt.onlineUrl}" target="_blank" class="text-blue-600 underline truncate tracking-widest text-xs">${evt.onlineUrl}</a></div>` : ''}`
                : `<div class="flex items-center gap-3"><i class="fa-solid fa-location-dot text-brand-400 w-4 text-center"></i><span class="tracking-widest">${evt.locationName}</span></div>`;

            content.innerHTML = `
                <div class="relative h-48 w-full rounded-sm overflow-hidden mb-4 shadow-sm border border-brand-200">
                    <img src="${thumb}" class="w-full h-full object-cover">
                    <div class="absolute top-2 right-2 bg-[#3e2723]/80 backdrop-blur text-[#d4af37] px-3 py-1 rounded-sm text-xs font-bold tracking-widest border border-[#b8860b] shadow-sm">${priceText}</div>
                </div>
                <h2 class="text-xl font-bold text-brand-900 leading-tight mb-3 font-serif tracking-widest">${evt.title}</h2>
                <div class="flex flex-wrap gap-2 mb-5">${tags}</div>
                <div class="space-y-3 text-xs text-brand-800 bg-[#fffdf9] p-4 rounded-sm mb-5 border border-brand-200 shadow-sm relative">
                    <div class="absolute top-0 right-0 w-6 h-6 border-t border-r border-brand-300 m-1"></div>
                    <div class="flex items-center gap-3"><i class="fa-regular fa-clock text-brand-400 w-4 text-center"></i><span class="tracking-widest">${evt.startDate} ${evt.startTime} 〜</span></div>
                    ${locHtml}
                    <div class="flex items-center gap-3 pt-2 border-t border-brand-100"><i class="fa-solid fa-user text-brand-400 w-4 text-center"></i><a href="user.html?uid=${evt.organizerId}" class="text-brand-600 font-bold hover:underline tracking-widest">主催: ${evt.organizerName}</a></div>
                </div>
                <div class="mb-6"><h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">詳細</h3><p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide">${evt.description || ''}</p></div>
                <div class="mb-6"><h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">参加者</h3>${partsHtml}</div>
                <button onclick="alert('参加登録処理は開発中です。')" class="w-full py-3.5 rounded-sm font-bold tracking-widest shadow-md transition-colors bg-[#3e2723] text-[#d4af37] border border-[#b8860b] hover:bg-[#2a1a17]">航海に参加する</button>
            `;

            sheet.classList.remove('hidden', 'sheet-closed');
            sheet.classList.add('sheet-open');
        };

        window.showJobSheet = (job) => {
            const sheet = document.getElementById('job-sheet');
            const content = document.getElementById('job-sheet-content');
            
            const badgeColor = job.type === '正社員' ? 'bg-[#3e2723] text-[#d4af37]' : 'bg-brand-50 text-brand-600 border border-brand-200';

            content.innerHTML = `
                <div class="flex items-start gap-3 mb-4 mt-2">
                    <div class="w-12 h-12 rounded-sm bg-brand-100 overflow-hidden flex-shrink-0 border border-brand-200">
                        ${job.organizerAvatar ? `<img src="${job.organizerAvatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-brand-400"><i class="fa-solid fa-building"></i></div>`}
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-brand-900 leading-tight font-serif tracking-widest mb-1">${job.title}</h2>
                        <span class="inline-block px-2 py-0.5 text-[10px] font-bold rounded-sm tracking-widest ${badgeColor}">${job.type}</span>
                        <span class="text-[10px] text-brand-500 ml-2 tracking-widest">${job.category}</span>
                    </div>
                </div>

                <div class="bg-[#f7f5f0] border border-brand-200 p-4 rounded-sm mb-6 space-y-3 text-xs tracking-widest text-brand-800 shadow-inner">
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">報酬</span><span class="font-bold">${job.rewardType}: ${job.rewardAmount || '応相談'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">働き方</span><span>${job.workStyle}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">勤務地</span><span>${job.location || '-'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">期間</span><span>${job.period || '-'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">締切</span><span>${job.deadline || '未定'}</span></div>
                    <div class="flex justify-between"><span class="text-brand-500 font-bold">掲載元</span><span><a href="user.html?uid=${job.organizerId}" class="hover:underline">${job.company || job.organizerName}</a></span></div>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">業務内容詳細</h3>
                    <p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide bg-[#fffdf9] p-3 border border-brand-100 rounded-sm">${job.desc}</p>
                </div>
                
                ${job.skills ? `
                <div class="mb-6">
                    <h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">必須・歓迎条件</h3>
                    <p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide bg-[#fffdf9] p-3 border border-brand-100 rounded-sm">${job.skills}</p>
                </div>` : ''}

                <div class="bg-brand-50 border border-brand-200 p-3 rounded-sm text-center mb-6">
                    <p class="text-[10px] text-brand-600 font-bold tracking-widest"><i class="fa-solid fa-circle-info mr-1"></i> 応募機能は現在開発中です。募集者へ直接コンタクトを取ってください。</p>
                </div>

                <a href="user.html?uid=${job.organizerId}" class="block w-full text-center py-3.5 rounded-sm font-bold tracking-widest shadow-md transition-colors bg-[#3e2723] text-[#d4af37] border border-[#b8860b] hover:bg-[#2a1a17]">掲載者のプロフィールを見る</a>
            `;

            sheet.classList.remove('hidden', 'sheet-closed');
            sheet.classList.add('sheet-open');
        };

        window.closeDetail = (type) => {
            const sheet = document.getElementById(`${type}-sheet`);
            sheet.classList.remove('sheet-open');
            sheet.classList.add('sheet-closed');
            setTimeout(() => sheet.classList.add('hidden'), 300);
        };

        // Dummy filter toggles to prevent errors
        window.toggleFilters = () => { alert('フィルター機能は準備中です'); };

        window.handleLogout = () => {
            if (isAdminMock) localStorage.removeItem('isAdminMock');
            signOut(auth);
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>
