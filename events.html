<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>航海と仕事 | NOAH</title>
    <link rel="icon" href="img/icon.png">
    
    <!-- Google Fonts: Noto Serif JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['Noto Serif JP', 'serif'] },
                    colors: { 
                        brand: { 
                            50: '#f7f5f0',   // bg
                            100: '#e8dfd1',  // border light
                            200: '#dcd4c6',  // border medium
                            300: '#c8b9a6',  // border dark
                            400: '#a09080',  // text muted
                            500: '#8b6a4f',  // accent
                            600: '#725b3f',  // accent hover
                            700: '#5c4a3d',  // text body
                            800: '#4a3b32',  // text heading
                            900: '#3e2723'   // text dark
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Serif JP', serif;
            background-color: #f7f5f0; 
            color: #4a3b32;
            overflow: hidden;
        }
        
        .bg-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        .glass-header {
            background: rgba(255, 253, 249, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* View Areas */
        #view-map { height: calc(100vh - 120px); width: 100%; z-index: 0; }
        #view-list-events, #view-list-jobs { 
            height: calc(100vh - 120px - env(safe-area-inset-bottom)); 
            overflow-y: auto; 
            padding-bottom: 6rem;
        }

        /* Bottom Nav Safe Area */
        .pb-safe-bottom { padding-bottom: calc(4.5rem + env(safe-area-inset-bottom)); }
        
        .bottom-nav-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fffdf9;
            border-top: 1px solid #e8dfd1;
            z-index: 1900;
            height: 4rem;
            height: calc(4rem + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .bottom-nav-content {
            height: 4rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }

        /* Detail Sheet */
        .detail-sheet { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .sheet-open { transform: translateY(0%) !important; }
        .sheet-closed { transform: translateY(100%); }

        /* Tag Selection */
        .tag-btn.selected { 
            background-color: #8b6a4f !important; 
            color: #fffdf9 !important; 
            border-color: #8b6a4f !important; 
        }

        /* フィルター内のタグチェックボックス */
        .event-filter-tag:checked + div {
            background-color: #8b6a4f !important;
            border-color: #8b6a4f !important;
            color: #fffdf9 !important;
        }

        /* Forms */
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #8b6a4f !important;
            box-shadow: 0 0 0 1px #8b6a4f !important;
        }

        /* Accordion in Modals */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: slideDown 0.3s ease-in-out; }
        @keyframes slideDown { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } }
        .accordion-arrow { transition: transform 0.2s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }

        /* View Tab Active State */
        .tab-btn.active {
            background-color: #3e2723 !important;
            color: #d4af37 !important;
            border-color: #b8860b !important;
        }

        /* Create Menu Anim */
        #create-menu { transition: opacity 0.2s, transform 0.2s; transform-origin: bottom right; }
        .menu-open { opacity: 1; transform: scale(1); pointer-events: auto; }
        .menu-closed { opacity: 0; transform: scale(0.9); pointer-events: none; }

    </style>
</head>
<body class="antialiased h-screen w-screen relative flex flex-col bg-texture">

    <!-- Navbar -->
    <nav class="glass-header border-b border-brand-200 fixed w-full z-[1500] top-0 h-16 shadow-sm bg-texture">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center relative z-10">
            <div class="flex items-center gap-4">
                <a href="events.html" class="text-xl font-black text-brand-900 tracking-widest flex items-center gap-2 font-serif">
                    <span class="bg-brand-900 text-brand-50 w-8 h-8 flex items-center justify-center rounded-sm text-sm"><i class="fa-solid fa-anchor"></i></span>
                    <span class="hidden sm:inline">NOAH</span>
                </a>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-3">
                <!-- PC Navigation Links -->
                <div class="hidden lg:flex items-center gap-6 mr-4">
                    <a href="home.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-ship"></i> 航海(ホーム)</a>
                    <a href="events.html" class="text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-hourglass-half"></i> イベント・仕事</a>
                    <a href="search.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-compass"></i> さがす</a>
                    <a href="user.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-user"></i> マイページ</a>
                </div>

                <a href="notifications.html" class="p-2 text-brand-300 hover:text-brand-600 transition-colors relative" title="通知">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <span class="hidden absolute top-1.5 right-1.5 h-2.5 w-2.5 bg-[#8b6a4f] rounded-full border-2 border-[#fffdf9]"></span>
                </a>

                <div class="h-6 w-px bg-brand-200 mx-1 hidden lg:block"></div>
                <button onclick="handleLogout()" class="hidden lg:flex text-sm font-bold text-brand-400 hover:text-red-800 transition-colors flex items-center gap-2">
                    <span class="hidden sm:inline tracking-widest">下船する</span>
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Top View Tabs -->
    <div class="fixed top-16 w-full z-[1400] bg-[#fffdf9]/95 backdrop-blur border-b border-brand-200 py-2 shadow-sm">
        <div class="max-w-3xl mx-auto px-4 flex justify-between items-center">
            <div class="inline-flex bg-brand-50 border border-brand-200 rounded-sm p-1 shadow-inner w-full sm:w-auto">
                <button onclick="switchView('map')" id="tab-map" class="tab-btn active flex-1 sm:flex-none px-3 sm:px-5 py-2 text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1">
                    <i class="fa-solid fa-map-location-dot"></i> マップ
                </button>
                <button onclick="switchView('list-events')" id="tab-list-events" class="tab-btn flex-1 sm:flex-none px-3 sm:px-5 py-2 text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1">
                    <i class="fa-solid fa-list"></i> イベント
                </button>
                <button onclick="switchView('list-jobs')" id="tab-list-jobs" class="tab-btn flex-1 sm:flex-none px-3 sm:px-5 py-2 text-xs font-bold text-brand-700 hover:text-brand-900 rounded-sm transition-colors tracking-widest font-serif flex items-center justify-center gap-1 relative">
                    <i class="fa-solid fa-briefcase"></i> 仕事・依頼
                </button>
            </div>
            <!-- Filter Button (Common) -->
            <button onclick="toggleFilters()" class="ml-3 p-2 bg-[#fffdf9] border border-brand-200 text-brand-600 hover:bg-brand-50 rounded-sm transition-colors relative shadow-sm flex-shrink-0" title="絞り込み">
                <i class="fa-solid fa-sliders"></i>
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="mt-[120px] w-full h-full relative z-0">
        
        <!-- View 1: Map -->
        <div id="view-map" class="block relative h-full">
            <!-- Search in Map -->
            <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-[1000] w-[90%] max-w-md pointer-events-none">
                <div class="relative flex-1 shadow-lg rounded-sm pointer-events-auto border border-brand-200">
                    <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 transform -translate-y-1/2 text-brand-400"></i>
                    <input type="text" id="map-search-input" placeholder="イベントや仕事を検索..." 
                        class="w-full bg-[#fffdf9]/95 backdrop-blur border-none rounded-sm py-3 pl-11 pr-4 text-sm focus:ring-2 focus:ring-brand-500 shadow-sm font-serif tracking-widest">
                </div>
            </div>

            <div id="map" class="w-full h-full"></div>
            
            <!-- Location Adjustment UI inside Map View -->
            <div id="adjust-location-ui" class="hidden fixed bottom-[calc(6rem+env(safe-area-inset-bottom))] lg:bottom-10 left-1/2 transform -translate-x-1/2 z-[9999] w-[90%] max-w-sm pointer-events-auto">
                <div class="bg-[#fffdf9] p-5 rounded-sm shadow-2xl border-2 border-brand-500 text-center text-brand-900 font-serif">
                    <p class="font-bold mb-3 tracking-widest text-sm"><i class="fa-solid fa-thumbtack text-red-500 mr-2 text-lg"></i>赤色のピンを動かして調整</p>
                    <button onclick="finishLocationAdjust()" class="w-full bg-[#3e2723] text-[#d4af37] font-bold py-3 rounded-sm shadow-md tracking-widest text-sm hover:bg-[#2a1a17] border border-[#b8860b]">
                        位置を決定して戻る
                    </button>
                </div>
            </div>
        </div>

        <!-- View 2: Event List -->
        <div id="view-list-events" class="hidden max-w-4xl mx-auto px-4 pt-6">
            <div class="flex justify-between items-end mb-6 border-b border-brand-200 pb-2">
                <h2 class="text-xl font-bold text-brand-900 font-serif tracking-widest">イベント一覧</h2>
                <span id="event-list-status" class="text-xs text-brand-500 tracking-widest">現在地から近い順</span>
            </div>
            
            <div id="event-list-loading" class="text-center py-10 text-brand-400">
                <i class="fa-solid fa-compass fa-spin text-2xl mb-3 opacity-70"></i>
                <p class="text-xs tracking-widest font-bold">航海図を読み込み中...</p>
            </div>
            
            <div id="event-list-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                <!-- List injected here -->
            </div>
            
            <div id="event-list-empty" class="text-center py-10 text-brand-400 hidden">
                <i class="fa-solid fa-anchor-circle-xmark text-3xl mb-3 opacity-50"></i>
                <p class="text-sm font-bold tracking-widest">条件に合うイベントが見つかりません。</p>
            </div>
        </div>

        <!-- View 3: Job List -->
        <div id="view-list-jobs" class="hidden max-w-4xl mx-auto px-4 pt-6">
            <div class="flex justify-between items-end mb-6 border-b border-brand-200 pb-2">
                <h2 class="text-xl font-bold text-brand-900 font-serif tracking-widest">仕事・依頼一覧</h2>
                <span class="text-xs text-brand-500 tracking-widest">新着順</span>
            </div>
            
            <div id="job-list-loading" class="text-center py-10 text-brand-400">
                <i class="fa-solid fa-compass fa-spin text-2xl mb-3 opacity-70"></i>
                <p class="text-xs tracking-widest font-bold">依頼書を探しています...</p>
            </div>
            
            <div id="job-list-container" class="space-y-4 hidden">
                <!-- List injected here -->
            </div>
            
            <div id="job-list-empty" class="text-center py-10 text-brand-400 hidden">
                <i class="fa-solid fa-anchor-circle-xmark text-3xl mb-3 opacity-50"></i>
                <p class="text-sm font-bold tracking-widest">条件に合う仕事・依頼が見つかりません。</p>
            </div>
        </div>

    </div>

    <!-- Create FAB & Menu -->
    <div class="fixed bottom-[calc(5.5rem+env(safe-area-inset-bottom))] lg:bottom-10 right-5 z-[2000] flex flex-col items-end">
        <!-- Floating Menu -->
        <div id="create-menu" class="menu-closed mb-3 bg-[#fffdf9] border border-brand-300 shadow-xl rounded-sm p-2 flex flex-col gap-1 w-48">
            <button onclick="openCreateModal('event')" class="text-left px-3 py-3 hover:bg-brand-50 rounded-sm text-sm font-bold text-brand-900 tracking-widest border-b border-brand-100 flex items-center justify-between">
                <span><i class="fa-solid fa-champagne-glasses text-brand-500 w-5"></i> イベントを企画</span>
            </button>
            <button onclick="openCreateModal('job')" class="text-left px-3 py-3 hover:bg-brand-50 rounded-sm text-sm font-bold text-brand-900 tracking-widest flex items-center justify-between group">
                <span><i class="fa-solid fa-briefcase text-blue-500 w-5"></i> 仕事・依頼を掲載</span>
                <i class="fa-solid fa-lock text-brand-300 text-xs group-hover:text-brand-500" title="BUILDER以上限定"></i>
            </button>
        </div>
        <!-- FAB (ALWAYS SHOW) -->
        <button id="create-fab-btn" onclick="toggleCreateMenu()" class="hidden w-14 h-14 bg-[#3e2723] text-[#d4af37] rounded-full shadow-2xl flex items-center justify-center hover:bg-[#2a1a17] hover:scale-105 transition-all border-2 border-[#b8860b]">
            <i class="fa-solid fa-plus text-xl transition-transform duration-300" id="fab-icon"></i>
        </button>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="fixed top-0 left-0 w-full h-full bg-[#2a1a17]/50 z-[3000] hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute right-0 top-0 h-full w-80 sm:w-96 bg-[#fffdf9] bg-texture shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col border-l border-brand-200" id="filter-content">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center bg-[#fffdf9] z-10 relative">
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-200 to-transparent opacity-50"></div>
                <h3 class="font-bold text-lg flex items-center gap-2 text-brand-900 font-serif tracking-widest">
                    <i class="fa-solid fa-filter text-brand-500 text-sm"></i> <span id="filter-title">絞り込み</span>
                </h3>
                <button onclick="toggleFilters()" class="p-2 text-brand-400 hover:text-brand-700 rounded-sm hover:bg-brand-50 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <!-- Event Filters Section -->
            <div id="filter-section-event" class="flex-1 overflow-y-auto p-5 space-y-6">
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-regular fa-calendar mr-1"></i>開催時期</label>
                    <select id="filter-event-date" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="all">すべて</option>
                        <option value="today">今日</option>
                        <option value="week">1週間以内</option>
                        <option value="month">1ヶ月以内</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-location-dot mr-1"></i>開催形式</label>
                    <select id="filter-event-format" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="all">すべて</option>
                        <option value="offline">オフライン（現地）のみ</option>
                        <option value="online">オンラインのみ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-yen-sign mr-1"></i>参加費</label>
                    <select id="filter-event-price" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="all">すべて</option>
                        <option value="free">無料のみ</option>
                        <option value="paid">有料のみ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-3"><i class="fa-solid fa-tags mr-1"></i>タグで絞り込み</label>
                    <div id="filter-event-tags" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Job Filters Section -->
            <div id="filter-section-job" class="flex-1 overflow-y-auto p-5 space-y-6 hidden">
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-file-contract mr-1"></i>募集タイプ</label>
                    <select id="filter-job-type" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="">指定なし</option>
                        <option value="業務委託">業務委託</option>
                        <option value="正社員">正社員</option>
                        <option value="契約社員">契約社員</option>
                        <option value="アルバイト">アルバイト</option>
                        <option value="単発依頼">単発依頼</option>
                        <option value="共同事業パートナー">共同事業パートナー</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-briefcase mr-1"></i>業種カテゴリ</label>
                    <select id="filter-job-category" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="">指定なし</option>
                        <option value="デザイン">デザイン</option>
                        <option value="エンジニア">エンジニア</option>
                        <option value="マーケティング">マーケティング</option>
                        <option value="営業">営業</option>
                        <option value="動画制作">動画制作</option>
                        <option value="ライティング">ライティング</option>
                        <option value="事務・サポート">事務・サポート</option>
                        <option value="その他">その他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-building-user mr-1"></i>勤務形態</label>
                    <select id="filter-job-workstyle" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="">指定なし</option>
                        <option value="フルリモート">フルリモート</option>
                        <option value="一部出社">一部出社</option>
                        <option value="出社必須">出社必須</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-coins mr-1"></i>報酬形態</label>
                    <select id="filter-job-reward" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="">指定なし</option>
                        <option value="固定報酬">固定報酬</option>
                        <option value="時給">時給</option>
                        <option value="月給">月給</option>
                        <option value="成果報酬">成果報酬</option>
                        <option value="無償・レベニューシェア">無償・レベニューシェア</option>
                    </select>
                </div>
            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom relative z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onclick="applyFilters()" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#3e2723]">
                    絞り込みを適用
                </button>
                <button onclick="resetFilters()" class="w-full mt-3 text-sm text-brand-500 hover:text-brand-800 py-2 font-bold tracking-widest transition-colors">
                    条件をクリア
                </button>
            </div>
        </div>
    </div>


    <!-- Details Sheet (Event) -->
    <div id="event-sheet" class="detail-sheet sheet-closed fixed bottom-0 left-0 w-full z-[2100] bg-[#fffdf9] border-t border-brand-300 rounded-t-xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-safe-bottom max-h-[90vh] overflow-y-auto lg:w-[450px] lg:left-4 lg:bottom-4 lg:rounded-sm lg:border lg:max-h-[85vh] lg:pb-0 lg:transform-none lg:hidden bg-texture">
        <div class="sticky top-0 bg-[#fffdf9]/95 backdrop-blur z-20 pt-3 pb-2 flex justify-center border-b border-brand-100" onclick="closeDetail('event')">
            <div class="w-12 h-1 bg-brand-300 rounded-full lg:hidden"></div>
            <div class="hidden lg:flex w-full justify-between items-center px-4">
                <span class="text-xs font-bold text-brand-500 tracking-widest">イベント詳細</span>
                <i class="fa-solid fa-xmark text-brand-400 hover:text-brand-700 cursor-pointer text-lg"></i>
            </div>
        </div>
        <div id="event-sheet-content" class="px-5 pb-20 lg:pb-5 pt-4"></div>
    </div>

    <!-- Details Sheet (Job) -->
    <div id="job-sheet" class="detail-sheet sheet-closed fixed bottom-0 left-0 w-full z-[2100] bg-[#fffdf9] border-t border-brand-300 rounded-t-xl shadow-[0_-10px_40px_rgba(0,0,0,0.1)] pb-safe-bottom max-h-[90vh] overflow-y-auto lg:w-[450px] lg:left-4 lg:bottom-4 lg:rounded-sm lg:border lg:max-h-[85vh] lg:pb-0 lg:transform-none lg:hidden bg-texture">
        <div class="sticky top-0 bg-[#fffdf9]/95 backdrop-blur z-20 pt-3 pb-2 flex justify-center border-b border-brand-100" onclick="closeDetail('job')">
            <div class="w-12 h-1 bg-brand-300 rounded-full lg:hidden"></div>
            <div class="hidden lg:flex w-full justify-between items-center px-4">
                <span class="text-xs font-bold text-brand-500 tracking-widest">仕事・依頼 詳細</span>
                <i class="fa-solid fa-xmark text-brand-400 hover:text-brand-700 cursor-pointer text-lg"></i>
            </div>
        </div>
        <div id="job-sheet-content" class="px-5 pb-20 lg:pb-5 pt-4"></div>
    </div>

    <!-- ========================================== -->
    <!-- MODALS (Create Event / Job) -->
    <!-- ========================================== -->

    <!-- Event Create Modal -->
    <div id="event-modal" class="hidden fixed inset-0 z-[3000] bg-[#2a1a17]/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-[#fffdf9] bg-texture w-full sm:w-[600px] h-[95vh] sm:h-[90vh] rounded-t-sm sm:rounded-sm shadow-2xl flex flex-col border border-brand-300">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center flex-shrink-0 bg-[#fffdf9]">
                <h3 class="font-bold text-lg text-brand-900 font-serif tracking-widest" id="event-modal-title">イベントを企画</h3>
                <button onclick="closeCreateModal('event')" class="p-2 text-brand-400 hover:text-brand-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 space-y-6">
                <!-- Thumbnail -->
                <div>
                    <label class="block text-xs font-bold text-brand-700 mb-2 tracking-widest">サムネイル画像</label>
                    <div class="relative w-full h-40 bg-brand-50 rounded-sm border border-dashed border-brand-300 flex flex-col items-center justify-center text-brand-400 hover:bg-[#fffdf9] cursor-pointer overflow-hidden group">
                        <input type="file" id="event-image" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                        <img id="event-image-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                        <div class="group-hover:scale-110 transition-transform flex flex-col items-center">
                            <i class="fa-solid fa-image text-2xl mb-1"></i>
                            <span class="text-xs tracking-widest">画像をアップロード</span>
                        </div>
                    </div>
                </div>

                <!-- Title & Price -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-2">
                        <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">イベント名 <span class="text-red-500">*</span></label>
                        <input type="text" id="event-title" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9]" placeholder="例: 週末朝活コーヒー会" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">参加費(円)</label>
                        <input type="number" id="event-price" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9]" placeholder="無料なら0">
                    </div>
                </div>

                <!-- Date & Time -->
                <div class="bg-brand-50 p-4 rounded-sm border border-brand-200">
                    <label class="block text-xs font-bold text-brand-800 mb-3 tracking-widest">日時 <span class="text-red-500">*</span></label>
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center mb-3">
                        <span class="text-xs font-bold text-brand-500 w-10">開始</span>
                        <input type="date" id="event-start-date" class="flex-1 w-full sm:w-auto border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                        <input type="time" id="event-start-time" class="w-full sm:w-28 border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                        <span class="text-xs font-bold text-brand-500 w-10">終了</span>
                        <input type="date" id="event-end-date" class="flex-1 w-full sm:w-auto border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                        <input type="time" id="event-end-time" class="w-full sm:w-28 border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]" required>
                    </div>
                </div>

                <!-- Tags (Online trigger) -->
                <div>
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-xs font-bold text-brand-700 tracking-widest">タグを選択 <span class="text-red-500">*</span></label>
                        <span class="text-[10px] text-brand-500">※「オンライン」選択で入力枠が変わります</span>
                    </div>
                    <div class="flex flex-wrap gap-2" id="event-tag-area"></div>
                    <input type="text" id="event-custom-tags" placeholder="その他のタグ (カンマ区切り)" class="mt-2 w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                </div>

                <!-- Location / Online URL Toggle Area -->
                <div class="bg-brand-50 p-4 rounded-sm border border-brand-200 relative overflow-hidden" id="location-wrapper">
                    
                    <!-- Offline Mode -->
                    <div id="offline-location-group">
                        <label class="block text-xs font-bold text-brand-800 mb-2 tracking-widest">開催場所の設定 (オフライン) <span class="text-red-500">*</span></label>
                        <div class="flex gap-2 mb-2">
                            <div class="relative flex-1">
                                <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-brand-400"></i>
                                <input type="text" id="location-search-input" placeholder="住所や建物名で検索" class="w-full border-brand-200 rounded-sm text-sm pl-10 p-2.5 bg-[#fffdf9]">
                            </div>
                            <button onclick="searchLocation('event')" type="button" class="bg-brand-800 text-white px-4 rounded-sm text-sm font-bold whitespace-nowrap hover:bg-brand-900 tracking-widest">検索</button>
                        </div>
                        <p class="text-[10px] text-brand-500 mb-2 leading-tight">※番地や建物名でピンが立たない場合は、市区町村で検索し、地図上でピンを動かして調整してください。</p>
                        <div id="location-results" class="hidden mb-3 border border-brand-200 rounded-sm overflow-hidden max-h-40 overflow-y-auto shadow-sm bg-white"></div>
                        <button type="button" onclick="startLocationAdjust('event')" class="w-full py-2 bg-[#fffdf9] border border-brand-300 text-brand-700 rounded-sm text-xs font-bold hover:bg-brand-100 transition-colors mb-4 flex items-center justify-center gap-2 tracking-widest shadow-sm">
                            <i class="fa-solid fa-map-location-dot text-brand-500"></i> 地図を見ながら位置を微調整する
                        </button>
                        <div>
                            <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">表示する場所名</label>
                            <input type="text" id="event-location-name" placeholder="例: ミッドランドスクエア 42階" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                        </div>
                    </div>

                    <!-- Online Mode -->
                    <div id="online-url-group" class="hidden">
                        <label class="block text-xs font-bold text-brand-800 mb-2 tracking-widest">オンライン開催設定 <span class="text-red-500">*</span></label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">開催ツール (例: Zoom, Google Meet)</label>
                                <input type="text" id="event-online-tool" placeholder="Zoom" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-brand-500 mb-1 tracking-widest">参加URL</label>
                                <input type="url" id="event-online-url" placeholder="https://..." class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9]">
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">詳細・内容</label>
                    <textarea id="event-desc" rows="5" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-[#fffdf9] leading-relaxed" placeholder="イベントの魅力や詳細を書きましょう"></textarea>
                </div>

                <!-- Settings -->
                <div class="bg-[#fffdf9] p-3 rounded-sm border border-brand-200 shadow-sm">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="event-public-participants" class="w-5 h-5 text-brand-800 rounded-sm focus:ring-brand-500 border-brand-300" checked>
                        <div>
                            <span class="block text-sm font-bold text-brand-800 tracking-widest">参加者を公開する</span>
                            <span class="block text-[10px] text-brand-500 tracking-widest mt-0.5">チェックを外すと、参加者は主催者のみに見えます</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom sm:pb-4 flex-shrink-0">
                <button onclick="submitEvent()" id="event-submit-btn" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#b8860b]">
                    イベントを企画する
                </button>
            </div>
        </div>
    </div>

    <!-- Job Create Modal -->
    <div id="job-modal" class="hidden fixed inset-0 z-[3000] bg-[#2a1a17]/60 backdrop-blur-sm flex items-end sm:items-center justify-center">
        <div class="bg-[#fffdf9] bg-texture w-full sm:w-[650px] h-[95vh] sm:h-[90vh] rounded-t-sm sm:rounded-sm shadow-2xl flex flex-col border border-brand-300">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center flex-shrink-0 bg-[#fffdf9]">
                <h3 class="font-bold text-lg text-brand-900 font-serif tracking-widest">仕事・依頼を掲載</h3>
                <button onclick="closeCreateModal('job')" class="p-2 text-brand-400 hover:text-brand-700"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-5 overflow-y-auto flex-1 space-y-4" id="job-form-container">
                <p class="text-xs text-brand-600 font-bold tracking-widest mb-2"><i class="fa-solid fa-circle-info mr-1"></i> 情報を詳細に記載するとマッチング率が上がります</p>
                
                <!-- Accordion 1: 基本情報 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm" open>
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">1. 基本情報 (必須)</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">募集タイトル</label>
                            <input type="text" id="job-title" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="例: 新規事業のUI/UXデザイナー募集" required>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">募集タイプ</label>
                                <select id="job-type" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" required>
                                    <option value="業務委託">業務委託</option>
                                    <option value="正社員">正社員</option>
                                    <option value="契約社員">契約社員</option>
                                    <option value="アルバイト">アルバイト</option>
                                    <option value="単発依頼">単発依頼</option>
                                    <option value="共同事業パートナー">共同事業パートナー</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">業種カテゴリ</label>
                                <select id="job-category" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" required>
                                    <option value="デザイン">デザイン</option>
                                    <option value="エンジニア">エンジニア</option>
                                    <option value="マーケティング">マーケティング</option>
                                    <option value="営業">営業</option>
                                    <option value="動画制作">動画制作</option>
                                    <option value="ライティング">ライティング</option>
                                    <option value="事務・サポート">事務・サポート</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">業務内容詳細</label>
                            <textarea id="job-desc" rows="6" class="w-full border-brand-200 rounded-sm text-sm p-3 bg-white leading-relaxed" placeholder="背景・具体的な作業内容・期待する成果などを詳しく記載してください" required></textarea>
                        </div>
                    </div>
                </details>

                <!-- Accordion 2: 報酬・期間・条件 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">2. 報酬・期間・働き方</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">報酬形態</label>
                                <select id="job-reward-type" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="固定報酬">固定報酬</option>
                                    <option value="時給">時給</option>
                                    <option value="月給">月給</option>
                                    <option value="成果報酬">成果報酬</option>
                                    <option value="無償・レベニューシェア">無償・レベニューシェア</option>
                                    <option value="応相談">応相談</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">金額・レンジ(円等)</label>
                                <input type="text" id="job-reward-amount" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="例: 100,000〜300,000">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">契約期間</label>
                                <select id="job-period" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="単発">単発</option>
                                    <option value="1ヶ月">1ヶ月</option>
                                    <option value="3ヶ月">3ヶ月</option>
                                    <option value="長期">長期</option>
                                    <option value="期間未定">期間未定</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">勤務形態</label>
                                <select id="job-work-style" onchange="toggleJobLocationUI()" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="フルリモート">フルリモート</option>
                                    <option value="一部出社">一部出社</option>
                                    <option value="出社必須">出社必須</option>
                                    <option value="指定なし">指定なし</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Job Location UI -->
                        <div id="job-location-wrapper" class="hidden p-3 border border-brand-200 rounded-sm bg-white">
                            <label class="block text-[10px] font-bold text-brand-500 mb-2 tracking-widest">勤務地・活動場所をマップに設定 <span class="text-red-500">*</span></label>
                            <div class="flex gap-2 mb-2">
                                <div class="relative flex-1">
                                    <i class="fa-solid fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-brand-300 text-xs"></i>
                                    <input type="text" id="job-location-search-input" placeholder="住所検索" class="w-full border-brand-200 rounded-sm text-xs pl-7 p-2 bg-brand-50">
                                </div>
                                <button onclick="searchLocation('job')" type="button" class="bg-brand-600 text-white px-3 rounded-sm text-xs font-bold whitespace-nowrap hover:bg-brand-700">検索</button>
                            </div>
                            <div id="job-location-results" class="hidden mb-2 border border-brand-200 rounded-sm overflow-hidden max-h-32 overflow-y-auto shadow-sm bg-white"></div>
                            <button type="button" onclick="startLocationAdjust('job')" class="w-full py-1.5 bg-brand-50 border border-brand-200 text-brand-700 rounded-sm text-[10px] font-bold hover:bg-brand-100 transition-colors mb-2 flex items-center justify-center gap-1">
                                <i class="fa-solid fa-map-location-dot text-brand-500"></i> 地図で微調整する
                            </button>
                            <div>
                                <label class="block text-[10px] text-brand-500 mb-1">表示用テキスト</label>
                                <input type="text" id="job-location-name" class="w-full border-brand-200 rounded-sm text-xs p-2 bg-brand-50" placeholder="例: 東京都渋谷区">
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Accordion 3: 応募条件・フロー -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">3. 応募条件・選考フロー</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">必須・歓迎スキル</label>
                            <textarea id="job-skills" rows="3" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white leading-relaxed" placeholder="Figma実務経験2年以上、等"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">応募締切日</label>
                                <input type="date" id="job-deadline" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">選考フロー</label>
                                <select id="job-flow" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                                    <option value="面談1回">面談1回</option>
                                    <option value="書類選考 → 面接">書類選考 → 面接</option>
                                    <option value="即決">即決</option>
                                    <option value="その他">その他</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Accordion 4: 投稿者情報 -->
                <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                    <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                        <span class="font-bold text-sm text-brand-800 tracking-widest">4. 投稿者・会社情報</span>
                        <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                    </summary>
                    <div class="p-4 border-t border-brand-100 bg-brand-50 space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">会社・団体名 (任意)</label>
                            <input type="text" id="job-company" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-brand-700 mb-1 tracking-widest">公式サイト等 URL</label>
                            <input type="url" id="job-url" class="w-full border-brand-200 rounded-sm text-sm p-2 bg-white" placeholder="https://...">
                        </div>
                    </div>
                </details>

            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom sm:pb-4 flex-shrink-0">
                <button onclick="submitJob()" id="job-submit-btn" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#b8860b]">
                    募集を掲載する
                </button>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 w-full bg-[#fffdf9] border-t border-brand-200 lg:hidden z-[1900] safe-area-pb shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="flex justify-around items-center h-16">
            <a href="home.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-ship text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">航海</span>
            </a>
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600 transition-colors border-t-2 border-brand-500 pt-[2px]">
                <i class="fa-solid fa-hourglass-half text-xl mb-1"></i>
                <span class="text-[10px] font-bold tracking-widest">イベント</span>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-compass text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">さがす</span>
            </a>
            <button onclick="alert('マッチング機能は準備中です。\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-brand-300 hover:text-brand-500 transition-colors">
                <i class="fa-solid fa-handshake text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">マッチ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">マイページ</span>
            </a>
        </div>
    </nav>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        // ▼▼▼▼ Firebase Config ▼▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = 'default-app-id';

        let map;
        let markers = [];
        let allEvents = [];
        let allJobs = [];
        let currentUser = null;
        let myProfile = null;
        let userLocation = null; 
        
        let currentViewMode = 'map'; 

        // Form States
        let tempMarker = null; 
        let selectedCoordsEvent = null;
        let selectedCoordsJob = null;
        let currentAdjustType = null; 

        let selectedTags = new Set();
        let isJoining = false;
        let editingEventId = null;

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';
        const presetTags = ["交流会", "勉強会", "スポーツ", "音楽", "アート", "グルメ", "アウトドア", "ビジネス", "初心者歓迎", "オンライン"];
        
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        const blueIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            renderEventTagButtons();
            initFilterOptions();
            
            // Search Input Binding
            const pcSearch = document.getElementById('pc-map-search');
            const mobileSearch = document.getElementById('map-search-input');
            const handleSearch = (e) => {
                const val = e.target.value;
                if(pcSearch && pcSearch.value !== val) pcSearch.value = val;
                if(mobileSearch && mobileSearch.value !== val) mobileSearch.value = val;
                filterData();
            };
            if(pcSearch) pcSearch.addEventListener('input', handleSearch);
            if(mobileSearch) mobileSearch.addEventListener('input', handleSearch);

            const startDateInput = document.getElementById('event-start-date');
            const endDateInput = document.getElementById('event-end-date');
            if(startDateInput && endDateInput){
                startDateInput.addEventListener('change', () => {
                    if (!endDateInput.value) endDateInput.value = startDateInput.value;
                });
            }
            
            const eventImageInput = document.getElementById('event-image');
            if(eventImageInput) {
                eventImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const img = document.getElementById('event-image-preview');
                            if(img){
                                img.src = ev.target.result;
                                img.classList.remove('hidden');
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid' };
                document.getElementById('create-fab-btn').classList.remove('hidden');
                myProfile = { name: '管理者', userId: 'admin', membershipRank: 'covenant' };
                loadAllData();
                return;
            }

            if (user) {
                currentUser = user;
                try {
                    const docSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                    if (docSnap.exists()) {
                        myProfile = docSnap.data();
                        const rank = myProfile.membershipRank || 'arrival';
                        if (rank !== 'arrival') {
                            const fab = document.getElementById('create-fab-btn');
                            if(fab) fab.classList.remove('hidden');
                        }
                    } else {
                        myProfile = { membershipRank: 'arrival' };
                    }
                } catch (e) { 
                    console.error("Profile Fetch Error:", e); 
                    myProfile = { membershipRank: 'arrival' };
                }
                loadAllData();
            } else {
                window.location.href = 'login.html';
            }
        });

        // ==========================================
        // View Switcher & Core Load
        // ==========================================
        window.switchView = (viewName) => {
            currentViewMode = viewName;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-[#3e2723]', 'text-[#d4af37]', 'border-[#b8860b]');
                btn.classList.add('bg-[#fffdf9]', 'text-brand-700', 'border-transparent');
            });
            const activeBtn = document.getElementById(`tab-${viewName}`);
            if(activeBtn) {
                activeBtn.classList.remove('bg-[#fffdf9]', 'text-brand-700', 'border-transparent');
                activeBtn.classList.add('active', 'bg-[#3e2723]', 'text-[#d4af37]', 'border-[#b8860b]');
            }

            document.getElementById('view-map').classList.add('hidden');
            document.getElementById('view-list-events').classList.add('hidden');
            document.getElementById('view-list-jobs').classList.add('hidden');

            const viewEl = document.getElementById(`view-${viewName}`);
            if(viewEl) viewEl.classList.remove('hidden');

            if (viewName === 'map' && map) setTimeout(() => map.invalidateSize(), 100);
            
            const placeholderText = viewName === 'list-jobs' ? "仕事や依頼を検索..." : "イベントや仕事を検索...";
            const pcSearch = document.getElementById('pc-map-search');
            const mapSearch = document.getElementById('map-search-input');
            if(pcSearch) pcSearch.placeholder = placeholderText;
            if(mapSearch) mapSearch.placeholder = placeholderText;
        };

        async function loadAllData() {
            const evLoad = document.getElementById('event-list-loading');
            const jobLoad = document.getElementById('job-list-loading');
            const evCont = document.getElementById('event-list-container');
            const jobCont = document.getElementById('job-list-container');
            const evEmp = document.getElementById('event-list-empty');
            const jobEmp = document.getElementById('job-list-empty');

            if(evLoad) evLoad.classList.remove('hidden');
            if(jobLoad) jobLoad.classList.remove('hidden');
            if(evCont) evCont.classList.add('hidden');
            if(jobCont) jobCont.classList.add('hidden');
            if(evEmp) evEmp.classList.add('hidden');
            if(jobEmp) jobEmp.classList.add('hidden');

            try {
                await loadEvents();
            } catch(e) { console.error("Event error:", e); }
            
            try {
                await loadJobs();
            } catch(e) { console.error("Job error:", e); }
            
            filterData();
        }

        // ==========================================
        // Filter Logic
        // ==========================================
        function initFilterOptions() {
            const container = document.getElementById('filter-event-tags');
            if(!container) return;
            presetTags.forEach(tag => {
                const label = document.createElement('label');
                label.className = 'cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${tag}" class="event-filter-tag hidden">
                    <div class="px-2 py-1 rounded-sm border border-brand-200 text-xs text-brand-700 hover:bg-[#fffdf9] transition-colors select-none tracking-widest shadow-sm bg-white">${tag}</div>
                `;
                container.appendChild(label);
            });
        }

        window.toggleFilters = () => {
            const panel = document.getElementById('filter-panel');
            const content = document.getElementById('filter-content');
            
            const eventSec = document.getElementById('filter-section-event');
            const jobSec = document.getElementById('filter-section-job');
            const title = document.getElementById('filter-title');
            
            if (currentViewMode === 'list-jobs') {
                if(eventSec) eventSec.classList.add('hidden');
                if(jobSec) jobSec.classList.remove('hidden');
                if(title) title.textContent = '仕事・依頼の絞り込み';
            } else {
                if(eventSec) eventSec.classList.remove('hidden');
                if(jobSec) jobSec.classList.add('hidden');
                if(title) title.textContent = 'イベントの絞り込み';
            }

            if (panel && panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => { 
                    panel.classList.remove('opacity-0'); 
                    if(content) content.classList.remove('translate-x-full'); 
                }, 10);
            } else if(panel) {
                panel.classList.add('opacity-0');
                if(content) content.classList.add('translate-x-full');
                setTimeout(() => panel.classList.add('hidden'), 300);
            }
        };

        window.applyFilters = () => {
            filterData(); 
            toggleFilters();
        };

        window.resetFilters = () => {
            try {
                if (currentViewMode === 'list-jobs') {
                    const jobType = document.getElementById('filter-job-type');
                    const jobCat = document.getElementById('filter-job-category');
                    const jobWorkstyle = document.getElementById('filter-job-workstyle');
                    const jobReward = document.getElementById('filter-job-reward');
                    if(jobType) jobType.value = "";
                    if(jobCat) jobCat.value = "";
                    if(jobWorkstyle) jobWorkstyle.value = "";
                    if(jobReward) jobReward.value = "";
                } else {
                    const evDate = document.getElementById('filter-event-date');
                    const evFormat = document.getElementById('filter-event-format');
                    const evPrice = document.getElementById('filter-event-price');
                    if(evDate) evDate.value = "all";
                    if(evFormat) evFormat.value = "all";
                    if(evPrice) evPrice.value = "all";
                    document.querySelectorAll('.event-filter-tag').forEach(cb => cb.checked = false);
                }
                const pcSearch = document.getElementById('pc-map-search');
                const mapSearch = document.getElementById('map-search-input');
                if(pcSearch) pcSearch.value = "";
                if(mapSearch) mapSearch.value = "";
                
                filterData();
                toggleFilters();
            } catch(e){
                console.error("Reset Filters Error: ", e);
            }
        };

        function filterData() {
            try {
                const pcSearchEl = document.getElementById('pc-map-search');
                const moSearchEl = document.getElementById('map-search-input');
                const term = ((pcSearchEl ? pcSearchEl.value : '') || (moSearchEl ? moSearchEl.value : '')).toLowerCase();
                
                // --- Event Filter ---
                const dateValEl = document.getElementById('filter-event-date');
                const formatValEl = document.getElementById('filter-event-format');
                const priceValEl = document.getElementById('filter-event-price');
                
                const dateVal = dateValEl ? dateValEl.value : 'all';
                const formatVal = formatValEl ? formatValEl.value : 'all';
                const priceVal = priceValEl ? priceValEl.value : 'all';
                const selectedTagsArr = Array.from(document.querySelectorAll('.event-filter-tag:checked')).map(cb => cb.value);

                const now = new Date();
                const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const nextMonth = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

                const filteredEvents = allEvents.filter(evt => {
                    const title = evt.title || '';
                    const desc = evt.description || evt.desc || '';
                    const matchTerm = !term || title.toLowerCase().includes(term) || desc.toLowerCase().includes(term);
                    
                    let matchDate = true;
                    if (dateVal !== 'all' && evt.startDate) {
                        const evtDate = new Date(evt.startDate);
                        if (dateVal === 'today') {
                            const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
                            matchDate = (evt.startDate === todayStr);
                        }
                        else if (dateVal === 'week') matchDate = (!isNaN(evtDate) && evtDate <= nextWeek);
                        else if (dateVal === 'month') matchDate = (!isNaN(evtDate) && evtDate <= nextMonth);
                    }

                    let matchFormat = true;
                    if (formatVal === 'offline') matchFormat = !evt.isOnline;
                    if (formatVal === 'online') matchFormat = !!evt.isOnline;

                    let matchPrice = true;
                    const priceNum = Number(evt.price || 0);
                    if (priceVal === 'free') matchPrice = (priceNum === 0);
                    if (priceVal === 'paid') matchPrice = (priceNum > 0);

                    const matchTags = selectedTagsArr.length === 0 || (evt.tags && selectedTagsArr.every(tag => evt.tags.includes(tag)));

                    return matchTerm && matchDate && matchFormat && matchPrice && matchTags;
                });

                // --- Job Filter ---
                const typeEl = document.getElementById('filter-job-type');
                const catEl = document.getElementById('filter-job-category');
                const styleEl = document.getElementById('filter-job-workstyle');
                const rewEl = document.getElementById('filter-job-reward');

                const type = typeEl ? typeEl.value : '';
                const cat = catEl ? catEl.value : '';
                const style = styleEl ? styleEl.value : '';
                const rew = rewEl ? rewEl.value : '';

                const filteredJobs = allJobs.filter(job => {
                    const title = job.title || '';
                    const desc = job.desc || '';
                    const matchTerm = !term || title.toLowerCase().includes(term) || desc.toLowerCase().includes(term);
                    const matchType = !type || job.type === type;
                    const matchCat = !cat || job.category === cat;
                    const matchStyle = !style || job.workStyle === style;
                    const matchRew = !rew || job.rewardType === rew;
                    return matchTerm && matchType && matchCat && matchStyle && matchRew;
                });

                renderMarkers(filteredEvents, filteredJobs);
                renderEventList(filteredEvents);
                renderJobList(filteredJobs);
            } catch(e) {
                console.error("Filter Data Error: ", e);
            }
        }

        // ==========================================
        // Map & Event List Logic
        // ==========================================
        function initMap() {
            const mapEl = document.getElementById('map');
            if(!mapEl) return;

            map = L.map('map', { zoomControl: false }).setView([35.6895, 139.6917], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        map.setView([userLocation.lat, userLocation.lng], 13);
                        filterData(); 
                    },
                    (error) => {
                        console.log("Location access denied or error");
                        filterData(); 
                    }
                );
            } else {
                filterData();
            }
        }

        async function loadEvents() {
            const nowIso = new Date().toISOString(); 
            const eventsRef = collection(db, 'artifacts', appId, 'public', 'data', 'events');
            
            try {
                const snapshot = await getDocs(eventsRef);
                allEvents = [];
                
                const safeGetTime = (createdAt) => {
                    if (!createdAt) return 0;
                    if (createdAt.toMillis) return createdAt.toMillis();
                    return new Date(createdAt).getTime() || 0;
                };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    if (data.endTimestamp && data.endTimestamp < nowIso) return; 
                    allEvents.push(data);
                });

                allEvents.sort((a, b) => safeGetTime(b.createdAt) - safeGetTime(a.createdAt));
            } catch (e) {
                console.error("Event Load Error:", e);
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function renderEventList(eventsToRender) {
            const container = document.getElementById('event-list-container');
            const emptyMsg = document.getElementById('event-list-empty');
            const loadingMsg = document.getElementById('event-list-loading');
            
            if(loadingMsg) loadingMsg.classList.add('hidden');
            
            if (!eventsToRender || eventsToRender.length === 0) {
                if(container){
                    container.innerHTML = '';
                    container.classList.add('hidden');
                }
                if(emptyMsg) emptyMsg.classList.remove('hidden');
                return;
            }
            
            if(emptyMsg) emptyMsg.classList.add('hidden');
            if(container) container.classList.remove('hidden');

            let displayEvents = [...eventsToRender];
            
            if (userLocation) {
                displayEvents.forEach(e => {
                    if(e.lat && e.lng) e._distance = calculateDistance(userLocation.lat, userLocation.lng, e.lat, e.lng);
                    else e._distance = 99999; 
                });
                displayEvents.sort((a, b) => a._distance - b._distance);
                const statusEl = document.getElementById('event-list-status');
                if(statusEl) statusEl.textContent = '現在地から近い順';
            } else {
                const statusEl = document.getElementById('event-list-status');
                if(statusEl) statusEl.textContent = '新着順';
            }

            container.innerHTML = displayEvents.map(evt => {
                const thumb = evt.thumbnailUrl || 'https://via.placeholder.com/150?text=NOAH';
                const distStr = evt._distance !== undefined && evt._distance < 99999 ? `<span class="bg-brand-100 text-brand-700 px-1.5 py-0.5 rounded-sm ml-2 text-[10px] font-bold"><i class="fa-solid fa-location-arrow mr-1"></i>${evt._distance.toFixed(1)}km</span>` : '';
                
                const dateStr = (evt.startDate === evt.endDate) 
                    ? `${evt.startDate} ${evt.startTime || ''} 〜 ${evt.endTime || ''}`
                    : `${evt.startDate} ${evt.startTime || ''} 〜 ${evt.endDate || ''} ${evt.endTime || ''}`;

                const tags = evt.tags ? evt.tags.slice(0,2).map(t => `<span class="text-[10px] bg-[#f7f5f0] border border-brand-200 text-brand-600 px-1 rounded-sm">#${t}</span>`).join('') : '';

                return `
                <div class="flex bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm hover:shadow-md cursor-pointer transition-shadow h-28" onclick="showEventSheetById('${evt.id}')">
                    <div class="w-28 h-full flex-shrink-0 relative">
                        <img src="${thumb}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-3 flex flex-col justify-between flex-1 min-w-0">
                        <div>
                            <h3 class="font-bold text-sm text-brand-900 truncate font-serif tracking-widest">${evt.title || '名称未設定'}</h3>
                            <p class="text-[10px] text-brand-500 mt-1 flex items-center truncate"><i class="fa-regular fa-clock mr-1"></i>${dateStr} ${distStr}</p>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex gap-1 overflow-hidden">${tags}</div>
                            <span class="text-[10px] font-bold ${evt.price > 0 ? 'text-[#b8860b]' : 'text-brand-600'}">${evt.price > 0 ? '¥'+Number(evt.price).toLocaleString() : '無料'}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function renderMarkers(eventsToRender = [], jobsToRender = []) {
            if (!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Events (Red)
            eventsToRender.forEach(data => {
                if (data.lat && data.lng) {
                    const marker = L.marker([data.lat, data.lng], {icon: redIcon}).addTo(map);
                    marker.on('click', () => {
                        window.showEventSheetById(data.id);
                    });
                    markers.push(marker);
                }
            });

            // Jobs (Blue)
            jobsToRender.forEach(data => {
                if (data.lat && data.lng) {
                    const marker = L.marker([data.lat, data.lng], {icon: blueIcon}).addTo(map);
                    marker.on('click', () => {
                        window.showJobSheetById(data.id);
                    });
                    markers.push(marker);
                }
            });
        }

        // ==========================================
        // Job List Logic
        // ==========================================
        async function loadJobs() {
            const jobsRef = collection(db, 'artifacts', appId, 'public', 'data', 'jobs');
            try {
                const snapshot = await getDocs(jobsRef);
                allJobs = [];
                
                const safeGetTime = (createdAt) => {
                    if (!createdAt) return 0;
                    if (createdAt.toMillis) return createdAt.toMillis();
                    return new Date(createdAt).getTime() || 0;
                };

                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    allJobs.push(data);
                });
                
                allJobs.sort((a, b) => safeGetTime(b.createdAt) - safeGetTime(a.createdAt));
            } catch (e) { console.error("Job Load Error:", e); }
        }

        function renderJobList(jobsToRender) {
            const container = document.getElementById('job-list-container');
            const emptyMsg = document.getElementById('job-list-empty');
            const loadingMsg = document.getElementById('job-list-loading');
            
            if(loadingMsg) loadingMsg.classList.add('hidden');
            
            if (!jobsToRender || jobsToRender.length === 0) {
                if(container){
                    container.innerHTML = '';
                    container.classList.add('hidden');
                }
                if(emptyMsg) emptyMsg.classList.remove('hidden');
                return;
            }
            
            if(emptyMsg) emptyMsg.classList.add('hidden');
            if(container) container.classList.remove('hidden');

            container.innerHTML = jobsToRender.map(job => {
                const badgeColor = job.type === '正社員' ? 'bg-[#3e2723] text-[#d4af37]' : 'bg-brand-50 text-brand-600 border border-brand-200';
                
                let displayDate = '';
                if (job.createdAt) {
                    if (job.createdAt.toMillis) displayDate = new Date(job.createdAt.toMillis()).toLocaleDateString();
                    else displayDate = new Date(job.createdAt).toLocaleDateString();
                }

                return `
                <div class="bg-[#fffdf9] border border-brand-200 rounded-sm p-4 shadow-sm hover:shadow-md hover:border-brand-300 transition-all cursor-pointer relative" onclick="showJobSheetById('${job.id}')">
                    <div class="absolute top-0 right-0 w-8 h-8 border-t border-r border-brand-200 m-2"></div>
                    <div class="flex justify-between items-start mb-2 pr-4">
                        <span class="inline-block px-2 py-0.5 text-[10px] font-bold rounded-sm tracking-widest ${badgeColor}">${job.type || '未設定'}</span>
                        <span class="text-[10px] text-brand-400"><i class="fa-solid fa-clock-rotate-left mr-1"></i>${displayDate}</span>
                    </div>
                    <h3 class="font-bold text-brand-900 font-serif tracking-widest leading-tight mb-2">${job.title || '名称未設定'}</h3>
                    <p class="text-xs text-brand-500 line-clamp-2 leading-relaxed mb-3">${job.desc || ''}</p>
                    <div class="flex flex-wrap gap-x-4 gap-y-2 border-t border-brand-100 pt-3">
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-yen-sign text-brand-400 mr-1"></i>${job.rewardType || '応相談'}: ${job.rewardAmount || ''}</div>
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-location-dot text-brand-400 mr-1"></i>${job.locationName || job.location || '-'}</div>
                        <div class="text-[10px] font-bold text-brand-700 tracking-widest"><i class="fa-solid fa-building text-brand-400 mr-1"></i>${job.company || job.organizerName || ''}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ==========================================
        // FAB & Menus & Modal Management
        // ==========================================
        window.toggleCreateMenu = () => {
            const menu = document.getElementById('create-menu');
            const icon = document.getElementById('fab-icon');
            if(!menu || !icon) return;

            if (menu.classList.contains('menu-closed')) {
                menu.classList.remove('menu-closed');
                menu.classList.add('menu-open');
                icon.style.transform = 'rotate(45deg)';
            } else {
                menu.classList.add('menu-closed');
                menu.classList.remove('menu-open');
                icon.style.transform = 'rotate(0deg)';
            }
        };

        window.openCreateModal = (type) => {
            toggleCreateMenu(); 
            
            if (!myProfile) myProfile = { membershipRank: 'arrival' };
            const rank = myProfile.membershipRank || 'arrival';

            if (type === 'event') {
                if (rank === 'arrival' && !isAdmin) return alert('イベント企画は SETTLER 以上の機能です。契約変更をご検討ください。');
                
                const modal = document.getElementById('event-modal');
                if(modal) modal.classList.remove('hidden');
                editingEventId = null;
                
                // Form Reset safely
                try {
                    document.getElementById('event-title').value = "";
                    document.getElementById('event-price').value = "0";
                    const todayStr = new Date().toISOString().split('T')[0];
                    document.getElementById('event-start-date').value = todayStr;
                    document.getElementById('event-end-date').value = todayStr;
                    document.getElementById('event-start-time').value = "";
                    document.getElementById('event-end-time').value = "";
                    document.getElementById('event-location-name').value = "";
                    document.getElementById('event-online-tool').value = "";
                    document.getElementById('event-online-url').value = "";
                    document.getElementById('event-desc').value = "";
                    document.getElementById('event-custom-tags').value = "";
                    document.getElementById('location-search-input').value = "";
                    document.getElementById('location-results').classList.add('hidden');
                    document.getElementById('event-public-participants').checked = true;
                    
                    document.getElementById('event-image').value = "";
                    document.getElementById('event-image-preview').src = "";
                    document.getElementById('event-image-preview').classList.add('hidden');

                    selectedTags.clear();
                    renderEventTagButtons();
                    checkOnlineToggle();
                    if (tempMarker) map.removeLayer(tempMarker);
                    selectedCoordsEvent = null;
                } catch(e) { console.log(e); }

            } else if (type === 'job') {
                const allowedRanks = ['builder', 'guardian', 'covenant'];
                if (!allowedRanks.includes(rank) && !isAdmin) return alert('仕事・依頼の掲載は BUILDER 以上の機能です。契約変更をご検討ください。');
                
                const modal = document.getElementById('job-modal');
                if(modal) modal.classList.remove('hidden');
                const cont = document.getElementById('job-form-container');
                if(cont) cont.scrollTop = 0;
                
                try {
                    document.getElementById('job-title').value = "";
                    document.getElementById('job-type').value = "業務委託";
                    document.getElementById('job-category').value = "デザイン";
                    document.getElementById('job-desc').value = "";
                    document.getElementById('job-reward-type').value = "固定報酬";
                    document.getElementById('job-reward-amount').value = "";
                    document.getElementById('job-period').value = "単発";
                    document.getElementById('job-work-style').value = "フルリモート";
                    document.getElementById('job-location').value = "";
                    document.getElementById('job-location-name').value = "";
                    document.getElementById('job-location-search-input').value = "";
                    document.getElementById('job-skills').value = "";
                    document.getElementById('job-deadline').value = "";
                    document.getElementById('job-flow').value = "面談1回";
                    document.getElementById('job-company').value = "";
                    document.getElementById('job-url').value = "";
                    
                    if (tempMarker) map.removeLayer(tempMarker);
                    selectedCoordsJob = null;
                    toggleJobLocationUI();
                } catch(e){ console.log(e); }
            }
        };

        window.closeCreateModal = (type) => {
            const modal = document.getElementById(`${type}-modal`);
            if(modal) modal.classList.add('hidden');
        };

        // ==========================================
        // Shared Map Location Methods
        // ==========================================
        window.searchLocation = async (type) => {
            const inputId = type === 'event' ? 'location-search-input' : 'job-location-search-input';
            const query = document.getElementById(inputId).value;
            if (!query) return;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();
                
                const listId = type === 'event' ? 'location-results' : 'job-location-results';
                const list = document.getElementById(listId);
                list.innerHTML = '';
                list.classList.remove('hidden');

                if (results.length === 0) { 
                    list.innerHTML = '<div class="p-3 text-[10px] text-brand-500 tracking-widest leading-tight">見つかりませんでした。<br>※番地や建物名で出ない場合は、市区町村で検索し、地図上でピンを動かして調整してください。</div>'; 
                    return; 
                }

                results.forEach(place => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border-b border-brand-100 cursor-pointer text-xs text-brand-700 hover:bg-brand-50 tracking-widest truncate';
                    div.textContent = place.display_name;
                    div.onclick = () => selectLocation(type, place);
                    list.appendChild(div);
                });
            } catch (e) { alert('検索エラーが発生しました'); }
        };

        function selectLocation(type, place) {
            const listId = type === 'event' ? 'location-results' : 'job-location-results';
            const nameInputId = type === 'event' ? 'event-location-name' : 'job-location-name';
            const icon = type === 'event' ? redIcon : blueIcon;

            const coords = { lat: parseFloat(place.lat), lng: parseFloat(place.lon) };
            if (type === 'event') selectedCoordsEvent = coords; else selectedCoordsJob = coords;

            document.getElementById(listId).classList.add('hidden');
            document.getElementById(nameInputId).value = place.display_name.split(',')[0];
            
            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(coords, { draggable: true, icon: icon }).addTo(map);
            
            tempMarker.on('dragend', function(e) { 
                if (type === 'event') selectedCoordsEvent = e.target.getLatLng(); 
                else selectedCoordsJob = e.target.getLatLng(); 
            });
            
            map.flyTo(coords, 15);
        }

        window.startLocationAdjust = (type) => {
            currentAdjustType = type;
            
            if (type === 'event' && !selectedCoordsEvent) {
                const center = map.getCenter();
                selectedCoordsEvent = { lat: center.lat, lng: center.lng };
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker(selectedCoordsEvent, { draggable: true, icon: redIcon }).addTo(map);
                tempMarker.on('dragend', function(e) { selectedCoordsEvent = e.target.getLatLng(); });
            }
            if (type === 'job' && !selectedCoordsJob) {
                const center = map.getCenter();
                selectedCoordsJob = { lat: center.lat, lng: center.lng };
                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker(selectedCoordsJob, { draggable: true, icon: blueIcon }).addTo(map);
                tempMarker.on('dragend', function(e) { selectedCoordsJob = e.target.getLatLng(); });
            }

            const evtMod = document.getElementById('event-modal');
            const jobMod = document.getElementById('job-modal');
            const ui = document.getElementById('adjust-location-ui');
            
            if (type === 'event' && evtMod) evtMod.classList.add('hidden');
            if (type === 'job' && jobMod) jobMod.classList.add('hidden');
            if (ui) ui.classList.remove('hidden');
            
            switchView('map');
            if (map) map.invalidateSize();
        };

        window.finishLocationAdjust = () => {
            const ui = document.getElementById('adjust-location-ui');
            if(ui) ui.classList.add('hidden');
            
            if (currentAdjustType === 'event') {
                const mod = document.getElementById('event-modal');
                if(mod) mod.classList.remove('hidden');
            }
            if (currentAdjustType === 'job') {
                const mod = document.getElementById('job-modal');
                if(mod) mod.classList.remove('hidden');
            }
            currentAdjustType = null;
        };

        window.toggleJobLocationUI = () => {
            const styleEl = document.getElementById('job-work-style');
            const wrapper = document.getElementById('job-location-wrapper');
            if(!styleEl || !wrapper) return;
            
            if (styleEl.value === 'フルリモート') {
                wrapper.classList.add('hidden');
            } else {
                wrapper.classList.remove('hidden');
            }
        };

        // ==========================================
        // Event Creation Logic
        // ==========================================
        function renderEventTagButtons() {
            const container = document.getElementById('event-tag-area');
            if(!container) return;
            container.innerHTML = '';
            presetTags.forEach(tag => {
                const btn = document.createElement('button');
                btn.type = "button";
                btn.className = 'tag-btn px-3 py-1 rounded-sm border border-brand-200 text-[10px] font-bold text-brand-600 bg-[#fffdf9] transition-all tracking-widest';
                btn.textContent = tag;
                if(selectedTags.has(tag)) btn.classList.add('selected');

                btn.onclick = () => {
                    if (selectedTags.has(tag)) selectedTags.delete(tag);
                    else selectedTags.add(tag);
                    renderEventTagButtons();
                    checkOnlineToggle();
                };
                container.appendChild(btn);
            });
        }

        function checkOnlineToggle() {
            const offlineGroup = document.getElementById('offline-location-group');
            const onlineGroup = document.getElementById('online-url-group');
            if(!offlineGroup || !onlineGroup) return;

            if (selectedTags.has('オンライン')) {
                offlineGroup.classList.add('hidden');
                onlineGroup.classList.remove('hidden');
            } else {
                offlineGroup.classList.remove('hidden');
                onlineGroup.classList.add('hidden');
            }
        }

        window.submitEvent = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('event-submit-btn');
            
            try {
                const title = document.getElementById('event-title').value;
                const priceStr = document.getElementById('event-price').value;
                const price = priceStr ? parseInt(priceStr) : 0;
                const startDate = document.getElementById('event-start-date').value;
                const startTime = document.getElementById('event-start-time').value;
                const endDate = document.getElementById('event-end-date').value;
                const endTime = document.getElementById('event-end-time').value;
                
                const isOnline = selectedTags.has('オンライン');

                if (!title || !startDate || !startTime || !endDate || !endTime) return alert('タイトルと日時は必須です');
                if (!isOnline && !selectedCoordsEvent) return alert('オフライン開催の場合は場所を設定してください');

                let thumbnailUrl = null;
                const fileEl = document.getElementById('event-image');
                const file = fileEl ? fileEl.files[0] : null;
                
                if (file) {
                    if (isAdminMock) {
                        thumbnailUrl = 'https://via.placeholder.com/400x200?text=Mock+Image';
                    } else {
                        try {
                            const snap = await uploadBytes(ref(storage, `events/${currentUser.uid}/${Date.now()}_${file.name}`), file);
                            thumbnailUrl = await getDownloadURL(snap.ref);
                        } catch (e) { 
                            console.error(e);
                            return alert("画像のアップロードに失敗しました"); 
                        }
                    }
                }

                const customTagsEl = document.getElementById('event-custom-tags');
                const customTags = customTagsEl ? customTagsEl.value.split(',').map(s=>s.trim()).filter(s=>s) : [];
                const finalTags = [...Array.from(selectedTags), ...customTags];
                
                const safeName = (myProfile && (myProfile.name || myProfile.userId)) || '主催者';

                let descVal = "";
                const descEl = document.getElementById('event-desc');
                if(descEl) descVal = descEl.value;

                const eventData = {
                    title: title, price: price,
                    startDate: startDate, startTime: startTime, endDate: endDate, endTime: endTime,
                    endTimestamp: new Date(`${endDate}T${endTime}`).toISOString(),
                    description: descVal,
                    tags: finalTags, thumbnailUrl: thumbnailUrl,
                    organizerId: currentUser.uid,
                    organizerName: safeName,
                    isParticipantsPublic: document.getElementById('event-public-participants').checked,
                    createdAt: serverTimestamp(),
                    participantCount: 0
                };

                if (isOnline) {
                    eventData.isOnline = true;
                    eventData.locationName = "オンライン (" + (document.getElementById('event-online-tool').value || "ツール未定") + ")";
                    eventData.onlineUrl = document.getElementById('event-online-url').value || "";
                    eventData.lat = null; eventData.lng = null;
                } else {
                    eventData.isOnline = false;
                    eventData.locationName = document.getElementById('event-location-name').value || "場所名未設定";
                    eventData.lat = selectedCoordsEvent.lat; eventData.lng = selectedCoordsEvent.lng;
                }

                if(btn) btn.textContent = "送信中...";
                if (isAdminMock) {
                    alert('【テスト】イベントを作成しました！(モックデータ)');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'events'), eventData);
                    alert('イベントを企画しました！');
                }
                closeCreateModal('event');
                await loadAllData(); 
            } catch (e) {
                console.error("Submit Event Error:", e);
                alert('処理に失敗しました。\nエラー: ' + e.message);
            } finally {
                if(btn) btn.textContent = "イベントを企画する";
            }
        };

        // ==========================================
        // Job Create Logic
        // ==========================================
        window.submitJob = async () => {
            if (!currentUser) return;
            const btn = document.getElementById('job-submit-btn');

            try {
                const title = document.getElementById('job-title').value;
                const desc = document.getElementById('job-desc').value;
                const style = document.getElementById('job-work-style').value;

                if (!title || !desc) return alert('必須項目(タイトル・詳細)を入力してください');
                if (style !== 'フルリモート' && !selectedCoordsJob) return alert('勤務地・活動場所をマップで検索して設定してください');

                const safeName = (myProfile && (myProfile.name || myProfile.userId)) || '投稿者';
                const safeAvatar = (myProfile && myProfile.photoURL) || null;

                const jobData = {
                    title: title, 
                    type: document.getElementById('job-type').value || "その他", 
                    category: document.getElementById('job-category').value || "その他", 
                    desc: desc,
                    rewardType: document.getElementById('job-reward-type').value || "応相談",
                    rewardAmount: document.getElementById('job-reward-amount').value || "",
                    period: document.getElementById('job-period').value || "期間未定",
                    workStyle: style || "指定なし",
                    location: document.getElementById('job-location').value || "", 
                    skills: document.getElementById('job-skills').value || "",
                    deadline: document.getElementById('job-deadline').value || "",
                    flow: document.getElementById('job-flow').value || "その他",
                    company: document.getElementById('job-company').value || "",
                    url: document.getElementById('job-url').value || "",
                    
                    organizerId: currentUser.uid,
                    organizerName: safeName,
                    organizerAvatar: safeAvatar,
                    createdAt: serverTimestamp(),
                };

                if (style === 'フルリモート') {
                    jobData.locationName = "フルリモート";
                    jobData.lat = null; jobData.lng = null;
                } else {
                    jobData.locationName = document.getElementById('job-location-name').value || "場所名未設定";
                    jobData.lat = selectedCoordsJob.lat; jobData.lng = selectedCoordsJob.lng;
                }

                if(btn) btn.textContent = "送信中...";
                if (isAdminMock) {
                    alert('【テスト】仕事・依頼を掲載しました！(モックデータ)');
                } else {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'jobs'), jobData);
                    alert('仕事・依頼を掲載しました！');
                }
                closeCreateModal('job');
                await loadAllData(); 
                switchView('list-jobs'); 
            } catch (e) {
                console.error("Submit Job Error:", e);
                alert('処理に失敗しました。\nエラー: ' + e.message);
            } finally {
                if(btn) btn.textContent = "募集を掲載する";
            }
        };

        // ==========================================
        // Details Sheets Display & Participation
        // ==========================================
        window.showEventSheetById = (id) => {
            const evt = allEvents.find(e => e.id === id);
            if(evt) showEventSheet(evt);
        };
        window.showJobSheetById = (id) => {
            const job = allJobs.find(j => j.id === id);
            if(job) showJobSheet(job);
        };

        window.showEventSheet = async (evt) => {
            const sheet = document.getElementById('event-sheet');
            const content = document.getElementById('event-sheet-content');
            if(!sheet || !content) return;

            const thumb = evt.thumbnailUrl || 'https://via.placeholder.com/400x200?text=NOAH+Event';
            const tags = evt.tags ? evt.tags.map(t => `<span class="bg-brand-50 border border-brand-200 text-brand-600 px-2 py-0.5 rounded-sm text-[10px] font-bold tracking-widest">#${t}</span>`).join('') : '';
            const priceNum = Number(evt.price || 0);
            const priceText = priceNum > 0 ? `¥${priceNum.toLocaleString()}` : '無料';
            
            const dateStr = (evt.startDate === evt.endDate) 
                    ? `${evt.startDate || ''} ${evt.startTime || ''} 〜 ${evt.endTime || ''}`
                    : `${evt.startDate || ''} ${evt.startTime || ''} 〜 ${evt.endDate || ''} ${evt.endTime || ''}`;

            let locHtml = evt.isOnline 
                ? `<div class="flex items-center gap-3"><i class="fa-solid fa-laptop text-brand-400 w-4 text-center"></i><span class="tracking-widest">${evt.locationName || 'オンライン'}</span></div>
                   ${evt.onlineUrl ? `<div class="flex items-center gap-3 mt-2"><i class="fa-solid fa-link text-brand-400 w-4 text-center"></i><a href="${evt.onlineUrl}" target="_blank" class="text-blue-600 underline truncate tracking-widest text-xs">${evt.onlineUrl}</a></div>` : ''}`
                : `<div class="flex items-center gap-3"><i class="fa-solid fa-location-dot text-brand-400 w-4 text-center"></i><span class="tracking-widest">${evt.locationName || '未設定'}</span></div>`;

            // Basic UI Loading State
            content.innerHTML = `
                <div class="relative h-48 w-full rounded-sm overflow-hidden mb-4 shadow-sm border border-brand-200">
                    <img src="${thumb}" class="w-full h-full object-cover">
                    <div class="absolute top-2 right-2 bg-[#3e2723]/80 backdrop-blur text-[#d4af37] px-3 py-1 rounded-sm text-xs font-bold tracking-widest border border-[#b8860b] shadow-sm">${priceText}</div>
                </div>
                <h2 class="text-xl font-bold text-brand-900 leading-tight mb-3 font-serif tracking-widest">${evt.title || '名称未設定'}</h2>
                <div class="flex flex-wrap gap-2 mb-5">${tags}</div>
                <div class="space-y-3 text-xs text-brand-800 bg-[#fffdf9] p-4 rounded-sm mb-5 border border-brand-200 shadow-sm relative">
                    <div class="absolute top-0 right-0 w-6 h-6 border-t border-r border-brand-300 m-1"></div>
                    <div class="flex items-center gap-3"><i class="fa-regular fa-clock text-brand-400 w-4 text-center"></i><span class="tracking-widest">${dateStr}</span></div>
                    ${locHtml}
                    <div class="flex items-center gap-3 pt-2 border-t border-brand-100"><i class="fa-solid fa-user text-brand-400 w-4 text-center"></i><a href="user.html?uid=${evt.organizerId}" class="text-brand-600 font-bold hover:underline tracking-widest">主催: ${evt.organizerName || '不明'}</a></div>
                </div>
                <div class="mb-6"><h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">詳細</h3><p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide">${evt.description || '詳細はありません'}</p></div>
                <div id="event-dynamic-area"><div class="text-center text-brand-400 py-4"><i class="fa-solid fa-spinner fa-spin mr-2"></i> 情報を読み込み中...</div></div>
            `;
            sheet.classList.remove('hidden', 'sheet-closed');
            sheet.classList.add('sheet-open');

            // Async Fetch Participants & Join Status
            let isJoined = false;
            let partsHtml = '';
            let participants = [];
            
            if (currentUser && !isAdminMock) {
                try {
                    const partDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', evt.id, 'participants', currentUser.uid));
                    isJoined = partDoc.exists();
                    
                    const partsRef = collection(db, 'artifacts', appId, 'public', 'data', 'events', evt.id, 'participants');
                    const partsSnap = await getDocs(partsRef);
                    partsSnap.forEach(d => participants.push(d.id));
                } catch(e) {}
            } else if (isAdminMock) {
                participants = ['user1', 'user2']; // Dummy
            }

            const isOrganizer = currentUser && currentUser.uid === evt.organizerId;
            const dynArea = document.getElementById('event-dynamic-area');
            if(!dynArea) return;

            if (evt.isParticipantsPublic || isOrganizer || isAdmin) {
                if (participants.length === 0) {
                    partsHtml = '<div class="text-[10px] text-brand-500">まだ参加者はいません</div>';
                } else {
                    partsHtml = '<div class="flex -space-x-2 overflow-hidden py-1 pl-1">';
                    let count = 0;
                    for (const uid of participants) {
                        if (count >= 6) break;
                        partsHtml += `<div class="inline-block h-8 w-8 rounded-full ring-2 ring-[#fffdf9] bg-brand-100 border border-brand-300 flex items-center justify-center overflow-hidden"><i class="fa-solid fa-user text-brand-400 text-xs"></i></div>`;
                        count++;
                    }
                    if (participants.length > 6) partsHtml += `<div class="flex items-center justify-center h-8 w-8 rounded-full ring-2 ring-[#fffdf9] bg-brand-50 text-[10px] font-bold text-brand-600 border border-brand-200">+${participants.length - 6}</div>`;
                    partsHtml += '</div>';
                }
            } else {
                partsHtml = '<div class="text-[10px] text-brand-500 bg-brand-50 px-2 py-1.5 rounded-sm border border-brand-200"><i class="fa-solid fa-lock mr-1"></i>参加者は主催者のみ確認できます</div>';
            }

            const btnHtml = `
                <button onclick="toggleJoinEvent('${evt.id}', ${isJoined})" class="w-full py-3.5 rounded-sm font-bold tracking-widest shadow-md transition-colors ${isJoined ? 'bg-brand-100 text-brand-700 border border-brand-300 hover:bg-brand-200' : 'bg-[#3e2723] text-[#d4af37] border border-[#b8860b] hover:bg-[#2a1a17]'}">
                    ${isJoined ? '参加をキャンセルする' : '航海に参加する'}
                </button>
            `;

            let actionBtns = '';
            if (isOrganizer || isAdmin) {
                actionBtns = `
                    <div class="flex gap-2 mt-3">
                        <button onclick="deleteEvent('${evt.id}')" class="flex-1 py-2 rounded-sm text-red-700 font-bold border border-brand-200 hover:bg-red-50 transition-colors text-xs tracking-widest bg-white shadow-sm">
                            <i class="fa-solid fa-trash mr-1"></i> 削除
                        </button>
                    </div>`;
            }

            dynArea.innerHTML = `
                <div class="mb-6"><h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">参加者 (${participants.length}名)</h3>${partsHtml}</div>
                ${btnHtml}
                ${actionBtns}
            `;
        };

        window.toggleJoinEvent = async (eventId, isJoined) => {
            if (!currentUser) return alert('ログインが必要です');
            if (isJoining) return;
            isJoining = true;

            if (isAdminMock) {
                alert('【テスト】参加状況を変更しました');
                isJoining = false;
                const evt = allEvents.find(e => e.id === eventId);
                if (evt) showEventSheet(evt);
                return;
            }

            const partRef = doc(db, 'artifacts', appId, 'public', 'data', 'events', eventId, 'participants', currentUser.uid);
            const myJoinRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'participating_events', eventId);
            
            try {
                if (isJoined) {
                    await deleteDoc(partRef);
                    await deleteDoc(myJoinRef);
                    alert('参加をキャンセルしました');
                } else {
                    const ts = serverTimestamp();
                    await setDoc(partRef, { joinedAt: ts, uid: currentUser.uid });
                    await setDoc(myJoinRef, { joinedAt: ts, eventId: eventId });
                    alert('イベントに参加しました！');
                }
                
                const evt = allEvents.find(e => e.id === eventId);
                if (evt) showEventSheet(evt);

            } catch (e) {
                console.error("Join Event Error:", e);
                alert('エラーが発生しました: ' + e.message);
            } finally {
                isJoining = false;
            }
        };

        window.deleteEvent = async (eventId) => {
            if (!confirm('本当にこのイベントを削除しますか？\nこの操作は取り消せません。')) return;
            if (isAdminMock) return alert("【テスト】削除しました");

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'events', eventId));
                alert('イベントを削除しました');
                closeDetail('event');
                await loadAllData(); 
            } catch (e) { alert('削除に失敗しました'); }
        };

        window.showJobSheet = (job) => {
            const sheet = document.getElementById('job-sheet');
            const content = document.getElementById('job-sheet-content');
            if(!sheet || !content) return;
            
            const badgeColor = job.type === '正社員' ? 'bg-[#3e2723] text-[#d4af37]' : 'bg-brand-50 text-brand-600 border border-brand-200';

            let actionBtns = '';
            const isOrganizer = currentUser && currentUser.uid === job.organizerId;
            if (isOrganizer || isAdmin) {
                actionBtns = `
                    <div class="mt-4 pt-4 border-t border-brand-200">
                        <button onclick="deleteJob('${job.id}')" class="w-full py-2 rounded-sm text-red-700 font-bold border border-brand-200 hover:bg-red-50 transition-colors text-xs tracking-widest bg-white shadow-sm">
                            <i class="fa-solid fa-trash mr-1"></i> この求人を削除
                        </button>
                    </div>`;
            }

            content.innerHTML = `
                <div class="flex items-start gap-3 mb-4 mt-2">
                    <div class="w-12 h-12 rounded-sm bg-brand-100 overflow-hidden flex-shrink-0 border border-brand-200">
                        ${job.organizerAvatar ? `<img src="${job.organizerAvatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-brand-400"><i class="fa-solid fa-building"></i></div>`}
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-brand-900 leading-tight font-serif tracking-widest mb-1">${job.title || '名称未設定'}</h2>
                        <span class="inline-block px-2 py-0.5 text-[10px] font-bold rounded-sm tracking-widest ${badgeColor}">${job.type || '未設定'}</span>
                        <span class="text-[10px] text-brand-500 ml-2 tracking-widest">${job.category || ''}</span>
                    </div>
                </div>

                <div class="bg-[#f7f5f0] border border-brand-200 p-4 rounded-sm mb-6 space-y-3 text-xs tracking-widest text-brand-800 shadow-inner">
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">報酬</span><span class="font-bold">${job.rewardType || '応相談'}: ${job.rewardAmount || ''}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">働き方</span><span>${job.workStyle || '-'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">勤務地</span><span>${job.locationName || job.location || '-'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">期間</span><span>${job.period || '-'}</span></div>
                    <div class="flex justify-between border-b border-brand-100 pb-1"><span class="text-brand-500 font-bold">締切</span><span>${job.deadline || '未定'}</span></div>
                    <div class="flex justify-between"><span class="text-brand-500 font-bold">掲載元</span><span><a href="user.html?uid=${job.organizerId}" class="hover:underline">${job.company || job.organizerName || '不明'}</a></span></div>
                </div>

                <div class="mb-6">
                    <h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">業務内容詳細</h3>
                    <p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide bg-[#fffdf9] p-3 border border-brand-100 rounded-sm">${job.desc || '詳細はありません'}</p>
                </div>
                
                ${job.skills ? `
                <div class="mb-6">
                    <h3 class="font-bold text-brand-900 mb-2 text-xs font-serif tracking-widest border-b border-brand-200 pb-1">必須・歓迎条件</h3>
                    <p class="text-xs text-brand-700 leading-relaxed whitespace-pre-wrap tracking-wide bg-[#fffdf9] p-3 border border-brand-100 rounded-sm">${job.skills}</p>
                </div>` : ''}

                <div class="bg-brand-50 border border-brand-200 p-3 rounded-sm text-center mb-6">
                    <p class="text-[10px] text-brand-600 font-bold tracking-widest"><i class="fa-solid fa-circle-info mr-1"></i> 応募機能は現在開発中です。募集者へ直接コンタクトを取ってください。</p>
                </div>

                <a href="user.html?uid=${job.organizerId}" class="block w-full text-center py-3.5 rounded-sm font-bold tracking-widest shadow-md transition-colors bg-[#3e2723] text-[#d4af37] border border-[#b8860b] hover:bg-[#2a1a17]">掲載者のプロフィールを見る</a>
                
                ${actionBtns}
            `;

            sheet.classList.remove('hidden', 'sheet-closed');
            sheet.classList.add('sheet-open');
        };

        window.deleteJob = async (jobId) => {
            if (!confirm('本当にこの求人を削除しますか？')) return;
            if (isAdminMock) return alert("【テスト】削除しました");

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'jobs', jobId));
                alert('求人を削除しました');
                closeDetail('job');
                await loadAllData(); 
            } catch (e) { alert('削除に失敗しました'); }
        };

        window.closeDetail = (type) => {
            const sheet = document.getElementById(`${type}-sheet`);
            if(!sheet) return;
            sheet.classList.remove('sheet-open');
            sheet.classList.add('sheet-closed');
            setTimeout(() => sheet.classList.add('hidden'), 300);
        };

        window.handleLogout = () => {
            if (isAdminMock) localStorage.removeItem('isAdminMock');
            signOut(auth);
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>
