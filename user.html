<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プロフィール | NOAH</title>
    <link rel="icon" href="img/icon.png">
    
    <!-- Google Fonts: Noto Serif JP -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['Noto Serif JP', 'serif'] },
                    colors: { 
                        brand: { 
                            50: '#f7f5f0',   // bg
                            100: '#e8dfd1',  // border light
                            200: '#dcd4c6',  // border medium
                            300: '#c8b9a6',  // border dark
                            400: '#a09080',  // text muted
                            500: '#8b6a4f',  // accent
                            600: '#725b3f',  // accent hover
                            700: '#5c4a3d',  // text body
                            800: '#4a3b32',  // text heading
                            900: '#3e2723'   // text dark
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Serif JP', serif;
            background-color: #f7f5f0; 
            color: #4a3b32;
        }
        
        .bg-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        @media (min-width: 1024px) {
            .profile-sidebar { position: sticky; top: 5rem; height: calc(100vh - 6rem); overflow-y: auto; scrollbar-width: none; }
            .profile-sidebar::-webkit-scrollbar { display: none; }
        }
        
        .cover-gradient { 
            background: linear-gradient(120deg, #dcd4c6 0%, #eae5d8 100%); 
            position: relative;
        }
        .cover-gradient::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }
        
        .shimmer {
            background: #e8dfd1;
            background-image: linear-gradient(to right, #e8dfd1 0%, #f7f5f0 20%, #e8dfd1 40%, #e8dfd1 100%);
            background-repeat: no-repeat;
            background-size: 800px 100%; 
            animation: placeholderShimmer 1.5s linear infinite forwards;
        }
        @keyframes placeholderShimmer { 0% { background-position: -468px 0; } 100% { background-position: 468px 0; } }
        
        /* ボトムナビの高さ固定設定 */
        .bottom-nav-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fffdf9;
            border-top: 1px solid #e8dfd1;
            z-index: 50;
            height: 4rem;
            height: calc(4rem + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-nav-content {
            height: 4rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
        }
        .body-pb-nav {
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
        }

        /* ランクバッジのNOAH風スタイリング (5段階) */
        .badge-arrival { background-color: #f7f5f0; color: #5c4a3d; border: 1px solid #c8b9a6; }
        .badge-settler { background: linear-gradient(135deg, #e8dfd1 0%, #dcd4c6 100%); color: #4a3b32; border: 1px solid #8b6a4f; }
        .badge-builder { background: linear-gradient(135deg, #dcd4c6 0%, #c8b9a6 100%); color: #3e2723; border: 1px solid #725b3f; }
        .badge-guardian { background: linear-gradient(135deg, #c8b9a6 0%, #a09080 100%); color: #f7f5f0; border: 1px solid #5c4a3d; }
        .badge-covenant { background: linear-gradient(135deg, #fef9c3 0%, #d4af37 100%); color: #3e2723; border: 1px solid #b8860b; }
    </style>
</head>
<body class="antialiased body-pb-nav lg:pb-0 bg-texture">

    <!-- Navbar -->
    <nav class="bg-[#fffdf9] bg-texture border-b border-brand-200 fixed w-full z-50 top-0 h-16 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center relative z-10">
            <div class="flex items-center gap-4">
                <a href="javascript:history.back()" class="lg:hidden text-brand-400 hover:text-brand-900 transition-colors">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </a>
                <a href="user.html" class="text-xl font-black text-brand-900 tracking-widest flex items-center gap-2 font-serif">
                    <span class="bg-brand-900 text-brand-50 w-8 h-8 flex items-center justify-center rounded-sm text-sm"><i class="fa-solid fa-anchor"></i></span>
                    <span id="header-title">マイページ</span>
                </a>
            </div>
            <div class="flex items-center gap-3">
                <!-- PC Navigation Links -->
                <div class="hidden lg:flex items-center gap-6 mr-4">
                    <a href="home.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-ship"></i> 航海(ホーム)</a>
                    <a href="events.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-hourglass-half"></i> イベント</a>
                    <a href="search.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-compass"></i> さがす</a>
                    <a href="user.html" class="text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-user"></i> マイページ</a>
                </div>

                <!-- PC用 UPGRADEボタン -->
                <a href="upgrade.html" class="hidden lg:inline-flex items-center px-4 py-1.5 bg-gradient-to-r from-[#d4af37] to-[#b8860b] text-white text-xs font-bold rounded-sm shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 border border-[#996515]">
                    <i class="fa-solid fa-shield-halved mr-1"></i> 契約変更
                </a>
                
                <a href="notifications.html" class="p-2 text-brand-300 hover:text-brand-600 transition-colors relative" title="通知">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <span id="nav-badge" class="hidden absolute top-1.5 right-1.5 h-2.5 w-2.5 bg-[#8b6a4f] rounded-full border-2 border-[#fffdf9]"></span>
                </a>
                <button onclick="location.reload()" class="p-2 text-brand-300 hover:text-brand-600 transition-colors" title="更新"><i class="fa-solid fa-rotate-right"></i></button>
                <div class="h-6 w-px bg-brand-200 mx-1 hidden lg:block"></div>
                <button onclick="handleLogout()" class="text-sm font-bold text-brand-400 hover:text-red-800 transition-colors flex items-center gap-2"><span class="hidden sm:inline tracking-widest">下船する</span><i class="fa-solid fa-right-from-bracket text-lg"></i></button>
            </div>
        </div>
    </nav>

    <!-- Bottom Navigation -->
    <nav class="lg:hidden bottom-nav-fixed shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="bottom-nav-content">
            <a href="home.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-ship text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">航海</span>
            </a>
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-hourglass-half text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">イベント</span>
            </a>
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-compass text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">さがす</span>
            </a>
            <button onclick="alert('マッチング機能は準備中です。\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-brand-300 hover:text-brand-500 transition-colors">
                <i class="fa-solid fa-handshake text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">マッチ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-bold tracking-widest">マイページ</span>
            </a>
        </div>
    </nav>

    <!-- Error Container -->
    <div id="error-container" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-[#fffdf9]/80 backdrop-blur-sm">
        <div class="bg-[#fffdf9] p-8 rounded-sm shadow-xl border border-brand-200 text-center max-w-sm mx-4">
            <div class="w-16 h-16 bg-brand-50 rounded-full border border-brand-200 flex items-center justify-center mx-auto mb-4 text-brand-400 text-2xl"><i class="fa-solid fa-user-slash"></i></div>
            <h3 class="text-lg font-bold text-brand-900 mb-2 font-serif">ユーザーが見つかりません</h3>
            <p class="text-brand-500 text-sm mb-6">IDが間違っているか、データが取得できませんでした。</p>
            <a href="user.html" class="inline-block w-full bg-brand-900 text-brand-50 font-bold py-3 rounded-sm hover:bg-brand-800 transition-colors tracking-widest">自分のページに戻る</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto pt-16 px-0 sm:px-6 lg:px-8">
        <div class="flex flex-col lg:flex-row gap-6 lg:gap-8 lg:py-8">
            
            <aside class="w-full lg:w-[360px] flex-shrink-0">
                <div class="profile-sidebar">
                    <div class="bg-[#fffdf9] sm:rounded-sm shadow-md border border-brand-200 overflow-hidden relative">
                        <!-- 装飾コーナー -->
                        <div class="absolute top-0 left-0 w-8 h-8 border-t border-l border-brand-500 z-10 m-2"></div>
                        <div class="absolute top-0 right-0 w-8 h-8 border-t border-r border-brand-500 z-10 m-2"></div>

                        <div class="h-32 cover-gradient w-full border-b border-brand-200"></div>
                        <div class="px-6 relative">
                            <div class="-mt-12 flex justify-between items-end mb-4">
                                <div class="relative">
                                    <div class="h-24 w-24 rounded-sm border-[3px] border-[#fffdf9] bg-[#fffdf9] shadow-sm overflow-hidden relative z-20">
                                        <i id="header-icon-placeholder" class="fa-solid fa-anchor text-4xl text-brand-200 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
                                        <img id="header-icon-img" src="" class="hidden w-full h-full object-cover" alt="Profile">
                                    </div>
                                </div>
                                <div id="header-actions" class="mb-1 relative z-20"></div>
                            </div>

                            <div class="mb-4 relative z-20">
                                <h1 class="text-2xl font-bold text-brand-900 leading-tight font-serif"><span id="profile-name" class="shimmer block w-32 h-8 rounded-sm mb-1"></span></h1>
                                <div class="flex flex-wrap items-center gap-2 mt-1">
                                    <p class="text-sm text-brand-500 font-medium tracking-wide" id="profile-id">@...</p>
                                    <span id="rank-badge" class="hidden inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold border tracking-widest"></span>
                                    <span id="mutual-badge" class="hidden inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-[#f7f5f0] text-brand-600 border border-brand-200 tracking-widest"><i class="fa-solid fa-handshake mr-1"></i>相互フォロー</span>
                                    <span id="admin-badge" class="hidden inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-[#3e2723] text-[#d4af37] border border-[#b8860b] tracking-widest"><i class="fa-solid fa-crown mr-1"></i>管理者</span>
                                </div>
                            </div>
                            
                            <!-- Bio Section -->
                            <div class="mb-6 relative z-20" id="section-bio"><p id="profile-bio" class="text-sm text-brand-700 leading-relaxed whitespace-pre-wrap"></p></div>

                            <div class="flex items-center gap-6 py-4 border-t border-brand-100 relative z-20">
                                <div class="text-center cursor-pointer hover:opacity-75 transition-opacity">
                                    <span class="block font-bold text-brand-900 text-lg font-serif" id="count-following">-</span>
                                    <span class="text-xs text-brand-500 font-medium tracking-widest">フォロー中</span>
                                </div>
                                <div class="text-center cursor-pointer hover:opacity-75 transition-opacity">
                                    <span class="block font-bold text-brand-900 text-lg font-serif" id="count-followers">-</span>
                                    <span class="text-xs text-brand-500 font-medium tracking-widest">フォロワー</span>
                                </div>
                            </div>

                            <div class="py-4 border-t border-brand-100 space-y-3 relative z-20">
                                <div class="flex items-center gap-3 text-sm text-brand-700"><div class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-400 border border-brand-100 flex-shrink-0"><i class="fa-solid fa-feather"></i></div><span id="profile-job" class="font-medium">-</span></div>
                                <div class="flex items-center gap-3 text-sm text-brand-700"><div class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-400 border border-brand-100 flex-shrink-0"><i class="fa-solid fa-map-location-dot"></i></div><span id="profile-location" class="font-medium">-</span></div>
                                
                                <div class="mutual-only hidden space-y-3">
                                    <div class="flex items-center gap-3 text-sm text-brand-700"><div class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-400 border border-brand-100 flex-shrink-0"><i class="fa-solid fa-venus-mars"></i></div><span id="data-gender" class="font-medium">-</span></div>
                                    <div class="flex items-center gap-3 text-sm text-brand-700"><div class="w-8 h-8 rounded-full bg-brand-50 flex items-center justify-center text-brand-400 border border-brand-100 flex-shrink-0"><i class="fa-solid fa-hourglass"></i></div><span id="data-birth" class="font-medium">-</span></div>
                                </div>
                                <div id="profile-sns-links" class="flex gap-3 pt-2"></div>
                                
                                <!-- Personal Mask Overlay -->
                                <div id="personal-mask" class="hidden mt-2 p-3 bg-brand-50 border border-brand-200 border-dashed text-center">
                                    <p class="text-xs text-brand-500 font-medium tracking-widest"><i class="fa-solid fa-lock mr-1"></i>詳細は相互フォローで公開</p>
                                </div>
                            </div>

                            <div id="completion-bar-container" class="hidden my-4 p-4 bg-brand-50 border border-brand-200 relative z-20">
                                <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold text-brand-500 tracking-widest">プロフィール充実度</span><span id="score-text" class="text-sm font-bold text-brand-600">0%</span></div>
                                <div class="w-full bg-brand-200 h-1.5"><div id="score-bar" class="bg-brand-500 h-1.5 transition-all duration-1000 ease-out" style="width: 0%"></div></div>
                            </div>

                            <!-- Upgrade CTA -->
                            <div id="upgrade-cta-container" class="hidden mt-4 mb-6 relative z-20">
                                <a href="upgrade.html" class="block w-full bg-gradient-to-r from-[#d4af37] to-[#b8860b] text-[#2a1a17] border border-[#996515] rounded-sm shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 group">
                                    <div class="px-3 py-2.5 flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="bg-[#fffdf9]/30 rounded-full p-1.5 group-hover:scale-110 transition-transform">
                                                <i class="fa-solid fa-shield-halved text-base text-[#2a1a17]"></i>
                                            </div>
                                            <div class="text-left">
                                                <p class="text-[10px] font-bold text-[#2a1a17]/80 leading-tight tracking-widest">機能制限を解除</p>
                                                <p class="text-sm font-black tracking-widest leading-tight mt-0.5 font-serif">契約をアップグレード</p>
                                            </div>
                                        </div>
                                        <i class="fa-solid fa-chevron-right text-[#2a1a17]/80 text-sm"></i>
                                    </div>
                                </a>
                            </div>

                            <!-- Debug: Rank Switcher (Admin Only) -->
                            <div id="debug-rank-switcher" class="hidden mt-6 pt-6 border-t border-dashed border-brand-200 relative z-20 pb-4">
                                <p class="text-[10px] font-bold text-[#b8860b] mb-2 uppercase tracking-widest">【管理者用】役割変更</p>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="changeRank('arrival')" class="flex-1 py-1 text-[9px] font-bold bg-brand-50 text-brand-600 rounded-sm hover:bg-brand-100 border border-brand-200 min-w-[60px]">ARRIVAL</button>
                                    <button onclick="changeRank('settler')" class="flex-1 py-1 text-[9px] font-bold bg-brand-100 text-brand-700 rounded-sm hover:bg-brand-200 border border-brand-300 min-w-[60px]">SETTLER</button>
                                    <button onclick="changeRank('builder')" class="flex-1 py-1 text-[9px] font-bold bg-brand-200 text-brand-800 rounded-sm hover:bg-brand-300 border border-brand-400 min-w-[60px]">BUILDER</button>
                                    <button onclick="changeRank('guardian')" class="flex-1 py-1 text-[9px] font-bold bg-brand-300 text-[#fffdf9] rounded-sm hover:bg-brand-400 border border-brand-500 min-w-[60px]">GUARDIAN</button>
                                    <button onclick="changeRank('covenant')" class="flex-1 py-1 text-[9px] font-bold bg-[#d4af37] text-[#2a1a17] rounded-sm hover:bg-[#b8860b] border border-[#996515] min-w-[60px]">COVENANT</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <div class="flex-1 min-w-0">
                <div class="space-y-6">
                    
                    <!-- Message Section -->
                    <div id="section-message" class="bg-[#fffdf9] sm:rounded-sm shadow-md border border-brand-200 p-6 sm:p-8 relative overflow-hidden">
                        <div class="flex items-center justify-between mb-4 pb-2 border-b border-brand-200">
                            <h2 class="text-lg font-bold text-brand-900 flex items-center gap-2 font-serif tracking-widest">想い・メッセージ</h2>
                            <i id="message-lock-icon" class="fa-solid fa-lock text-brand-300 hidden"></i>
                        </div>
                        <div id="message-container" class="hidden">
                            <div class="relative mt-6">
                                <i class="fa-solid fa-quote-left text-brand-100 text-4xl absolute -top-4 -left-2 z-0"></i>
                                <div id="profile-message" class="relative z-10 text-[15px] leading-8 text-brand-700 whitespace-pre-wrap font-medium pl-6"></div>
                            </div>
                        </div>
                        <div id="message-mask" class="hidden py-8 bg-brand-50 border border-dashed border-brand-200 text-center mt-4">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-[#fffdf9] border border-brand-100 mb-3 shadow-sm"><i class="fa-solid fa-lock text-brand-300"></i></div>
                            <p class="text-sm font-bold text-brand-500 tracking-widest"></p>
                        </div>
                    </div>

                    <!-- Matching Section -->
                    <div id="section-matching" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-[#fffdf9] rounded-sm p-6 border border-brand-200 shadow-md relative overflow-hidden group hover:border-brand-500 transition-colors">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-[#f7f5f0] rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110 border-b border-l border-brand-100"></div>
                            <h3 class="text-sm font-bold text-brand-500 mb-4 tracking-widest font-serif relative z-10 border-b border-brand-100 pb-2">提供できること</h3>
                            <ul id="list-can-offer" class="space-y-3 relative z-10"><li class="text-brand-300 italic text-sm">未設定</li></ul>
                        </div>
                        <div class="bg-[#fffdf9] rounded-sm p-6 border border-brand-200 shadow-md relative overflow-hidden group hover:border-brand-500 transition-colors">
                            <div class="absolute top-0 right-0 w-16 h-16 bg-[#eae5d8] rounded-bl-full -mr-2 -mt-2 transition-transform group-hover:scale-110 border-b border-l border-brand-200"></div>
                            <h3 class="text-sm font-bold text-brand-500 mb-4 tracking-widest font-serif relative z-10 border-b border-brand-100 pb-2">求めていること</h3>
                            <ul id="list-looking-for" class="space-y-3 relative z-10"><li class="text-brand-300 italic text-sm">未設定</li></ul>
                        </div>
                    </div>

                    <!-- Tags Section -->
                    <div id="section-tags" class="bg-[#fffdf9] sm:rounded-sm shadow-md border border-brand-200 p-6">
                        <h2 class="text-lg font-bold text-brand-900 mb-4 pb-2 border-b border-brand-200 font-serif tracking-widest">スキル・趣味</h2>
                        <div id="tags-container" class="flex flex-wrap gap-2"><span class="text-sm text-brand-300 italic">未設定</span></div>
                    </div>

                    <!-- Goals Section -->
                    <div id="section-goals" class="bg-[#fffdf9] sm:rounded-sm shadow-md border border-brand-200 p-6">
                        <h2 class="text-lg font-bold text-brand-900 mb-4 pb-2 border-b border-brand-200 font-serif tracking-widest">目標・ビジョン</h2>
                        <div id="profile-goals" class="text-brand-700 text-sm leading-8 whitespace-pre-wrap mt-2">未設定</div>
                    </div>

                    <!-- Career Section -->
                    <div id="section-career" class="bg-[#fffdf9] sm:rounded-sm shadow-md border border-brand-200 p-6 sm:p-8 relative">
                        <!-- 装飾 -->
                        <div class="absolute bottom-0 right-0 w-12 h-12 border-b-2 border-r-2 border-brand-300 m-4 pointer-events-none opacity-50"></div>
                        
                        <div class="flex items-center justify-between mb-6 pb-2 border-b border-brand-200">
                            <h2 class="text-lg font-bold text-brand-900 font-serif tracking-widest">経歴</h2>
                            <i id="career-lock-icon" class="fa-solid fa-lock text-brand-300"></i>
                        </div>
                        <div id="career-container" class="space-y-8 mt-4 relative">
                            <div class="absolute left-[7px] top-2 bottom-2 w-px bg-brand-200"></div>
                        </div>
                        <div id="career-mask" class="hidden py-10 bg-brand-50 border border-dashed border-brand-200 text-center mt-4">
                            <p class="text-sm font-bold text-brand-500 tracking-widest">相互フォローで経歴を表示</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-50 hidden transition-all duration-300 translate-y-20">
        <div class="bg-[#3e2723] text-[#f7f5f0] px-6 py-3 rounded-sm shadow-2xl flex items-center gap-3 backdrop-blur-md bg-opacity-95 border border-[#8b6a4f]"><i class="fa-solid fa-ship text-[#c8b9a6] text-lg"></i><span id="notif-message" class="text-sm font-bold tracking-widest font-serif"></span></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, serverTimestamp, collection, getCountFromServer, addDoc, query, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // ▼▼▼▼ Firebase Config ▼▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let currentUser = null;
        let isSelf = false;
        let isAdmin = false;
        let targetUid = null;
        let isFollowing = false;
        let isMutual = false;
        let myRank = 'arrival'; // デフォルトをarrivalに変更

        const isAdminMock = localStorage.getItem('isAdminMock') === 'true';
        const urlParams = new URLSearchParams(window.location.search);
        targetUid = urlParams.get('uid');

        // Helper
        function formatText(text) {
            if (!text) return '';
            let safeText = text.replace(/[&<>"']/g, function(m) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]; });
            return safeText.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)|(https?:\/\/[a-zA-Z0-9.\/?=&%#_:-]+)/g, (match, mdText, mdUrl, rawUrl) => {
                if (mdText && mdUrl) return `<a href="${mdUrl}" target="_blank" rel="noopener noreferrer" class="text-brand-600 hover:text-brand-800 underline transition-colors cursor-pointer">${mdText}</a>`;
                if (rawUrl) return `<a href="${rawUrl}" target="_blank" rel="noopener noreferrer" class="text-brand-600 hover:text-brand-800 underline break-all transition-colors cursor-pointer">${rawUrl}</a>`;
                return match;
            });
        }
        function setElText(id, text) { const el = document.getElementById(id); if(el) el.textContent = text || '-'; }
        function setElHtml(id, html) { const el = document.getElementById(id); if(el) el.innerHTML = html || ''; }

        onAuthStateChanged(auth, async (user) => {
            if (isAdminMock) {
                currentUser = { uid: 'test_admin_uid', displayName: '管理者' };
                isAdmin = true;
                myRank = 'covenant'; // 管理者モックは最高ランク
                if (targetUid && targetUid !== 'test_admin_uid') {
                    isSelf = false;
                    setupViewForOtherUser();
                } else {
                    isSelf = true;
                    targetUid = 'test_admin_uid';
                    updateDashboardUI(getAdminMockData());
                    enableSelfMode(myRank);
                }
                return;
            }

            if (user && !user.isAnonymous) {
                currentUser = user;
                checkUnreadNotifications(user.uid);
                
                const myProfileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                const myProfileSnap = await getDoc(myProfileRef);
                if (myProfileSnap.exists()) {
                    const myData = myProfileSnap.data();
                    if (myData.userId === 'admin') isAdmin = true;
                    if (isAdmin) document.getElementById('admin-badge').classList.remove('hidden');
                    myRank = myData.membershipRank || 'arrival'; // デフォルト
                } else {
                    myRank = 'arrival';
                }

                if (!targetUid || targetUid === user.uid) {
                    isSelf = true;
                    targetUid = user.uid;
                    enableSelfMode(myRank); 
                    if (myProfileSnap.exists()) updateDashboardUI(myProfileSnap.data());
                    else updateDashboardUI({ userId: user.uid, name: '（未設定）' });
                } else {
                    isSelf = false;
                    await checkFollowStatus(user.uid, targetUid); 
                    await loadPublicProfile(targetUid);
                }
                updateFollowCounts(targetUid);
            } else {
                window.location.href = 'login.html';
            }
        });

        async function checkUnreadNotifications(uid) {
            try {
                const notifRef = collection(db, 'artifacts', appId, 'users', uid, 'notifications');
                const q = query(notifRef, where('isRead', '==', false));
                const snap = await getCountFromServer(q);
                if (snap.data().count > 0) document.getElementById('nav-badge').classList.remove('hidden');
            } catch (e) { console.error(e); }
        }

        function enableSelfMode(currentRank) {
            const headerActions = document.getElementById('header-actions');
            if(headerActions) {
                headerActions.innerHTML = `
                <div class="flex flex-col items-end gap-1 w-full lg:w-auto">
                    <a href="profile.html" class="inline-flex items-center justify-center px-6 py-2 border border-brand-500 shadow-sm text-sm font-bold rounded-sm text-brand-900 bg-[#fffdf9] hover:bg-brand-50 transition-all active:scale-95 tracking-widest font-serif">
                        航海録を編集
                    </a>
                    <a href="upgrade.html" class="text-[10px] font-bold text-brand-400 hover:text-brand-600 transition-colors mr-1 underline decoration-dotted tracking-widest">
                        契約の確認・変更
                    </a>
                </div>`;
            }
            document.getElementById('completion-bar-container').classList.remove('hidden');
            
            if (isAdmin) {
                document.getElementById('debug-rank-switcher').classList.remove('hidden');
            }
            
            // ARRIVAL（無料）の場合のみアップグレードを促す
            if (currentRank === 'arrival') {
                document.getElementById('upgrade-cta-container').classList.remove('hidden');
            } else {
                document.getElementById('upgrade-cta-container').classList.add('hidden');
            }
            
            isMutual = true; 
            toggleRestrictedContent(true);
        }

        async function setupViewForOtherUser() {
            const mockTarget = getAdminMockData();
            mockTarget.name = "サンプル太郎";
            mockTarget.userId = "target_user";
            isMutual = confirm("【テスト】相互フォロー状態にしますか？\nOK=相互(全表示), Cancel=片思い/未フォロー");
            isFollowing = true;
            renderFollowButton();
            updateDashboardUI(mockTarget);
            toggleRestrictedContent(isMutual);
            if(isMutual) document.getElementById('mutual-badge').classList.remove('hidden');
            setElText('count-following', '120');
            setElText('count-followers', '45');
        }

        async function loadPublicProfile(uid) {
            try {
                let dataToUse = null;
                const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
                const publicSnap = await getDoc(publicRef);

                if (publicSnap.exists()) {
                    dataToUse = publicSnap.data();
                }
                
                // 自分がARRIVALでない、または管理者の場合は詳細データを取得
                if (isAdmin || (isMutual && myRank !== 'arrival')) {
                    try {
                        const privateRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                        const privateSnap = await getDoc(privateRef);
                        if (privateSnap.exists()) {
                            dataToUse = { ...(dataToUse || {}), ...privateSnap.data() };
                        }
                    } catch (e) { console.log("Private load failed", e); }
                }

                if (dataToUse) {
                    updateDashboardUI(dataToUse);
                } else {
                    document.getElementById('error-container').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Load error:", e);
            }
        }

        async function updateFollowCounts(uid) {
            try {
                const followingColl = collection(db, 'artifacts', appId, 'users', uid, 'following');
                const followersColl = collection(db, 'artifacts', appId, 'users', uid, 'followers');
                const followingSnap = await getCountFromServer(followingColl);
                const followersSnap = await getCountFromServer(followersColl);
                setElText('count-following', followingSnap.data().count);
                setElText('count-followers', followersSnap.data().count);
            } catch (e) {
                setElText('count-following', '-');
                setElText('count-followers', '-');
            }
        }

        async function checkFollowStatus(myUid, targetUid) {
            try {
                const followingRef = doc(db, 'artifacts', appId, 'users', myUid, 'following', targetUid);
                const isFollowingSnap = await getDoc(followingRef);
                isFollowing = isFollowingSnap.exists();

                const followerRef = doc(db, 'artifacts', appId, 'users', myUid, 'followers', targetUid);
                const isFollowedBackSnap = await getDoc(followerRef);
                const isFollowedBack = isFollowedBackSnap.exists();

                isMutual = isFollowing && isFollowedBack;
                renderFollowButton();
                
                const badge = document.getElementById('mutual-badge');
                if (badge) {
                    if (isMutual && !isSelf) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                }
            } catch (e) { console.error("Check follow err:", e); }
        }

        function renderFollowButton() {
            const container = document.getElementById('header-actions');
            if(!container) return;
            let btnHtml = '';
            if (isFollowing) {
                btnHtml += `<button onclick="toggleFollow()" class="inline-flex items-center px-4 py-2 border border-brand-500 shadow-sm text-sm font-bold rounded-sm text-brand-900 bg-[#fffdf9] hover:bg-brand-50 transition-all mr-2 tracking-widest font-serif">フォロー中</button>`;
            } else {
                btnHtml += `<button onclick="toggleFollow()" class="inline-flex items-center px-4 py-2 border border-transparent shadow-md text-sm font-bold rounded-sm text-[#f7f5f0] bg-[#3e2723] hover:bg-[#2a1a17] transition-all mr-2 tracking-widest font-serif">フォロー</button>`;
            }
            if (isAdmin && !isSelf) {
                btnHtml += `<a href="profile.html?uid=${targetUid}" class="inline-flex items-center px-3 py-2 border border-brand-300 text-brand-700 bg-brand-50 hover:bg-brand-100 rounded-sm text-sm font-bold transition-all"><i class="fa-solid fa-pen-to-square mr-1"></i>編集</a>`;
                document.getElementById('admin-badge').classList.remove('hidden');
                document.getElementById('debug-rank-switcher').classList.remove('hidden');
            }
            container.innerHTML = btnHtml;
        }

        window.toggleFollow = async () => {
            if (!currentUser || isAdminMock) {
                if(isAdminMock) { isFollowing = !isFollowing; renderFollowButton(); showNotification('Mock Action'); }
                return;
            }
            const myUid = currentUser.uid;
            const myFollowingRef = doc(db, 'artifacts', appId, 'users', myUid, 'following', targetUid);
            const targetFollowerRef = doc(db, 'artifacts', appId, 'users', targetUid, 'followers', myUid);
            const notificationColl = collection(db, 'artifacts', appId, 'users', targetUid, 'notifications');

            try {
                if (isFollowing) {
                    await deleteDoc(myFollowingRef);
                    await deleteDoc(targetFollowerRef);
                    isFollowing = false;
                    showNotification('フォローを解除しました');
                } else {
                    const timestamp = serverTimestamp();
                    await setDoc(myFollowingRef, { createdAt: timestamp });
                    await setDoc(targetFollowerRef, { createdAt: timestamp });
                    try {
                        await addDoc(notificationColl, {
                            type: 'follow',
                            fromUid: myUid,
                            createdAt: timestamp,
                            isRead: false
                        });
                    } catch (e) { console.warn("Notify err:", e); }
                    isFollowing = true;
                    showNotification('フォローしました');
                }
                await checkFollowStatus(myUid, targetUid);
                updateFollowCounts(targetUid);
                loadPublicProfile(targetUid);
            } catch (e) {
                console.error(e);
                showNotification('エラーが発生しました');
            }
        };

        function toggleRestrictedContent(show) {
            const masks = ['message-mask', 'career-mask', 'personal-mask'];
            document.querySelectorAll('.mutual-only').forEach(el => {
                if(show) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            if (show) {
                document.getElementById('message-container')?.classList.remove('hidden');
                document.getElementById('message-lock-icon')?.classList.add('hidden');
                document.getElementById('career-container')?.classList.remove('hidden');
                document.getElementById('career-lock-icon')?.classList.add('hidden');
                masks.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            } else {
                document.getElementById('message-container')?.classList.add('hidden');
                document.getElementById('message-lock-icon')?.classList.remove('hidden');
                document.getElementById('career-container')?.classList.add('hidden');
                document.getElementById('career-lock-icon')?.classList.remove('hidden');
                masks.forEach(id => document.getElementById(id)?.classList.remove('hidden'));
            }
        }

        function updateDashboardUI(data) {
            setElText('nav-name', data.name || 'User');
            if (data.userId) setElText('nav-id', '@' + data.userId);
            document.querySelectorAll('.shimmer').forEach(el => el.classList.remove('shimmer', 'w-32', 'h-8'));

            setElText('profile-name', data.name || data.userId || '（名称未設定）');
            setElText('profile-id', '@' + (data.userId || '-'));
            setElText('profile-job', data.jobTitle || '職業未設定');
            setElText('profile-location', data.prefecture || '未設定');
            setElHtml('profile-bio', formatText(data.bio || ''));
            
            const iconImg = document.getElementById('header-icon-img');
            const iconPh = document.getElementById('header-icon-placeholder');
            if (iconImg && iconPh) {
                if (data.photoURL) {
                    iconImg.src = data.photoURL;
                    iconImg.classList.remove('hidden');
                    iconPh.classList.add('hidden');
                } else {
                    iconImg.classList.add('hidden');
                    iconPh.classList.remove('hidden');
                }
            }

            // 5段階のランクバッジ描画
            const rank = data.membershipRank || 'arrival';
            const badgeEl = document.getElementById('rank-badge');
            if (badgeEl) {
                badgeEl.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold border tracking-widest';
                badgeEl.classList.remove('hidden');
                
                // 既存のクラスをリセット
                badgeEl.classList.remove('badge-arrival', 'badge-settler', 'badge-builder', 'badge-guardian', 'badge-covenant');
                
                if (rank === 'covenant') {
                    badgeEl.classList.add('badge-covenant');
                    badgeEl.innerHTML = '<i class="fa-solid fa-shield-halved mr-1"></i>COVENANT';
                } else if (rank === 'guardian') {
                    badgeEl.classList.add('badge-guardian');
                    badgeEl.innerHTML = '<i class="fa-solid fa-gavel mr-1"></i>GUARDIAN';
                } else if (rank === 'builder') {
                    badgeEl.classList.add('badge-builder');
                    badgeEl.innerHTML = '<i class="fa-solid fa-hammer mr-1"></i>BUILDER';
                } else if (rank === 'settler') {
                    badgeEl.classList.add('badge-settler');
                    badgeEl.innerHTML = '<i class="fa-solid fa-house mr-1"></i>SETTLER';
                } else {
                    badgeEl.classList.add('badge-arrival');
                    badgeEl.innerHTML = '<i class="fa-solid fa-anchor mr-1"></i>ARRIVAL';
                }
            }

            // Restriction Logic: ARRIVAL(無料)は情報制限
            const isTargetArrival = rank === 'arrival';
            const isViewerArrival = myRank === 'arrival';
            const isViewerPrivileged = isSelf || isAdmin;
            
            const applyRestriction = (isTargetArrival || isViewerArrival) && !isViewerPrivileged;

            const hideIfRestricted = (id) => {
                const el = document.getElementById(id);
                if (el) {
                    if (applyRestriction) el.classList.add('hidden');
                    else el.classList.remove('hidden');
                }
            };
            if (applyRestriction) document.getElementById('profile-bio').parentElement.classList.add('hidden');
            else document.getElementById('profile-bio').parentElement.classList.remove('hidden');

            hideIfRestricted('section-tags');
            hideIfRestricted('section-matching');
            hideIfRestricted('section-goals');
            hideIfRestricted('section-message'); 

            const showRestricted = (isMutual || isViewerPrivileged) && !applyRestriction;
            toggleRestrictedContent(showRestricted);

            if (applyRestriction) {
                let maskMsg = '';
                if (isViewerArrival) {
                    maskMsg = '<span class="text-brand-700 font-bold cursor-pointer underline hover:text-brand-900 transition-colors" onclick="location.href=\'upgrade.html\'">SETTLER 以上に契約変更</span> して詳細を表示';
                } else {
                    maskMsg = 'このユーザーの役割（ARRIVAL）により、情報は制限されています';
                }
                document.querySelector('#message-mask p').innerHTML = maskMsg;
                document.querySelector('#career-mask p').innerHTML = maskMsg;
                document.querySelector('#personal-mask p').innerHTML = '<i class="fa-solid fa-lock mr-2"></i>' + maskMsg;

                if (!isViewerPrivileged) {
                    document.getElementById('section-message').classList.remove('hidden');
                    document.getElementById('message-mask').classList.remove('hidden');
                    document.getElementById('personal-mask').classList.remove('hidden');
                }
            } else if (!isMutual && !isViewerPrivileged) {
                const normalMsg = '相互フォローで詳細を表示';
                document.querySelector('#message-mask p').textContent = normalMsg;
                document.querySelector('#career-mask p').textContent = normalMsg;
                document.querySelector('#personal-mask p').textContent = normalMsg;
            }

            if (showRestricted) {
                setElText('data-gender', data.gender);
                
                let birthDisplay = '-';
                if (data.birthDate) {
                    if (isAdmin || isSelf || data.birthVisibility === 'full') {
                        birthDisplay = data.birthDate;
                    } else if (data.birthVisibility === 'monthDay') {
                        birthDisplay = data.birthDate.substring(5);
                    } else {
                        birthDisplay = '非公開';
                    }
                }
                setElText('data-birth', birthDisplay);

                const careerContainer = document.getElementById('career-container');
                if (careerContainer) {
                    careerContainer.innerHTML = '';
                    if (data.career && data.career.length > 0) {
                        data.career.forEach(c => {
                            const formattedDesc = formatText(c.description || '');
                            careerContainer.innerHTML += `
                                <div class="relative pl-6 pb-2">
                                    <div class="absolute left-[-5px] top-1.5 h-3 w-3 rounded-full bg-brand-500 ring-4 ring-[#fffdf9] z-10 shadow-sm border border-brand-300"></div>
                                    <h4 class="font-bold text-brand-900 text-base font-serif tracking-widest">${c.company || '会社名不明'}</h4>
                                    <div class="flex items-center gap-2 mb-3 mt-1">
                                        <span class="text-[10px] font-bold text-brand-700 bg-brand-100 px-2 py-0.5 rounded-sm tracking-widest border border-brand-200">${c.role || '役割'}</span>
                                        <span class="text-xs text-brand-400 font-medium tracking-widest">${c.start || '?'} 〜 ${c.end || '現在'}</span>
                                    </div>
                                    <div class="text-sm text-brand-700 leading-relaxed font-medium bg-brand-50 p-4 rounded-sm border border-brand-100">${formattedDesc}</div>
                                </div>
                            `;
                        });
                    } else {
                        careerContainer.innerHTML = '<div class="text-brand-300 text-sm italic pl-6">経歴情報はありません</div>';
                    }
                }
                
                const snsContainer = document.getElementById('profile-sns-links');
                if (snsContainer) {
                    snsContainer.innerHTML = '';
                    if (data.websiteUrl) snsContainer.innerHTML += `<a href="${data.websiteUrl}" target="_blank" class="w-8 h-8 rounded-full border border-brand-200 bg-brand-50 flex items-center justify-center text-brand-500 hover:bg-brand-100 hover:text-brand-800 transition-colors"><i class="fa-solid fa-globe"></i></a>`;
                    if (data.snsInstagram) snsContainer.innerHTML += `<a href="${data.snsInstagram.startsWith('http') ? data.snsInstagram : 'https://instagram.com/'+data.snsInstagram}" target="_blank" class="w-8 h-8 rounded-full border border-brand-200 bg-brand-50 flex items-center justify-center text-brand-500 hover:bg-brand-100 hover:text-brand-800 transition-colors"><i class="fa-brands fa-instagram"></i></a>`;
                    if (data.snsX) snsContainer.innerHTML += `<a href="${data.snsX.startsWith('http') ? data.snsX : 'https://twitter.com/'+data.snsX}" target="_blank" class="w-8 h-8 rounded-full border border-brand-200 bg-brand-50 flex items-center justify-center text-brand-500 hover:bg-brand-100 hover:text-brand-800 transition-colors"><i class="fa-brands fa-x-twitter"></i></a>`;
                }

                const messageEl = document.getElementById('profile-message');
                if (messageEl) {
                    messageEl.innerHTML = data.message ? formatText(data.message) : 'まだメッセージがありません。';
                    if (!data.message) messageEl.classList.add('text-brand-300');
                    else messageEl.classList.remove('text-brand-300');
                }
            }

            if (isSelf) {
                setElText('score-text', (data.profileScore || 0) + '%');
                const scoreBar = document.getElementById('score-bar');
                if(scoreBar) scoreBar.style.width = (data.profileScore || 0) + '%';
            }
        }

        // --- Debug: Change Rank Function ---
        window.changeRank = async (newRole) => {
            if (!currentUser) return;
            const uid = targetUid; 
            try {
                const privateRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                await updateDoc(privateRef, { membershipRank: newRole });
                
                const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
                const pubSnap = await getDoc(publicRef);
                if (pubSnap.exists()) {
                    await updateDoc(publicRef, { membershipRank: newRole });
                }
                
                alert(`役割を ${newRole} に変更しました。\n画面をリロードします。`);
                window.location.reload();
            } catch (e) {
                console.error(e);
                alert("変更に失敗しました");
            }
        };

        window.handleLogout = () => {
            if (isAdminMock) {
                localStorage.removeItem('isAdminMock');
                window.location.href = 'login.html';
                return;
            }
            signOut(auth);
            window.location.href = 'login.html';
        };

        window.showNotification = (msg) => {
            const notif = document.getElementById('notification');
            const msgEl = document.getElementById('notif-message');
            if(notif && msgEl) {
                notif.classList.remove('hidden', 'translate-y-20');
                msgEl.textContent = msg;
                setTimeout(() => {
                    notif.classList.add('translate-y-20');
                    setTimeout(() => notif.classList.add('hidden'), 300);
                }, 3000);
            }
        };

        function getAdminMockData() {
            return {
                userId: 'admin', name: 'NOAH 運営', jobTitle: '航海士', gender: '男性',
                profileScore: 90, hobbies: ['開発', 'デザイン'], skills: ['Firebase', 'HTML/CSS'], email: 'admin@test.com',
                prefecture: '愛知県', message: 'ここでは誰も一人にならない。', bio: 'NOAHの航海を見守る管理者アカウントです。', goals: '誰も取り残さないシステムを作ること。',
                canOffer: ['環境の提供', 'マッチングサポート'], lookingFor: ['共鳴できる仲間'], career: [], membershipRank: 'covenant'
            };
        }
    </script>
</body>
</html>
