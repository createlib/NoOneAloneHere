<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ | NOAH</title>
    <link rel="icon" href="img/icon.png">
    
    <!-- Google Fonts: Noto Serif JP -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { serif: ['Noto Serif JP', 'serif'] },
                    colors: { 
                        brand: { 
                            50: '#f7f5f0',   // bg
                            100: '#e8dfd1',  // border light
                            200: '#dcd4c6',  // border medium
                            300: '#c8b9a6',  // border dark
                            400: '#a09080',  // text muted
                            500: '#8b6a4f',  // accent
                            600: '#725b3f',  // accent hover
                            700: '#5c4a3d',  // text body
                            800: '#4a3b32',  // text heading
                            900: '#3e2723'   // text dark
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Noto Serif JP', serif;
            background-color: #f7f5f0; 
            color: #4a3b32;
        }
        
        .bg-texture {
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
        }

        .glass-header {
            background: rgba(255, 253, 249, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* ã‚¹ãƒãƒ›ã§ã®3åˆ—è¡¨ç¤ºèª¿æ•´ */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .card-grid { grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        }
        @media (min-width: 1024px) {
            .card-grid { grid-template-columns: repeat(5, 1fr); gap: 1.5rem; }
        }
        
        /* Bottom Nav Safe Area */
        .pb-safe-bottom { padding-bottom: calc(4.5rem + env(safe-area-inset-bottom)); }
        
        .bottom-nav-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #fffdf9;
            border-top: 1px solid #e8dfd1;
            z-index: 50;
            height: 4rem;
            height: calc(4rem + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Custom Checkbox */
        .filter-checkbox:checked + div {
            background-color: #8b6a4f;
            border-color: #8b6a4f;
            color: #fffdf9;
        }
        
        /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«ä¸Šæ›¸ã */
        input:focus, select:focus {
            outline: none;
            border-color: #8b6a4f !important;
            box-shadow: 0 0 0 1px #8b6a4f !important;
        }
        
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .accordion-arrow { transition: transform 0.2s ease; }
        details[open] .accordion-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col pb-safe-bottom lg:pb-0 bg-texture">

    <!-- Navbar -->
    <nav class="glass-header border-b border-brand-200 fixed w-full z-50 top-0 h-16 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex justify-between items-center relative z-10">
            <div class="flex items-center gap-4">
                <a href="search.html" class="text-xl font-black text-brand-900 tracking-widest flex items-center gap-2 font-serif">
                    <span class="bg-brand-900 text-brand-50 w-8 h-8 flex items-center justify-center rounded-sm text-sm"><i class="fa-solid fa-anchor"></i></span>
                    <span class="hidden sm:inline">NOAH</span>
                </a>
            </div>
            
            <!-- Search Bar (Desktop Only) -->
            <div class="hidden lg:block flex-1 max-w-md mx-8 relative z-10">
                <div class="relative">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-brand-400"></i>
                    <input type="text" id="desktop-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ (åå‰, ID, è·æ¥­...)" 
                        class="w-full bg-[#fffdf9] border border-brand-200 rounded-sm py-2 pl-10 pr-4 text-sm focus:ring-1 focus:ring-brand-500 transition-all font-serif tracking-widest">
                </div>
            </div>

            <!-- Header Actions -->
            <div class="flex items-center gap-3">
                <!-- PC Navigation Links -->
                <div class="hidden lg:flex items-center gap-6 mr-4">
                    <a href="home.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-ship"></i> èˆªæµ·(ãƒ›ãƒ¼ãƒ )</a>
                    <a href="events.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-hourglass-half"></i> ã‚¤ãƒ™ãƒ³ãƒˆ</a>
                    <a href="search.html" class="text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-compass"></i> ã•ãŒã™</a>
                    <a href="user.html" class="text-brand-400 hover:text-brand-600 transition-colors flex items-center gap-2 font-bold text-sm tracking-wide"><i class="fa-solid fa-user"></i> ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
                </div>

                <!-- Filter Button (Desktop Only) -->
                <button onclick="toggleFilters()" class="hidden lg:flex p-2 text-brand-600 hover:bg-brand-50 rounded-sm transition-colors relative border border-transparent hover:border-brand-200" title="çµã‚Šè¾¼ã¿">
                    <i class="fa-solid fa-sliders"></i>
                    <span id="filter-badge-desktop" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-brand-500 rounded-full border border-[#fffdf9]"></span>
                </button>
                
                <!-- Notification Bell -->
                <a href="notifications.html" class="p-2 text-brand-300 hover:text-brand-600 transition-colors relative" title="é€šçŸ¥">
                    <i class="fa-regular fa-bell text-xl"></i>
                    <span class="hidden absolute top-1.5 right-1.5 h-2.5 w-2.5 bg-[#8b6a4f] rounded-full border-2 border-[#fffdf9]"></span>
                </a>

                <!-- Logout (Desktop) -->
                <div class="h-6 w-px bg-brand-200 mx-1 hidden lg:block"></div>
                <button onclick="handleLogout()" class="hidden lg:flex text-sm font-bold text-brand-400 hover:text-red-800 transition-colors flex items-center gap-2">
                    <span class="hidden sm:inline tracking-widest">ä¸‹èˆ¹ã™ã‚‹</span>
                    <i class="fa-solid fa-right-from-bracket text-lg"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Search Bar & Filter (Mobile Only) -->
    <div class="lg:hidden fixed top-16 w-full bg-[#fffdf9]/95 backdrop-blur-sm z-40 px-4 py-3 border-b border-brand-200 shadow-sm bg-texture">
        <div class="flex gap-3">
            <div class="relative flex-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-brand-400"></i>
                <input type="text" id="mobile-search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" 
                    class="w-full bg-[#fffdf9] border border-brand-200 rounded-sm py-2 pl-10 pr-4 text-sm focus:ring-1 focus:ring-brand-500 transition-all font-serif tracking-widest">
            </div>
            <!-- Mobile Filter Button -->
            <button onclick="toggleFilters()" class="flex-shrink-0 w-10 h-10 bg-brand-50 rounded-sm flex items-center justify-center text-brand-700 hover:bg-brand-100 transition-colors relative border border-brand-200 shadow-sm">
                <i class="fa-solid fa-sliders"></i>
                <span id="filter-badge-mobile" class="hidden absolute -top-1 -right-1 w-2.5 h-2.5 bg-brand-500 rounded-full border border-[#fffdf9]"></span>
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="filter-panel" class="fixed top-0 left-0 w-full h-full bg-[#2a1a17]/50 z-[60] hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm">
        <div class="absolute right-0 top-0 h-full w-80 sm:w-96 bg-[#fffdf9] bg-texture shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col border-l border-brand-200" id="filter-content">
            <div class="p-4 border-b border-brand-200 flex justify-between items-center bg-[#fffdf9] z-10 relative">
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-brand-200 to-transparent opacity-50"></div>
                <h3 class="font-bold text-lg flex items-center gap-2 text-brand-900 font-serif tracking-widest">
                    <i class="fa-solid fa-filter text-brand-500 text-sm"></i> çµã‚Šè¾¼ã¿
                </h3>
                <button onclick="toggleFilters()" class="p-2 text-brand-400 hover:text-brand-700 rounded-sm hover:bg-brand-50 transition-colors">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 space-y-6">
                <!-- Sort -->
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-2"><i class="fa-solid fa-arrow-down-a-z mr-1"></i>ä¸¦ã³é †</label>
                    <select id="filter-sort" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        <option value="random">ãŠã™ã™ã‚é †ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰</option>
                        <option value="newest">æ–°ç€é †</option>
                    </select>
                </div>
                <hr class="border-brand-200 border-dashed">
                
                <!-- Basic Profile -->
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-3"><i class="fa-solid fa-id-card mr-1"></i>åŸºæœ¬æƒ…å ±</label>
                    <div class="space-y-4">
                        <div>
                            <span class="block text-xs font-bold text-brand-800 tracking-widest mb-1.5">ã‚¨ãƒªã‚¢ (éƒ½é“åºœçœŒ)</span>
                            <select id="filter-prefecture" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                                <option value="">æŒ‡å®šãªã—</option>
                            </select>
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-brand-800 tracking-widest mb-1.5">æ€§åˆ¥</span>
                            <select id="filter-gender" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                                <option value="">æŒ‡å®šãªã—</option>
                                <option value="ç”·æ€§">ç”·æ€§</option>
                                <option value="å¥³æ€§">å¥³æ€§</option>
                                <option value="ãã®ä»–">ãã®ä»–</option>
                            </select>
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-brand-800 tracking-widest mb-1.5">è·æ¥­ãƒ»è‚©æ›¸</span>
                            <input type="text" id="filter-job" placeholder="ä¾‹: ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        </div>
                    </div>
                </div>
                <hr class="border-brand-200 border-dashed">
                
                <!-- Matching -->
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-3"><i class="fa-solid fa-handshake mr-1"></i>ãƒãƒƒãƒãƒ³ã‚°</label>
                    <div class="space-y-4">
                        <div>
                            <span class="block text-xs font-bold text-brand-800 tracking-widest mb-1.5 flex items-center gap-1">æä¾›ã§ãã‚‹ã“ã¨</span>
                            <input type="text" id="filter-can-offer" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: ãƒ‡ã‚¶ã‚¤ãƒ³)" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        </div>
                        <div>
                            <span class="block text-xs font-bold text-brand-800 tracking-widest mb-1.5 flex items-center gap-1">æ±‚ã‚ã¦ã„ã‚‹ã“ã¨</span>
                            <input type="text" id="filter-looking-for" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ (ä¾‹: ç›¸è«‡)" class="w-full border-brand-200 rounded-sm text-sm p-2.5 bg-[#fffdf9] focus:border-brand-500 font-serif tracking-widest">
                        </div>
                    </div>
                </div>
                <hr class="border-brand-200 border-dashed">
                
                <!-- Skills & Hobbies (Accordion) -->
                <div>
                    <label class="block text-[11px] font-bold text-brand-500 tracking-widest mb-3"><i class="fa-solid fa-tags mr-1"></i>è©³ç´°ã‚¿ã‚°æ¤œç´¢</label>
                    <div class="space-y-3">
                        <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                            <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                                <span class="font-bold text-sm text-brand-800 tracking-widest">ã‚¹ã‚­ãƒ«</span>
                                <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                            </summary>
                            <div class="p-3 border-t border-brand-200 bg-brand-50 max-h-60 overflow-y-auto" id="filter-skills-container"></div>
                        </details>
                        <details class="group bg-[#fffdf9] border border-brand-200 rounded-sm overflow-hidden shadow-sm">
                            <summary class="flex justify-between items-center p-3 cursor-pointer hover:bg-brand-50 transition-colors select-none">
                                <span class="font-bold text-sm text-brand-800 tracking-widest">è¶£å‘³</span>
                                <span class="accordion-arrow text-brand-400"><i class="fa-solid fa-chevron-down text-xs"></i></span>
                            </summary>
                            <div class="p-3 border-t border-brand-200 bg-brand-50 max-h-60 overflow-y-auto" id="filter-hobbies-container"></div>
                        </details>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t border-brand-200 bg-[#f7f5f0] pb-safe-bottom relative z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <button onclick="applyFilters()" class="w-full bg-[#3e2723] text-[#f7f5f0] font-bold py-3.5 rounded-sm hover:bg-[#2a1a17] transition-colors shadow-md tracking-widest border border-[#3e2723]">
                    æ¤œç´¢çµæœã‚’è¡¨ç¤º
                </button>
                <button onclick="resetFilters()" class="w-full mt-3 text-sm text-brand-500 hover:text-brand-800 py-2 font-bold tracking-widest transition-colors">
                    æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 max-w-7xl mx-auto w-full pt-32 lg:pt-24 px-3 pb-20 relative z-0">
        
        <div id="loading-indicator" class="flex flex-col items-center justify-center py-20">
            <i class="fa-solid fa-compass fa-spin text-4xl text-brand-400 mb-4 opacity-70"></i>
            <p class="text-brand-500 text-sm tracking-widest font-serif">ä¹—èˆ¹è€…ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>
        </div>

        <div id="users-grid" class="card-grid hidden"></div>

        <div id="no-results" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-brand-50 border border-brand-200 mb-4 text-brand-300 shadow-inner">
                <i class="fa-solid fa-anchor-circle-xmark text-3xl"></i>
            </div>
            <h3 class="text-lg font-bold text-brand-900 mb-2 font-serif tracking-widest">è©²å½“ã™ã‚‹ä¹—èˆ¹è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h3>
            <p class="text-brand-500 text-sm tracking-widest">æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„</p>
            <button onclick="resetFilters()" class="mt-8 text-[#8b6a4f] font-bold text-sm hover:text-[#5c4a3d] transition-colors border-b border-[#8b6a4f] pb-0.5 tracking-widest">
                ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¡¨ç¤º
            </button>
        </div>

    </main>

    <!-- Bottom Navigation (Mobile Only) -->
    <nav class="lg:hidden bottom-nav-fixed shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <div class="bottom-nav-content">
            <a href="home.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-ship text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">èˆªæµ·</span>
            </a>
            <a href="events.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-hourglass-half text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">ã‚¤ãƒ™ãƒ³ãƒˆ</span>
            </a>
            <!-- Active Search -->
            <a href="search.html" class="flex flex-col items-center justify-center w-full h-full text-brand-600">
                <i class="fa-solid fa-compass text-xl mb-1"></i>
                <span class="text-[10px] font-bold tracking-widest">ã•ãŒã™</span>
            </a>
            <button onclick="alert('ãƒãƒƒãƒãƒ³ã‚°æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\nComing Soon!')" class="flex flex-col items-center justify-center w-full h-full text-brand-300 hover:text-brand-500 transition-colors">
                <i class="fa-solid fa-handshake text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">ãƒãƒƒãƒ</span>
            </button>
            <a href="user.html" class="flex flex-col items-center justify-center w-full h-full text-brand-400 hover:text-brand-600 transition-colors">
                <i class="fa-solid fa-user text-xl mb-1"></i>
                <span class="text-[10px] font-medium tracking-widest">ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
            </a>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // â–¼â–¼â–¼â–¼ Firebase Config â–¼â–¼â–¼â–¼
        const firebaseConfig = {
            apiKey: "AIzaSyBVDZJhL9sMzVknD5tNomLWF-0z0jPU3i0",
            authDomain: "brainbridge-4b8ac.firebaseapp.com",
            projectId: "brainbridge-4b8ac",
            storageBucket: "brainbridge-4b8ac.firebasestorage.app",
            messagingSenderId: "803209683213",
            appId: "1:803209683213:web:b62d13784fa2bbbb9f5044"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'default-app-id';

        let allUsers = []; 
        let filteredUsers = [];
        let isAdmin = false;

        const hobbyCategories = {
            "ğŸƒ ã‚¹ãƒãƒ¼ãƒ„ãƒ»é‹å‹•ç³»": ["ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°", "ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°", "ç­‹ãƒˆãƒ¬", "ãƒ¨ã‚¬", "ãƒ”ãƒ©ãƒ†ã‚£ã‚¹", "ãƒ€ãƒ³ã‚¹", "ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ•ãƒƒãƒˆã‚µãƒ«", "é‡çƒ", "ãƒ†ãƒ‹ã‚¹", "ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³", "å“çƒ", "ã‚´ãƒ«ãƒ•", "ãƒœãƒ«ãƒ€ãƒªãƒ³ã‚°", "ç™»å±±", "ã‚µãƒ¼ãƒ•ã‚£ãƒ³", "ã‚¹ãƒãƒ¼ãƒœãƒ¼ãƒ‰", "ã‚¹ã‚­ãƒ¼", "ã‚µã‚¤ã‚¯ãƒªãƒ³ã‚°", "æ°´æ³³", "æ ¼é—˜æŠ€", "æ­¦é“"],
            "ğŸµ éŸ³æ¥½ãƒ»ã‚¨ãƒ³ã‚¿ãƒ¡": ["ã‚«ãƒ©ã‚ªã‚±", "æ¥½å™¨æ¼”å¥ï¼ˆã‚®ã‚¿ãƒ¼ï¼‰", "æ¥½å™¨æ¼”å¥ï¼ˆãƒ”ã‚¢ãƒï¼‰", "ä½œæ›²", "æ­Œ", "ãƒ©ã‚¤ãƒ–é‘‘è³", "ãƒ•ã‚§ã‚¹", "DJ", "æ˜ ç”»é‘‘è³", "ã‚¢ãƒ‹ãƒ¡é‘‘è³", "æ¼«ç”»", "ã‚²ãƒ¼ãƒ ", "ãƒœãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ "],
            "ğŸ¨ æ–‡åŒ–ãƒ»ã‚¢ãƒ¼ãƒˆ": ["çµµç”»", "ã‚¤ãƒ©ã‚¹ãƒˆ", "ãƒ‡ã‚¶ã‚¤ãƒ³", "å†™çœŸæ’®å½±", "å‹•ç”»ç·¨é›†", "æ‰‹èŠ¸", "DIY", "å°èª¬åŸ·ç­†", "ãƒ–ãƒ­ã‚°"],
            "ğŸ“š å­¦ã³": ["èª­æ›¸", "è‡ªå·±å•“ç™º", "æ­´å²", "å¿ƒç†å­¦", "æŠ•è³‡", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "è‹±èªå­¦ç¿’", "è³‡æ ¼å–å¾—"],
            "ğŸ³ é£Ÿãƒ»æš®ã‚‰ã—": ["æ–™ç†", "ãŠè“å­ä½œã‚Š", "ã‚«ãƒ•ã‚§å·¡ã‚Š", "é£Ÿã¹æ­©ã", "ãŠé…’", "ã‚³ãƒ¼ãƒ’ãƒ¼", "ã‚¤ãƒ³ãƒ†ãƒªã‚¢", "ãƒŸãƒ‹ãƒãƒªã‚ºãƒ "],
            "âœˆï¸ æ—…è¡Œ": ["å›½å†…æ—…è¡Œ", "æµ·å¤–æ—…è¡Œ", "ä¸€äººæ—…", "ã‚­ãƒ£ãƒ³ãƒ—", "æ¸©æ³‰å·¡ã‚Š", "ç¥ç¤¾ä»é–£å·¡ã‚Š"],
            "ğŸ¤ äºº": ["äº¤æµä¼š", "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢", "åœ°åŸŸæ´»å‹•", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å­è‚²ã¦"],
            "ğŸŒ¿ ãã®ä»–": ["ç‘æƒ³", "å ã„", "ãã®ä»–"]
        };
        const skillCategories = {
            "ğŸ’» IT": ["Webåˆ¶ä½œ", "WordPress", "Firebase", "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰", "ã‚¢ãƒ—ãƒªé–‹ç™º", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "ãƒ‡ãƒ¼ã‚¿åˆ†æ", "AIæ´»ç”¨"],
            "ğŸ¤ ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³": ["ãƒ—ãƒ¬ã‚¼ãƒ³", "ãƒ•ã‚¡ã‚·ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³", "è¬›å¸«", "ã‚³ãƒ¼ãƒãƒ³ã‚°", "å–¶æ¥­", "äº¤æ¸‰", "ã‚¤ãƒ³ã‚¿ãƒ“ãƒ¥ãƒ¼"],
            "âœï¸ ç™ºä¿¡": ["ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°", "SNSé‹ç”¨", "ãƒ–ãƒ­ã‚°é‹å–¶", "å‹•ç”»ç·¨é›†", "ãƒ‡ã‚¶ã‚¤ãƒ³"],
            "ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹": ["èµ·æ¥­", "çµŒå–¶", "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", "ä¼šè¨ˆ", "äººäº‹", "è‹±èª"],
            "ğŸ§˜ ãã®ä»–": ["æ–™ç†æŒ‡å°", "æ•´ç†åç´", "å¥åº·ç®¡ç†"]
        };
        const prefectures = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–","ãã®ä»–"];

        document.addEventListener('DOMContentLoaded', () => {
            initFilterOptions();
            const dInput = document.getElementById('desktop-search');
            const mInput = document.getElementById('mobile-search');
            if (dInput) dInput.addEventListener('input', (e) => filterUsers(e.target.value));
            if (mInput) mInput.addEventListener('input', (e) => filterUsers(e.target.value));
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
                if (localStorage.getItem('isAdminMock') === 'true') { isAdmin = true; }
                else {
                    try {
                        const mySnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                        if (mySnap.exists()) {
                            if (mySnap.data().userId === 'admin') isAdmin = true;
                            // ARRIVAL(æ—§WALKER)ãƒã‚§ãƒƒã‚¯ (ç®¡ç†è€…ã¯å…é™¤)
                            if (mySnap.data().membershipRank === 'arrival' && !isAdmin) {
                                alert("æ¤œç´¢æ©Ÿèƒ½ã¯SETTLERä»¥ä¸Šã®ä¼šå“¡é™å®šã§ã™ã€‚");
                                window.location.href = "upgrade.html";
                                return;
                            }
                        }
                    } catch(e){}
                }
                fetchUsers();
            } else {
                window.location.href = 'login.html';
            }
        });

        function initFilterOptions() {
            const select = document.getElementById('filter-prefecture');
            prefectures.forEach(pref => {
                const option = document.createElement('option');
                option.value = pref;
                option.textContent = pref;
                select.appendChild(option);
            });
            const skillsContainer = document.getElementById('filter-skills-container');
            createCategoryCheckboxes(skillCategories, skillsContainer, 'filter-skill');
            const hobbiesContainer = document.getElementById('filter-hobbies-container');
            createCategoryCheckboxes(hobbyCategories, hobbiesContainer, 'filter-hobby');
        }

        function createCategoryCheckboxes(data, container, name) {
            for (const [category, items] of Object.entries(data)) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'mb-4';
                groupDiv.innerHTML = `<h5 class="text-xs font-bold text-brand-700 mb-2 tracking-widest">${category}</h5>`;
                const flexDiv = document.createElement('div');
                flexDiv.className = 'flex flex-wrap gap-1.5';
                items.forEach(item => {
                    const label = document.createElement('label');
                    label.className = 'cursor-pointer';
                    label.innerHTML = `
                        <input type="checkbox" name="${name}" value="${item}" class="filter-checkbox hidden">
                        <div class="px-2 py-1 rounded-sm border border-brand-200 text-xs text-brand-700 hover:bg-[#fffdf9] transition-colors select-none tracking-widest shadow-sm bg-white">${item}</div>
                    `;
                    flexDiv.appendChild(label);
                });
                groupDiv.appendChild(flexDiv);
                container.appendChild(groupDiv);
            }
        }

        async function fetchUsers() {
            try {
                // å…¬é–‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å–å¾—
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'users');
                const q = query(usersRef); 
                const snapshot = await getDocs(q);

                allUsers = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.authUid = doc.id; 
                    
                    // è¡¨ç¤ºåˆ¤å®š: isHidden=true ã‹ profilePublic=false ãªã‚‰éš ã™
                    // ãŸã ã—ç®¡ç†è€…ã¯å…¨ã¦è¦‹ã‚‹
                    const isHidden = data.isHidden === true;
                    const isPrivate = data.profilePublic === 'false';
                    
                    if (isAdmin || (!isHidden && !isPrivate)) {
                        if (data.userId) { 
                            data._isMasked = (isHidden || isPrivate); 
                            if (!data.name) data.name = "åç§°æœªè¨­å®š";
                            allUsers.push(data);
                        }
                    }
                });

                shuffleArray(allUsers);
                filteredUsers = [...allUsers];
                
                document.getElementById('loading-indicator').classList.add('hidden');
                renderGrid(filteredUsers);

            } catch (error) {
                console.error(error);
                document.getElementById('loading-indicator').innerHTML = '<div class="text-red-800 font-bold tracking-widest text-sm">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
            }
        }

        window.filterUsers = (keyword) => {
            const term = (typeof keyword === 'string' ? keyword : document.getElementById('desktop-search').value).toLowerCase();
            
            const dInput = document.getElementById('desktop-search');
            const mInput = document.getElementById('mobile-search');
            if (dInput && dInput.value !== term) dInput.value = term;
            if (mInput && mInput.value !== term) mInput.value = term;

            const pref = document.getElementById('filter-prefecture').value;
            const gender = document.getElementById('filter-gender').value;
            const job = document.getElementById('filter-job').value.toLowerCase();
            const canOffer = document.getElementById('filter-can-offer').value.toLowerCase();
            const lookingFor = document.getElementById('filter-looking-for').value.toLowerCase();
            
            const selectedSkills = Array.from(document.querySelectorAll('input[name="filter-skill"]:checked')).map(cb => cb.value);
            const selectedHobbies = Array.from(document.querySelectorAll('input[name="filter-hobby"]:checked')).map(cb => cb.value);

            const hasFilter = pref || gender || job || canOffer || lookingFor || selectedSkills.length > 0 || selectedHobbies.length > 0;
            const badgeD = document.getElementById('filter-badge-desktop');
            const badgeM = document.getElementById('filter-badge-mobile');
            if (hasFilter) {
                badgeD?.classList.remove('hidden');
                badgeM?.classList.remove('hidden');
            } else {
                badgeD?.classList.add('hidden');
                badgeM?.classList.add('hidden');
            }

            filteredUsers = allUsers.filter(user => {
                const searchTarget = `${user.name} ${user.userId} ${user.jobTitle || ''} ${user.bio || ''} ${user.hobbies?.join(' ') || ''}`.toLowerCase();
                const matchKeyword = !term || searchTarget.includes(term);

                const matchPref = !pref || (user.prefecture === pref);
                const matchGender = !gender || (user.gender === gender);
                const matchJob = !job || (user.jobTitle && user.jobTitle.toLowerCase().includes(job));
                const matchOffer = !canOffer || (user.canOffer && user.canOffer.some(item => item.toLowerCase().includes(canOffer)));
                const matchLooking = !lookingFor || (user.lookingFor && user.lookingFor.some(item => item.toLowerCase().includes(lookingFor)));
                
                const matchSkills = selectedSkills.length === 0 || (user.skills && selectedSkills.some(tag => user.skills.includes(tag)));
                const matchHobbies = selectedHobbies.length === 0 || (user.hobbies && selectedHobbies.some(tag => user.hobbies.includes(tag)));

                return matchKeyword && matchPref && matchGender && matchJob && matchOffer && matchLooking && matchSkills && matchHobbies;
            });

            const sortType = document.getElementById('filter-sort').value;
            if (sortType === 'newest') {
                filteredUsers.sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
            }

            renderGrid(filteredUsers);
        };

        window.toggleFilters = () => {
            const panel = document.getElementById('filter-panel');
            const content = document.getElementById('filter-content');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => { panel.classList.remove('opacity-0'); content.classList.remove('translate-x-full'); }, 10);
            } else {
                panel.classList.add('opacity-0');
                content.classList.add('translate-x-full');
                setTimeout(() => panel.classList.add('hidden'), 300);
            }
        };

        window.applyFilters = () => {
            filterUsers(); 
            toggleFilters();
        };

        window.resetFilters = () => {
            document.getElementById('filter-prefecture').value = "";
            document.getElementById('filter-gender').value = "";
            document.getElementById('filter-job').value = "";
            document.getElementById('filter-can-offer').value = "";
            document.getElementById('filter-looking-for').value = "";
            document.getElementById('filter-sort').value = "random";
            document.getElementById('desktop-search').value = "";
            document.getElementById('mobile-search').value = "";
            document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = false);
            shuffleArray(allUsers);
            filterUsers("");
            toggleFilters();
        };

        function renderGrid(users) {
            const grid = document.getElementById('users-grid');
            const noResults = document.getElementById('no-results');
            if (!grid) return;
            grid.innerHTML = '';

            if (users.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                return;
            }
            noResults.classList.add('hidden');
            grid.classList.remove('hidden');

            users.forEach(user => {
                const card = document.createElement('a');
                card.href = `user.html?uid=${user.authUid}`;
                
                // ç®¡ç†è€…å‘ã‘: éå…¬é–‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è–„ãè¡¨ç¤º
                const opacityClass = user._isMasked ? 'opacity-50 grayscale' : '';
                
                card.className = `block bg-[#fffdf9] rounded-sm shadow-sm border border-brand-200 overflow-hidden hover:shadow-md hover:border-brand-300 transition-all flex flex-col h-full ${opacityClass}`;
                
                let iconHtml = user.photoURL 
                    ? `<img src="${user.photoURL}" class="w-full h-full object-cover">`
                    : `<div class="w-full h-full bg-brand-50 border-b border-brand-100 flex items-center justify-center text-brand-300"><i class="fa-solid fa-anchor text-3xl"></i></div>`;

                const maskBadge = user._isMasked ? `<span class="absolute top-1 left-1 bg-[#3e2723] text-[#d4af37] border border-[#b8860b] text-[9px] px-1 rounded-sm tracking-widest font-bold shadow-sm">éå…¬é–‹</span>` : '';

                card.innerHTML = `
                    <div class="aspect-square w-full relative overflow-hidden bg-[#f7f5f0]">
                        ${iconHtml}
                        ${maskBadge}
                        ${user.prefecture ? `<span class="absolute bottom-1 right-1 bg-[#2a1a17]/70 text-[#f7f5f0] text-[10px] px-1.5 py-0.5 rounded-sm tracking-widest">${user.prefecture}</span>` : ''}
                    </div>
                    <div class="p-3 flex-1 relative">
                        <h3 class="font-bold text-sm text-brand-900 truncate font-serif tracking-widest">${user.name || 'No Name'}</h3>
                        <p class="text-xs text-brand-500 truncate tracking-wide mt-0.5">@${user.userId}</p>
                        ${user.jobTitle ? `<p class="text-[10px] text-brand-700 mt-1.5 truncate border-t border-brand-100 pt-1.5 tracking-widest">${user.jobTitle}</p>` : ''}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        window.handleLogout = () => {
            if (isAdminMock) localStorage.removeItem('isAdminMock');
            signOut(auth);
            window.location.href = 'login.html';
        };
    </script>
</body>
</html>
